<!doctype html><html lang=en dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="异常 # 异常对象 # RuntimeException 和 CheckedException 继承于 Exception，Exception 和 Error 继承于 Throwable。Error 和 RuntimeException 均属于 Unchecked Exception。
Checked Exception 和 Unchecked Exception 在意义上是存在区别的。例如，有关 IO 和类加载的异常大多是 Checked Exception，因为编写代码时无法判断该异常会不会发生。唯一的办法是捕获并处理它。相比之下，类似 NumberFormatException 这一类异常的发生是可以在代码中进行避免的。因此，属于 Unchecked Exception，需要在代码中进行预防而非捕获。
如果调用可能抛出 Checked Exception，就需要在方法头声明，以便找到最终最适合处理的位置。对于 lambda 表达式也同理。如果 lambda 表达式可能抛出 Checked Exception，就无法被传给一个不抛出异常的函数式接口。好在，大多数情况下，抛出的异常都适合在 lambda 表达式里捕获处理。
在编写自定义的异常类时，建议至少提供两个构造方法：一个无参的方法和一个接受消息字符串的方法。
异常捕获 # 多种异常 # 对于需要处理多种异常的情况，可以分别或一起捕获：
try { ... } catch (ExceptionClass | ExceptionClazz ex) { ex.fun()... } catch (ExClass ex) { ... } try-with-resources # 对于临时需要的资源，使用 try-with-resources 语句，资源需要实现 AutoClosable 接口："><meta name=theme-color content="#FFFFFF"><meta name=color-scheme content="light dark"><meta property="og:url" content="/notes/core-java-impatient/4/"><meta property="og:site_name" content="czdm75 Blog"><meta property="og:title" content="4. Exception, Logging"><meta property="og:description" content="异常 # 异常对象 # RuntimeException 和 CheckedException 继承于 Exception，Exception 和 Error 继承于 Throwable。Error 和 RuntimeException 均属于 Unchecked Exception。
Checked Exception 和 Unchecked Exception 在意义上是存在区别的。例如，有关 IO 和类加载的异常大多是 Checked Exception，因为编写代码时无法判断该异常会不会发生。唯一的办法是捕获并处理它。相比之下，类似 NumberFormatException 这一类异常的发生是可以在代码中进行避免的。因此，属于 Unchecked Exception，需要在代码中进行预防而非捕获。
如果调用可能抛出 Checked Exception，就需要在方法头声明，以便找到最终最适合处理的位置。对于 lambda 表达式也同理。如果 lambda 表达式可能抛出 Checked Exception，就无法被传给一个不抛出异常的函数式接口。好在，大多数情况下，抛出的异常都适合在 lambda 表达式里捕获处理。
在编写自定义的异常类时，建议至少提供两个构造方法：一个无参的方法和一个接受消息字符串的方法。
异常捕获 # 多种异常 # 对于需要处理多种异常的情况，可以分别或一起捕获：
try { ... } catch (ExceptionClass | ExceptionClazz ex) { ex.fun()... } catch (ExClass ex) { ... } try-with-resources # 对于临时需要的资源，使用 try-with-resources 语句，资源需要实现 AutoClosable 接口："><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="notes"><title>4. Exception, Logging | czdm75 Blog</title>
<link rel=manifest href=/manifest.json><link rel=icon href=/favicon.png type=image/x-icon><link rel=stylesheet href=/book.min.97cfda4f5e3c9fa49a2bf8d401f4ddc0eec576c99cdcf6afbec19173200c37db.css><script defer src=/flexsearch.min.js></script><script defer src=/en.search.min.f7e98004e6b8d1bafd93b9d4b053644c96b18c50c1205ec6db396c209e97a5a3.js></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>czdm75 Blog</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li><input type=checkbox id=section-7258d8e1fea5a0c302a6de537a7b6f57 class=toggle>
<label for=section-7258d8e1fea5a0c302a6de537a7b6f57 class="flex justify-between"><a href=/cs/>Computer Science</a></label><ul><li><a href=/cs/linux-io-multiplex/>Linux IO Multiplexing</a></li></ul></li><li><input type=checkbox id=section-6c3d93bc59df31a703231f35ad75d678 class=toggle>
<label for=section-6c3d93bc59df31a703231f35ad75d678 class="flex justify-between"><a href=/distributed/>Distributed Systems</a></label><ul><li><a href=/distributed/hadoop-basic/>Hadoop Basic Concepts</a></li><li><a href=/distributed/spark-rdd/>Spark RDD Programming</a></li><li><a href=/distributed/spark-sql/>Spark SQL Programming</a></li></ul></li><li><a href=/notes/>Notes on Books</a><ul><li><input type=checkbox id=section-75aaf2c83c6ed8e1f079c5418c19dad4 class=toggle checked>
<label for=section-75aaf2c83c6ed8e1f079c5418c19dad4 class="flex justify-between"><a href=/notes/core-java-impatient/>Core Java for Impatients</a></label><ul><li><a href=/notes/core-java-impatient/1/>1. Basic OOP</a></li><li><a href=/notes/core-java-impatient/2/>2. Interface, Lambda</a></li><li><a href=/notes/core-java-impatient/3/>3. Inheritance, Reflection</a></li><li><a href=/notes/core-java-impatient/4/ class=active>4. Exception, Logging</a></li><li><a href=/notes/core-java-impatient/5/>5. Generics</a></li><li><a href=/notes/core-java-impatient/6/>6. Collections, Streams</a></li><li><a href=/notes/core-java-impatient/7/>7. IO, Regexp, Serialization</a></li><li><a href=/notes/core-java-impatient/8/>8. Threading</a></li><li><a href=/notes/core-java-impatient/9/>9. Notations</a></li></ul></li><li><input type=checkbox id=section-b2f01d2b22c35e214487b845322f7a58 class=toggle>
<label for=section-b2f01d2b22c35e214487b845322f7a58 class="flex justify-between"><a href=/notes/ddia/>Designing Data-Intensive Applications</a></label><ul><li><a href=/notes/ddia/1/>1. Data System and Data Model</a></li><li><a href=/notes/ddia/2/>2. Storage, Query, Encoding</a></li><li><a href=/notes/ddia/3/>3. Replication and Partition</a></li></ul></li><li><input type=checkbox id=section-8c64db930c5b756022bf5d3ba1af6015 class=toggle>
<label for=section-8c64db930c5b756022bf5d3ba1af6015 class="flex justify-between"><a href=/notes/in-depth-jvm/>In-depth Understanding JVM</a></label><ul><li><a href=/notes/in-depth-jvm/gc/>Garbage Collection</a></li><li><a href=/notes/in-depth-jvm/synchronization/>Java Synchronization</a></li><li><a href=/notes/in-depth-jvm/memory-model/>JVM Memory Model</a></li><li><a href=/notes/in-depth-jvm/memory-region/>JVM Memory Regions</a></li><li><a href=/notes/in-depth-jvm/threadlocal-reference/>ThreadLocal and Reference</a></li></ul></li><li><input type=checkbox id=section-15259ec15aa2cb7859c77500905f6b03 class=toggle>
<label for=section-15259ec15aa2cb7859c77500905f6b03 class="flex justify-between"><a href=/notes/intro-algo/>Introduction to Algorithms</a></label><ul><li><a href=/notes/intro-algo/1/>1. Compexity, Divide</a></li><li><a href=/notes/intro-algo/2/>2. Sorting, Order Statistic</a></li><li><a href=/notes/intro-algo/3/>3. LinkedList, HashTable</a></li><li><a href=/notes/intro-algo/4/>4. BST, Balanced BSTs</a></li><li><a href=/notes/intro-algo/5/>5. Trie-Tree, Extending Data Structures</a></li><li><a href=/notes/intro-algo/6/>6. Dynamic Programming, Greedy, Amortize</a></li><li><a href=/notes/intro-algo/7/>7. B-Tree, Fibonacci Heap, vEB Tree</a></li><li><a href=/notes/intro-algo/8/>8. Graphs</a></li></ul></li><li><input type=checkbox id=section-3efdc8e38ef7f47959bf45f30a9dec98 class=toggle>
<label for=section-3efdc8e38ef7f47959bf45f30a9dec98 class="flex justify-between"><a href=/notes/programming-scala/>Programming in Scala</a></label><ul><li><a href=/notes/programming-scala/1/>1. Basics</a></li><li><a href=/notes/programming-scala/2/>2. Functions</a></li><li><a href=/notes/programming-scala/3/>3 .Inheritance, Package, Assertion</a></li><li><a href=/notes/programming-scala/4/>4. Pattern Matching, Collections</a></li><li><a href=/notes/programming-scala/5/>5. Generics, Abstract, Implicits</a></li><li><a href=/notes/programming-scala/6/>6. Collections, Extractor, etc</a></li></ul></li></ul></li><li><input type=checkbox id=section-ebdb83a62411872593631ee1e4ab41d9 class=toggle>
<label for=section-ebdb83a62411872593631ee1e4ab41d9 class="flex justify-between"><a href=/pl/>Programming Languages</a></label><ul><li><a href=/pl/java-nio-2/>Java NIO Internal</a></li><li><a href=/pl/java-nio-1/>Java NIO Usage</a></li><li><a href=/pl/lambda/>Lambda Calculus and Y Combinator</a></li><li><a href=/pl/curry/>Scala: Currying, Partially Applied, Partial</a></li><li><a href=/pl/monad/>Scala: Monad, from Scala Perspective</a></li></ul></li></ul><ul><li><a href=https://github.com/czdm75 target=_blank rel=noopener>GitHub</a></li><li><a href=https://themes.gohugo.io/hugo-book/ target=_blank rel=noopener>Theme</a></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu>
</label><strong>4. Exception, Logging</strong>
<label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#异常>异常</a><ul><li><a href=#异常对象>异常对象</a></li><li><a href=#异常捕获>异常捕获</a><ul><li><a href=#多种异常>多种异常</a></li><li><a href=#try-with-resources>try-with-resources</a></li><li><a href=#finally>finally</a></li></ul></li><li><a href=#异常处理>异常处理</a><ul><li><a href=#重抛>重抛</a></li><li><a href=#链chaining>链（chaining）</a></li><li><a href=#堆栈信息>堆栈信息</a></li><li><a href=#requirenotnull>requireNotNull()</a></li></ul></li></ul></li><li><a href=#断言>断言</a></li><li><a href=#日志>日志</a><ul><li><a href=#使用日志>使用日志</a></li><li><a href=#配置日志>配置日志</a><ul><li><a href=#配置等级>配置等级</a></li><li><a href=#配置-handler>配置 Handler</a></li><li><a href=#filter-和-formatter>Filter 和 Formatter</a></li></ul></li></ul></li></ul></nav></aside></header><article class=markdown><h1 id=异常>异常
<a class=anchor href=#%e5%bc%82%e5%b8%b8>#</a></h1><h2 id=异常对象>异常对象
<a class=anchor href=#%e5%bc%82%e5%b8%b8%e5%af%b9%e8%b1%a1>#</a></h2><p><code>RuntimeException</code> 和 <code>CheckedException</code> 继承于 <code>Exception</code>，<code>Exception</code> 和 <code>Error</code> 继承于 <code>Throwable</code>。<code>Error</code> 和 <code>RuntimeException</code> 均属于 Unchecked Exception。</p><p>Checked Exception 和 Unchecked Exception 在意义上是存在区别的。例如，有关 IO 和类加载的异常大多是 Checked Exception，因为编写代码时无法判断该异常会不会发生。唯一的办法是捕获并处理它。相比之下，类似 <code>NumberFormatException</code> 这一类异常的发生是可以在代码中进行避免的。因此，属于 Unchecked Exception，需要在代码中进行预防而非捕获。</p><p>如果调用可能抛出 Checked Exception，就需要在方法头声明，以便找到最终最适合处理的位置。对于 lambda 表达式也同理。如果 lambda 表达式可能抛出 Checked Exception，就无法被传给一个不抛出异常的函数式接口。好在，大多数情况下，抛出的异常都适合在 lambda 表达式里捕获处理。</p><p>在编写自定义的异常类时，建议至少提供两个构造方法：一个无参的方法和一个接受消息字符串的方法。</p><h2 id=异常捕获>异常捕获
<a class=anchor href=#%e5%bc%82%e5%b8%b8%e6%8d%95%e8%8e%b7>#</a></h2><h3 id=多种异常>多种异常
<a class=anchor href=#%e5%a4%9a%e7%a7%8d%e5%bc%82%e5%b8%b8>#</a></h3><p>对于需要处理多种异常的情况，可以分别或一起捕获：</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:green;font-weight:700>try</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>...<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb> </span><span style=color:green;font-weight:700>catch</span><span style=color:#bbb> </span>(ExceptionClass<span style=color:#bbb> </span><span style=color:#666>|</span><span style=color:#bbb> </span>ExceptionClazz<span style=color:#bbb> </span>ex)<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>ex.<span style=color:#7d9029>fun</span>()...<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb> </span><span style=color:green;font-weight:700>catch</span><span style=color:#bbb> </span>(ExClass<span style=color:#bbb> </span>ex)<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>...<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span></code></pre></div><h3 id=try-with-resources>try-with-resources
<a class=anchor href=#try-with-resources>#</a></h3><p>对于临时需要的资源，使用 try-with-resources 语句，资源需要实现 <code>AutoClosable</code> 接口：</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:green;font-weight:700>public</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>interface</span> <span style=color:#00f;font-weight:700>AutoClosable</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>public</span><span style=color:#bbb> </span><span style=color:#b00040>void</span><span style=color:#bbb> </span><span style=color:#00f>close</span>()<span style=color:#bbb> </span><span style=color:green;font-weight:700>throws</span><span style=color:#bbb> </span>Exception;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>public</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>interface</span> <span style=color:#00f;font-weight:700>Closable</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>implements</span><span style=color:#bbb> </span>AutoClosable<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>public</span><span style=color:#bbb> </span><span style=color:#b00040>void</span><span style=color:#bbb> </span><span style=color:#00f>close</span>()<span style=color:#bbb> </span><span style=color:green;font-weight:700>throws</span><span style=color:#bbb> </span>IOException;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#408080;font-style:italic>//use try-with-resources</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>try</span><span style=color:#bbb> </span>(PrintWriter<span style=color:#bbb> </span>out<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>new</span><span style=color:#bbb> </span>Printwriter(<span style=color:#ba2121>&#34;output.txt&#34;</span>))<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>...<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb> </span><span style=color:green;font-weight:700>catch</span><span style=color:#bbb> </span>(Exception<span style=color:#bbb> </span>e)<span style=color:#bbb> </span>{<span style=color:#bbb>  </span><span style=color:#408080;font-style:italic>//Catch statment is optional</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>...<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span></code></pre></div><p>这样，无论是否发生了异常，资源都会被自动调用 <code>close()</code> 方法，以保证资源的释放。如果申请了多个资源，则会按照相反的顺序释放，因此资源之间可以互相依赖。</p><p>当然，<code>close()</code> 方法也可能抛出异常。这个异常同样会在 <code>catch</code> 语句中被捕获。不过，如果 <code>try</code> 块内已经发生了异常，<code>close()</code> 又发生了一个异常，那么后者会被附加到原本的异常里。</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:green;font-weight:700>catch</span><span style=color:#bbb> </span>(IOException<span style=color:#bbb> </span>ex)<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>Throwable<span style=color:#666>[]</span><span style=color:#bbb> </span>closeExceptions<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>ex.<span style=color:#7d9029>getSuppressed</span>();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#408080;font-style:italic>// manually set suppressed exception</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>ex.<span style=color:#7d9029>addSuppressed</span>(e);<span style=color:#bbb>
</span></span></span></code></pre></div><h3 id=finally>finally
<a class=anchor href=#finally>#</a></h3><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:green;font-weight:700>try</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>...<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb> </span><span style=color:green;font-weight:700>catch</span><span style=color:#bbb> </span>(Exception<span style=color:#bbb> </span>ex)<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>...<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb> </span><span style=color:green;font-weight:700>finally</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>...<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span></code></pre></div><p>无论是否有异常，<code>finally</code> 子句都会在 <code>try</code> 之后被运行。</p><p>由于 <code>finally</code> 语句一定会被运行（存在一些特殊情况，如线程被终止），所以<strong>必须避免</strong>在 <code>finally</code> 中抛出异常或者返回值。否则，这个异常和返回值就会覆盖掉 <code>try</code> 中的异常和返回值（这里没有上面的 Suppressed 机制）。很多时候，<code>finally</code> 都可以被 try-with resources 取代。仍然需要 <code>finally</code> 的时候，通常是当 <code>try</code> 块中出现了 <code>return</code> <code>break</code> <code>continue</code> 等情况。这时，即使跳出或者返回，<code>finally</code> 都能很好地完成清理工作。</p><p><a href=https://www.ibm.com/developerworks/cn/java/j-lo-finally/>这篇文章</a>比较详细地讲解了 <code>finally</code> 块的情况。</p><h2 id=异常处理>异常处理
<a class=anchor href=#%e5%bc%82%e5%b8%b8%e5%a4%84%e7%90%86>#</a></h2><h3 id=重抛>重抛
<a class=anchor href=#%e9%87%8d%e6%8a%9b>#</a></h3><p>无法处理的异常应该被重抛出去：</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:green;font-weight:700>public</span><span style=color:#bbb> </span><span style=color:#b00040>void</span><span style=color:#bbb> </span><span style=color:#00f>fun</span>()<span style=color:#bbb> </span><span style=color:green;font-weight:700>throws</span><span style=color:#bbb> </span>IOException<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>try</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>...<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb> </span><span style=color:green;font-weight:700>catch</span><span style=color:#bbb> </span>(Exception<span style=color:#bbb> </span>ex)<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>...<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>throw</span><span style=color:#bbb> </span>ex;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span></code></pre></div><h3 id=链chaining>链（chaining）
<a class=anchor href=#%e9%93%bechaining>#</a></h3><p>或者如果你想要改变抛出异常的类型，把它封装起来：</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:green;font-weight:700>catch</span><span style=color:#bbb> </span>(SQLException<span style=color:#bbb> </span>ex)<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>throw</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>new</span><span style=color:#bbb> </span>ServletException(<span style=color:#ba2121>&#34;info&#34;</span>,<span style=color:#bbb> </span>ex);<span style=color:#bbb>  </span><span style=color:#408080;font-style:italic>// Exception that privides constructor</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb> </span><span style=color:green;font-weight:700>catch</span><span style=color:#bbb> </span>(OtherException<span style=color:#bbb> </span>ex)<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>Throwble<span style=color:#bbb> </span>e<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>new</span><span style=color:#bbb> </span>CruftyOldException(<span style=color:#ba2121>&#34;info&#34;</span>);<span style=color:#bbb>  </span><span style=color:#408080;font-style:italic>// Exception that don&#39;t provide</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>e.<span style=color:#7d9029>initCause</span>(ex);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>throw</span><span style=color:#bbb> </span>e;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#408080;font-style:italic>//outer caller</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>catch</span><span style=color:#bbb> </span>(ServletException<span style=color:#bbb> </span>ex)<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>Throwable<span style=color:#bbb> </span>cause<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>ex.<span style=color:#7d9029>getCause</span>();<span style=color:#bbb>  </span><span style=color:#408080;font-style:italic>// can&#39;t figure out what kind of cause it is</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span></code></pre></div><h3 id=堆栈信息>堆栈信息
<a class=anchor href=#%e5%a0%86%e6%a0%88%e4%bf%a1%e6%81%af>#</a></h3><p>默认，未被捕获的异常会在 <code>System.err</code> 流输出堆栈信息。如果要重定向这个信息，可以针对当前线程进行设置：</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>Thread.<span style=color:#7d9029>setDefaultUncaughtExceptionHandler</span>((thread,<span style=color:#bbb> </span>ex)<span style=color:#bbb> </span><span style=color:#666>-&gt;</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>...<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>})<span style=color:#bbb>
</span></span></span></code></pre></div><p>即使不知道该如何处理一个异常，至少要把堆栈信息打印出来：</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>ex.<span style=color:#7d9029>printStackTrace</span>();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#408080;font-style:italic>//---------------</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>ByteArrayOutputStream<span style=color:#bbb> </span>out<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>new</span><span style=color:#bbb> </span>ByteArrayOutputStream();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>ex.<span style=color:#7d9029>printstackTrace</span>(out);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>String<span style=color:#bbb> </span>description<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>out.<span style=color:#7d9029>toString</span>();<span style=color:#bbb>
</span></span></span></code></pre></div><h3 id=requirenotnull>requireNotNull()
<a class=anchor href=#requirenotnull>#</a></h3><p><code>Objects</code> 类有一个 <code>requireNotNull</code> 方法，如果参数为 <code>null</code>，就抛出异常。这样会使 stack trace 中问题的定位更加简单一些。</p><h1 id=断言>断言
<a class=anchor href=#%e6%96%ad%e8%a8%80>#</a></h1><p>断言是防御型编程的典型做法。和手动判断的区别是，在生产代码中不需要一个个地去除判断（带来可能的问题）。</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:green;font-weight:700>assert</span><span style=color:#bbb> </span>x<span style=color:#bbb> </span><span style=color:#666>&gt;=</span><span style=color:#bbb> </span>0;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>assert</span><span style=color:#bbb> </span>x<span style=color:#bbb> </span><span style=color:#666>&gt;=</span><span style=color:#bbb> </span>0:<span style=color:#bbb> </span>x;<span style=color:#bbb>
</span></span></span></code></pre></div><p>第二种的 <code>x</code> 会转换为字符串作为错误消息。断言由 Class Loader 处理，所以不需要分别编译 debug 版本和 release 版本。在运行程序时，使用参数来启用断言：</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>java -ea MainClass
</span></span><span style=display:flex><span>java -enableassertions MainClass
</span></span><span style=display:flex><span><span style=color:#408080;font-style:italic># enable assertion for specific class or package</span>
</span></span><span style=display:flex><span>java -ea:MyClass -ea:com.test.package MainClass
</span></span><span style=display:flex><span><span style=color:#408080;font-style:italic># -disableassertions</span>
</span></span><span style=display:flex><span>java -ea:com -da:com.StableClass MainClass
</span></span><span style=display:flex><span><span style=color:#408080;font-style:italic># for &#34;System Classes&#34; that are not managed by class loader</span>
</span></span><span style=display:flex><span>java -esa
</span></span><span style=display:flex><span>java -enablesystemassertions
</span></span></code></pre></div><p>或者在运行时处理断言的状态：</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#b00040>void</span><span style=color:#bbb> </span>ClassLoader.<span style=color:#7d9029>setDefaultAssertionStatus</span>(<span style=color:#b00040>boolean</span><span style=color:#bbb> </span>enabled);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#b00040>void</span><span style=color:#bbb> </span>ClassLoader.<span style=color:#7d9029>setClassAssertionStatus</span>(String<span style=color:#bbb> </span>className,<span style=color:#bbb> </span><span style=color:#b00040>boolean</span><span style=color:#bbb> </span>enabled);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#b00040>void</span><span style=color:#bbb> </span>ClassLoader.<span style=color:#7d9029>setPackageAssertionStatus</span>(String<span style=color:#bbb> </span>packageName,<span style=color:#bbb> </span><span style=color:#b00040>boolean</span><span style=color:#bbb> </span>enabled);<span style=color:#bbb>
</span></span></span></code></pre></div><h1 id=日志>日志
<a class=anchor href=#%e6%97%a5%e5%bf%97>#</a></h1><h2 id=使用日志>使用日志
<a class=anchor href=#%e4%bd%bf%e7%94%a8%e6%97%a5%e5%bf%97>#</a></h2><p>Java 现在引入了日志 API，使用 <code>java.util.logging.Logger</code> 类。</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>Logger.<span style=color:#7d9029>getGlobal</span>().<span style=color:#7d9029>info</span>(<span style=color:#ba2121>&#34;info&#34;</span><span style=color:#bbb> </span><span style=color:#666>+</span><span style=color:#bbb> </span>filename<span style=color:#bbb> </span><span style=color:#666>+</span><span style=color:#bbb> </span>...);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>Logger.<span style=color:#7d9029>getGlobal</span>().<span style=color:#7d9029>log</span>(Level.<span style=color:#7d9029>INFO</span>,<span style=color:#bbb> </span><span style=color:#ba2121>&#34;info&#34;</span>);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#408080;font-style:italic>// prints Time, class, method, level and info</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#408080;font-style:italic>// 有些情况难以得到准确的堆栈信息，例如方法被内联的时候</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#408080;font-style:italic>// 这时，可以手动指定信息</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>Logger.<span style=color:#7d9029>getGlobal</span>.<span style=color:#7d9029>logp</span>(Level<span style=color:#bbb> </span>l,<span style=color:#bbb> </span>String<span style=color:#bbb> </span>className,<span style=color:#bbb> </span>String<span style=color:#bbb> </span>methodName,<span style=color:#bbb> </span>String<span style=color:#bbb> </span>message);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>Logger.<span style=color:#7d9029>getGlobal</span>.<span style=color:#7d9029>setLevel</span>(Level.<span style=color:#7d9029>OFF</span>);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#408080;font-style:italic>// create your own logger</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>Logger<span style=color:#bbb> </span>logger<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>Logger.<span style=color:#7d9029>getLogger</span>(<span style=color:#ba2121>&#34;com.test.000&#34;</span>);<span style=color:#bbb>
</span></span></span></code></pre></div><p>即使日志 Level 设置为更低，上面的字符串连接过程也要进行。如果要避免这个代价，可以使用 lambda 表达式：</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>Logger.<span style=color:#7d9029>getGlobal</span>().<span style=color:#7d9029>info</span>(()<span style=color:#bbb> </span><span style=color:#666>-&gt;</span><span style=color:#bbb> </span><span style=color:#ba2121>&#34;info&#34;</span><span style=color:#bbb> </span><span style=color:#666>+</span><span style=color:#bbb> </span>filename<span style=color:#bbb> </span><span style=color:#666>+</span><span style=color:#bbb> </span>...);<span style=color:#bbb>
</span></span></span></code></pre></div><p>另外，为了更好地管理与包有关的日志，日志的父子之间会存在一些关系。例如，如果 <code>com</code> Logger 的 Level 设置为 OFF，<code>com.test</code> Logger 的 Level 未设置（默认是 null），那么 <code>com.test</code> Logger 也无法写日志。</p><p>此外，还有一些预置的方便的方法：</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#b00040>void</span><span style=color:#bbb> </span><span style=color:#00f>entering</span>(String<span style=color:#bbb> </span>className,<span style=color:#bbb> </span>String<span style=color:#bbb> </span>methodName);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#b00040>void</span><span style=color:#bbb> </span><span style=color:#00f>entering</span>(String<span style=color:#bbb> </span>className,<span style=color:#bbb> </span>String<span style=color:#bbb> </span>methodName,<span style=color:#bbb> </span>Object<span style=color:#bbb> </span>param);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#b00040>void</span><span style=color:#bbb> </span><span style=color:#00f>entering</span>(String<span style=color:#bbb> </span>className,<span style=color:#bbb> </span>String<span style=color:#bbb> </span>methodName,<span style=color:#bbb> </span>Object<span style=color:#666>[]</span><span style=color:#bbb> </span>params);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#b00040>void</span><span style=color:#bbb> </span><span style=color:#00f>exiting</span>(String<span style=color:#bbb> </span>className,<span style=color:#bbb> </span>String<span style=color:#bbb> </span>methodName);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#b00040>void</span><span style=color:#bbb> </span><span style=color:#00f>entering</span>(String<span style=color:#bbb> </span>className,<span style=color:#bbb> </span>String<span style=color:#bbb> </span>methodName,<span style=color:#bbb> </span>Object<span style=color:#bbb> </span>result);<span style=color:#bbb>
</span></span></span></code></pre></div><p>这些方法将会写出 FINER 级别的进入和离开方法的日志。很奇怪的是，这里没有被写成可变参数。</p><p>对于有关异常的日志，可以使用：</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#b00040>void</span><span style=color:#bbb> </span><span style=color:#00f>log</span>(Level<span style=color:#bbb> </span>l,<span style=color:#bbb> </span>String<span style=color:#bbb> </span>message,<span style=color:#bbb> </span>Throwable<span style=color:#bbb> </span>t);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#b00040>void</span><span style=color:#bbb> </span><span style=color:#00f>throwing</span>(String<span style=color:#bbb> </span>className,<span style=color:#bbb> </span>String<span style=color:#bbb> </span>methodName,<span style=color:#bbb> </span>Throwable<span style=color:#bbb> </span>t);<span style=color:#bbb>
</span></span></span></code></pre></div><h2 id=配置日志>配置日志
<a class=anchor href=#%e9%85%8d%e7%bd%ae%e6%97%a5%e5%bf%97>#</a></h2><h3 id=配置等级>配置等级
<a class=anchor href=#%e9%85%8d%e7%bd%ae%e7%ad%89%e7%ba%a7>#</a></h3><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#408080;font-style:italic># 指定有关日志的配置文件的位置：</span>
</span></span><span style=display:flex><span>java -Djava.util.logging.config.file<span style=color:#666>=</span>configFile MainClass
</span></span></code></pre></div><p>在配置文件里，对日志属性进行设置：</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-properties data-lang=properties><span style=display:flex><span><span style=color:#7d9029>com.test.level</span><span style=color:#666>=</span><span style=color:#ba2121>FINE</span>
</span></span><span style=display:flex><span><span style=color:#408080;font-style:italic># for Handlers below</span>
</span></span><span style=display:flex><span><span style=color:#7d9029>java.util.logging.ConsoleHandler.level</span><span style=color:#666>=</span><span style=color:#ba2121>FINE</span>
</span></span></code></pre></div><h3 id=配置-handler>配置 Handler
<a class=anchor href=#%e9%85%8d%e7%bd%ae-handler>#</a></h3><p>日志的实际处理由 <code>Handler</code> 完成。如，<code>ConsoleHandler</code> 将日志从 <code>System.err</code> 打印出来。默认，根 Logger，即名为空字符串的 Logger 连接到一个 <code>ConsoleHandler</code>。</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>Logger<span style=color:#bbb> </span>logger<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>Logger.<span style=color:#7d9029>getLogger</span>(<span style=color:#ba2121>&#34;com.test&#34;</span>);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>logger.<span style=color:#7d9029>setUseParentHandlers</span>(<span style=color:green;font-weight:700>false</span>);<span style=color:#bbb>  </span><span style=color:#408080;font-style:italic>// stop sending to parent</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>logger.<span style=color:#7d9029>addHandler</span>(<span style=color:green;font-weight:700>new</span><span style=color:#bbb> </span>ConsolHandler);<span style=color:#bbb>
</span></span></span></code></pre></div><p>Java API 默认提供了另外两种 <code>Handler</code>。<code>SocketHandler</code> 将日志发送给网络，<code>FileHandler</code> 写到文件。默认，会写入一个 <code>javax.log</code> 文件，其中 <code>x</code>是一个用来确保唯一的整数，默认为 XML 格式。</p><p><code>FileHandler</code> 的配置项包括：<code>level</code> <code>append</code> <code>limit</code>（字节数）<code>pattern</code> <code>count</code>（循环的文件数）<code>filter</code> <code>encoding</code> <code>formatter</code>。</p><p>在文件名 <code>pattern</code> 中，可以使用的模式包括：<code>%h</code> 家目录，<code>%t</code> 系统临时目录，<code>%u</code> 唯一编号，<code>%%</code> % 号。</p><h3 id=filter-和-formatter>Filter 和 Formatter
<a class=anchor href=#filter-%e5%92%8c-formatter>#</a></h3><p><code>Filter</code> 是一个函数式接口：</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:green;font-weight:700>public</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>interface</span> <span style=color:#00f;font-weight:700>Filter</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#b00040>boolean</span><span style=color:#bbb> </span><span style=color:#00f>isLoggable</span>(LogRecord<span style=color:#bbb> </span>record);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span></code></pre></div><p>一次只能通过 <code>setFilter()</code> 使用一个 <code>Filter</code>。</p><p><code>Formatter</code> 类需要覆盖方法：</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>String<span style=color:#bbb> </span><span style=color:#00f>format</span>(LogRecord<span style=color:#bbb> </span>record);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#408080;font-style:italic>// for xml formatters:</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>String<span style=color:#bbb> </span><span style=color:#00f>getHead</span>(Handler<span style=color:#bbb> </span>h);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>String<span style=color:#bbb> </span><span style=color:#00f>getTail</span>(Handler<span style=color:#bbb> </span>h);<span style=color:#bbb>
</span></span></span></code></pre></div><p>其中可能需要用到</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>String<span style=color:#bbb> </span><span style=color:#00f>formatMessage</span>(LogRecord<span style=color:#bbb> </span>record);<span style=color:#bbb>
</span></span></span></code></pre></div></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#异常>异常</a><ul><li><a href=#异常对象>异常对象</a></li><li><a href=#异常捕获>异常捕获</a><ul><li><a href=#多种异常>多种异常</a></li><li><a href=#try-with-resources>try-with-resources</a></li><li><a href=#finally>finally</a></li></ul></li><li><a href=#异常处理>异常处理</a><ul><li><a href=#重抛>重抛</a></li><li><a href=#链chaining>链（chaining）</a></li><li><a href=#堆栈信息>堆栈信息</a></li><li><a href=#requirenotnull>requireNotNull()</a></li></ul></li></ul></li><li><a href=#断言>断言</a></li><li><a href=#日志>日志</a><ul><li><a href=#使用日志>使用日志</a></li><li><a href=#配置日志>配置日志</a><ul><li><a href=#配置等级>配置等级</a></li><li><a href=#配置-handler>配置 Handler</a></li><li><a href=#filter-和-formatter>Filter 和 Formatter</a></li></ul></li></ul></li></ul></nav></div></aside></main></body></html>