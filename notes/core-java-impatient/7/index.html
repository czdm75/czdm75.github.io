<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="IO 流 #  创建和使用字节流 #  // Create Stream Path path = new Path(&#34;...&#34;) InputStream in = Files.newInputStream(path); OutputStream in = Files.newOutputStream(path);  byte[] bytes = ...; InputStream in = new ByteArrayInputStream(bytes); ByteArrayOutputStream out = new ByteArrayOutputStream(); byte[] bytes = out.toByteArray(); // read bytes int b = in.read(); //single byte, 0~255, or -1 for EOF. but byte is -128~127. byte[] bytes = ...; actualBytesRead = in.read(bytes); //read till EOF or byte[] full, return count actualBytesRead = in."><meta name=theme-color content="#FFFFFF"><meta name=color-scheme content="light dark"><meta property="og:title" content="7. IO, Regexp, Serialization"><meta property="og:description" content="IO 流 #  创建和使用字节流 #  // Create Stream Path path = new Path(&#34;...&#34;) InputStream in = Files.newInputStream(path); OutputStream in = Files.newOutputStream(path);  byte[] bytes = ...; InputStream in = new ByteArrayInputStream(bytes); ByteArrayOutputStream out = new ByteArrayOutputStream(); byte[] bytes = out.toByteArray(); // read bytes int b = in.read(); //single byte, 0~255, or -1 for EOF. but byte is -128~127. byte[] bytes = ...; actualBytesRead = in.read(bytes); //read till EOF or byte[] full, return count actualBytesRead = in."><meta property="og:type" content="article"><meta property="og:url" content="/notes/core-java-impatient/7/"><meta property="article:section" content="notes"><title>7. IO, Regexp, Serialization | czdm75 Blog</title><link rel=manifest href=/manifest.json><link rel=icon href=/favicon.png type=image/x-icon><link rel=stylesheet href=/book.min.97cfda4f5e3c9fa49a2bf8d401f4ddc0eec576c99cdcf6afbec19173200c37db.css><script defer src=/flexsearch.min.js></script>
<script defer src=/en.search.min.60f5c0362a1b15384bf6fbb748ad6fb49d79819ad4313fc4618ffb6d1f645f15.js></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>czdm75 Blog</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li><input type=checkbox id=section-25b8c894ab868b34ecd6cce0ce4c79c7 class=toggle>
<label for=section-25b8c894ab868b34ecd6cce0ce4c79c7 class="flex justify-between"><a href=/cs/>Computer Science</a></label><ul><li><a href=/cs/linux-io-multiplex/>Linux IO Multiplexing</a></li></ul></li><li><input type=checkbox id=section-d5643d9c227c9fc0bfaa81dc6e0249af class=toggle>
<label for=section-d5643d9c227c9fc0bfaa81dc6e0249af class="flex justify-between"><a href=/distributed/>Distributed Systems</a></label><ul><li><a href=/distributed/hadoop-basic/>Hadoop Basic Concepts</a></li><li><a href=/distributed/spark-rdd/>Spark RDD Programming</a></li><li><a href=/distributed/spark-sql/>Spark SQL Programming</a></li></ul></li><li><a href=/notes/>Notes on Books</a><ul><li><input type=checkbox id=section-f9c54ee28ad742882651b9afb106f923 class=toggle checked>
<label for=section-f9c54ee28ad742882651b9afb106f923 class="flex justify-between"><a href=/notes/core-java-impatient/>Core Java for Impatients</a></label><ul><li><a href=/notes/core-java-impatient/1/>1. Basic OOP</a></li><li><a href=/notes/core-java-impatient/2/>2. Interface, Lambda</a></li><li><a href=/notes/core-java-impatient/3/>3. Inheritance, Reflection</a></li><li><a href=/notes/core-java-impatient/4/>4. Exception, Logging</a></li><li><a href=/notes/core-java-impatient/5/>5. Generics</a></li><li><a href=/notes/core-java-impatient/6/>6. Collections, Streams</a></li><li><a href=/notes/core-java-impatient/7/ class=active>7. IO, Regexp, Serialization</a></li><li><a href=/notes/core-java-impatient/8/>8. Threading</a></li><li><a href=/notes/core-java-impatient/9/>9. Notations</a></li></ul></li><li><input type=checkbox id=section-9d0fb26a4934bb77406a56b94138590b class=toggle>
<label for=section-9d0fb26a4934bb77406a56b94138590b class="flex justify-between"><a href=/notes/in-depth-jvm/>In-depth Understanding JVM</a></label><ul><li><a href=/notes/in-depth-jvm/gc/>Garbage Collection</a></li><li><a href=/notes/in-depth-jvm/synchronization/>Java Synchronization</a></li><li><a href=/notes/in-depth-jvm/memory-model/>JVM Memory Model</a></li><li><a href=/notes/in-depth-jvm/memory-region/>JVM Memory Regions</a></li><li><a href=/notes/in-depth-jvm/threadlocal-reference/>ThreadLocal and Reference</a></li></ul></li><li><input type=checkbox id=section-4d028229be962782539eef651433109e class=toggle>
<label for=section-4d028229be962782539eef651433109e class="flex justify-between"><a href=/notes/intro-algo/>Introduction to Algorithms</a></label><ul><li><a href=/notes/intro-algo/1/>1. Compexity, Divide</a></li><li><a href=/notes/intro-algo/2/>2. Sorting, Order Statistic</a></li><li><a href=/notes/intro-algo/3/>3. LinkedList, HashTable</a></li><li><a href=/notes/intro-algo/4/>4. BST, Balanced BSTs</a></li><li><a href=/notes/intro-algo/5/>5. Trie-Tree, Extending Data Structures</a></li><li><a href=/notes/intro-algo/6/>6. Dynamic Programming, Greedy, Amortize</a></li><li><a href=/notes/intro-algo/7/>7. B-Tree, Fibonacci Heap, vEB Tree</a></li><li><a href=/notes/intro-algo/8/>8. Graphs</a></li></ul></li><li><input type=checkbox id=section-76be9453a58f37863458b83352d3ff3c class=toggle>
<label for=section-76be9453a58f37863458b83352d3ff3c class="flex justify-between"><a href=/notes/programming-scala/>Programming in Scala</a></label><ul><li><a href=/notes/programming-scala/1/>1. Basics</a></li><li><a href=/notes/programming-scala/2/>2. Functions</a></li><li><a href=/notes/programming-scala/3/>3 .Inheritance, Package, Assertion</a></li><li><a href=/notes/programming-scala/4/>4. Pattern Matching, Collections</a></li><li><a href=/notes/programming-scala/5/>5. Generics, Abstract, Implicits</a></li><li><a href=/notes/programming-scala/6/>6. Collections, Extractor, etc</a></li></ul></li></ul></li><li><input type=checkbox id=section-9784d97422a8bbe41d06f74a08150515 class=toggle>
<label for=section-9784d97422a8bbe41d06f74a08150515 class="flex justify-between"><a href=/pl/>Programming Languages</a></label><ul><li><a href=/pl/java-nio-2/>Java NIO Internal</a></li><li><a href=/pl/java-nio-1/>Java NIO Usage</a></li><li><a href=/pl/lambda/>Lambda Calculus and Y Combinator</a></li><li><a href=/pl/curry/>Scala: Currying, Partially Applied, Partial</a></li><li><a href=/pl/monad/>Scala: Monad, from Scala Perspective</a></li></ul></li></ul><ul><li><a href=https://github.com/czdm75 target=_blank rel=noopener>GitHub</a></li><li><a href=https://themes.gohugo.io/hugo-book/ target=_blank rel=noopener>Theme</a></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label>
<strong>7. IO, Regexp, Serialization</strong>
<label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#io-流>IO 流</a><ul><li><a href=#创建和使用字节流>创建和使用字节流</a></li><li><a href=#处理字符流>处理字符流</a><ul><li><a href=#编码大小端序和-bom>编码，大小端序和 BOM</a></li><li><a href=#reader>Reader</a></li><li><a href=#writer>Writer</a></li></ul></li><li><a href=#读写二进制数据>读写二进制数据</a></li><li><a href=#内存映射文件>内存映射文件</a></li><li><a href=#文件锁>文件锁</a></li></ul></li><li><a href=#路径和文件>路径和文件</a><ul><li><a href=#使用-path-类>使用 Path 类</a></li><li><a href=#文件和目录>文件和目录</a></li></ul></li><li><a href=#url-连接>URL 连接</a></li><li><a href=#正则表达式>正则表达式</a><ul><li><a href=#匹配和提取>匹配和提取</a></li><li><a href=#处理>处理</a></li><li><a href=#正则表达式标记>正则表达式标记</a></li></ul></li><li><a href=#序列化>序列化</a><ul><li><a href=#serializable>Serializable</a></li><li><a href=#继承与序列化>继承与序列化</a></li><li><a href=#重写-writeobject-和-readobject>重写 writeObject 和 readObject</a></li><li><a href=#readresolve-和-writereplace>readResolve 和 writeReplace</a></li><li><a href=#版本化>版本化</a></li></ul></li></ul></nav></aside></header><article class=markdown><h1 id=io-流>IO 流
<a class=anchor href=#io-%e6%b5%81>#</a></h1><h2 id=创建和使用字节流>创建和使用字节流
<a class=anchor href=#%e5%88%9b%e5%bb%ba%e5%92%8c%e4%bd%bf%e7%94%a8%e5%ad%97%e8%8a%82%e6%b5%81>#</a></h2><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#408080;font-style:italic>// Create Stream
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>Path path <span style=color:#666>=</span> <span style=color:green;font-weight:700>new</span> Path<span style=color:#666>(</span><span style=color:#ba2121>&#34;...&#34;</span><span style=color:#666>)</span>
</span></span><span style=display:flex><span>InputStream in <span style=color:#666>=</span> Files<span style=color:#666>.</span><span style=color:#7d9029>newInputStream</span><span style=color:#666>(</span>path<span style=color:#666>);</span>
</span></span><span style=display:flex><span>OutputStream in <span style=color:#666>=</span> Files<span style=color:#666>.</span><span style=color:#7d9029>newOutputStream</span><span style=color:#666>(</span>path<span style=color:#666>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#b00040>byte</span><span style=color:#666>[]</span> bytes <span style=color:#666>=</span> <span style=color:#666>...;</span>
</span></span><span style=display:flex><span>InputStream in <span style=color:#666>=</span> <span style=color:green;font-weight:700>new</span> ByteArrayInputStream<span style=color:#666>(</span>bytes<span style=color:#666>);</span>
</span></span><span style=display:flex><span>ByteArrayOutputStream out <span style=color:#666>=</span> <span style=color:green;font-weight:700>new</span> ByteArrayOutputStream<span style=color:#666>();</span>
</span></span><span style=display:flex><span><span style=color:#b00040>byte</span><span style=color:#666>[]</span> bytes <span style=color:#666>=</span> out<span style=color:#666>.</span><span style=color:#7d9029>toByteArray</span><span style=color:#666>();</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#408080;font-style:italic>// read bytes
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span><span style=color:#b00040>int</span> b <span style=color:#666>=</span> in<span style=color:#666>.</span><span style=color:#7d9029>read</span><span style=color:#666>();</span>  <span style=color:#408080;font-style:italic>//single byte, 0~255, or -1 for EOF. but byte is -128~127.
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span><span style=color:#b00040>byte</span><span style=color:#666>[]</span> bytes <span style=color:#666>=</span> <span style=color:#666>...;</span>
</span></span><span style=display:flex><span>actualBytesRead <span style=color:#666>=</span> in<span style=color:#666>.</span><span style=color:#7d9029>read</span><span style=color:#666>(</span>bytes<span style=color:#666>);</span>  <span style=color:#408080;font-style:italic>//read till EOF or byte[] full, return count
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>actualBytesRead <span style=color:#666>=</span> in<span style=color:#666>.</span><span style=color:#7d9029>read</span><span style=color:#666>(</span>bytes<span style=color:#666>,</span> start<span style=color:#666>,</span> length<span style=color:#666>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#408080;font-style:italic>//to read all bytes from a file
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span><span style=color:#b00040>byte</span><span style=color:#666>[]</span> bytes <span style=color:#666>=</span> Files<span style=color:#666>.</span><span style=color:#7d9029>readAllBytes</span><span style=color:#666>(</span>path<span style=color:#666>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#408080;font-style:italic>//to read all byte from a stream
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span><span style=color:green;font-weight:700>public</span> <span style=color:green;font-weight:700>static</span> <span style=color:#b00040>byte</span><span style=color:#666>[]</span> <span style=color:#00f>readAllBytes</span><span style=color:#666>(</span>InputStream in<span style=color:#666>)</span> <span style=color:green;font-weight:700>throws</span> IOException <span style=color:#666>{</span>
</span></span><span style=display:flex><span>    ByteArrayOutputStream out <span style=color:#666>=</span> <span style=color:green;font-weight:700>new</span> ByteArrayOutputStream<span style=color:#666>();</span>
</span></span><span style=display:flex><span>    <span style=color:#408080;font-style:italic>// will show below
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>    copy<span style=color:#666>(</span>in<span style=color:#666>,</span> out<span style=color:#666>);</span>
</span></span><span style=display:flex><span>    out<span style=color:#666>.</span><span style=color:#7d9029>close</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>return</span> out<span style=color:#666>.</span><span style=color:#7d9029>toByteArray</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span><span style=color:#666>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#408080;font-style:italic>//write bytes
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>out<span style=color:#666>.</span><span style=color:#7d9029>write</span><span style=color:#666>(</span><span style=color:#b00040>int</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>out<span style=color:#666>.</span><span style=color:#7d9029>write</span><span style=color:#666>(</span>bytes<span style=color:#666>);</span>
</span></span><span style=display:flex><span>out<span style=color:#666>.</span><span style=color:#7d9029>write</span><span style=color:#666>(</span>bytes<span style=color:#666>,</span> start<span style=color:#666>,</span> length<span style=color:#666>);</span>
</span></span><span style=display:flex><span><span style=color:#408080;font-style:italic>// must close to flush. better:
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span><span style=color:green;font-weight:700>try</span> <span style=color:#666>(</span>OutputStream out <span style=color:#666>=</span> <span style=color:#666>...)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>    out<span style=color:#666>.</span><span style=color:#7d9029>write</span><span style=color:#666>(</span>bytes<span style=color:#666>);</span>
</span></span><span style=display:flex><span><span style=color:#666>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#408080;font-style:italic>// save an input stream to file
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>Files<span style=color:#666>.</span><span style=color:#7d9029>copy</span><span style=color:#666>(</span>in<span style=color:#666>,</span> path<span style=color:#666>,</span> StandardCopyOption<span style=color:#666>.</span><span style=color:#7d9029>REPLACE_EXISTING</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#408080;font-style:italic>// the copy method used above
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span><span style=color:green;font-weight:700>public</span> <span style=color:green;font-weight:700>static</span> <span style=color:#b00040>void</span> <span style=color:#00f>copy</span><span style=color:#666>(</span>InputStream in<span style=color:#666>,</span> OutputStream out<span style=color:#666>)</span> <span style=color:green;font-weight:700>throws</span> IOException <span style=color:#666>{</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>final</span> <span style=color:#b00040>int</span> BLOCKSIZE <span style=color:#666>=</span> 1024<span style=color:#666>;</span>
</span></span><span style=display:flex><span>    <span style=color:#b00040>byte</span><span style=color:#666>[]</span> bytes <span style=color:#666>=</span> <span style=color:green;font-weight:700>new</span> <span style=color:#b00040>byte</span><span style=color:#666>[</span>BLOCKSIZE<span style=color:#666>];</span>
</span></span><span style=display:flex><span>    <span style=color:#b00040>int</span> len<span style=color:#666>;</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>while</span> <span style=color:#666>((</span>len <span style=color:#666>=</span> in<span style=color:#666>.</span><span style=color:#7d9029>read</span><span style=color:#666>(</span>bytes<span style=color:#666>))</span> <span style=color:#666>!=</span> <span style=color:#666>-</span>1<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>        out<span style=color:#666>.</span><span style=color:#7d9029>write</span><span style=color:#666>(</span>bytes<span style=color:#666>,</span> 0<span style=color:#666>,</span> len<span style=color:#666>);</span>
</span></span><span style=display:flex><span>    <span style=color:#666>}</span>
</span></span><span style=display:flex><span><span style=color:#666>}</span>
</span></span></code></pre></div><h2 id=处理字符流>处理字符流
<a class=anchor href=#%e5%a4%84%e7%90%86%e5%ad%97%e7%ac%a6%e6%b5%81>#</a></h2><h3 id=编码大小端序和-bom>编码，大小端序和 BOM
<a class=anchor href=#%e7%bc%96%e7%a0%81%e5%a4%a7%e5%b0%8f%e7%ab%af%e5%ba%8f%e5%92%8c-bom>#</a></h3><p>对于 16 进制数 <code>0x00FF</code> ：</p><table><thead><tr><th>地址</th><th>0x00</th><th>0x01</th></tr></thead><tbody><tr><td>大端序</td><td>0x00</td><td>0xFF</td></tr><tr><td>小端序</td><td>0xFF</td><td>0x00</td></tr></tbody></table><p>这就是 &ldquo;大端序高地址存放低位，小端序高地址存放高位&rdquo;。也就是说，小端序是逆习惯的。但这对 CPU 设计有利。对于文本编码，在文件头使用一个值为 <code>0xFEFF</code> 的值来标记。如果文件头是 <code>0xFEFF</code>，说明是大端序。如果是 <code>0xFFFE</code>，说明为小端序。这就是 BOM（byte order mark）。</p><p>显然，对于 UTF-8，不存在大小端序问题。对于更多字节编码的文本，实际上，Unicode 推荐即使是 UTF-8 也使用 BOM，Windows 记事本就是这样做的。但很多其他编辑器对其支持不好。Java 选择忽略了这个问题，所以如果要手动处理文本文件，需要手动进行判断。</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>Charset shiftJIS <span style=color:#666>=</span> Charset<span style=color:#666>.</span><span style=color:#7d9029>forName</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;Shift-JIS&#34;</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>String str <span style=color:#666>=</span> <span style=color:green;font-weight:700>new</span> String<span style=color:#666>(</span>bytes<span style=color:#666>,</span> shiftJIS<span style=color:#666>);</span>
</span></span><span style=display:flex><span>String str <span style=color:#666>=</span> <span style=color:green;font-weight:700>new</span> String<span style=color:#666>(</span>bytes<span style=color:#666>,</span> StandarCharsets<span style=color:#666>.</span><span style=color:#7d9029>UTF_8</span><span style=color:#666>);</span>
</span></span></code></pre></div><p>对于常见的字符集，建议使用 <code>StandardCharset</code> 枚举变量。这样可以避免拼写错误，例如 <code>Charset.forName(UTF 8)</code> 会抛出异常。</p><h3 id=reader>Reader
<a class=anchor href=#reader>#</a></h3><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>Reader in <span style=color:#666>=</span> <span style=color:green;font-weight:700>new</span> InputStreamReader<span style=color:#666>(</span>inStream<span style=color:#666>,</span> charset<span style=color:#666>);</span>
</span></span><span style=display:flex><span><span style=color:#b00040>int</span> ch <span style=color:#666>=</span> in<span style=color:#666>.</span><span style=color:#7d9029>read</span><span style=color:#666>();</span>  <span style=color:#408080;font-style:italic>// UTF-16 Code Unit
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>String content <span style=color:#666>=</span> <span style=color:green;font-weight:700>new</span> String<span style=color:#666>(</span>Files<span style=color:#666>.</span><span style=color:#7d9029>readAllBytes</span><span style=color:#666>(</span>path<span style=color:#666>),</span> charset<span style=color:#666>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#408080;font-style:italic>//throws UncheckedIOException
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>List<span style=color:#666>&lt;</span>String<span style=color:#666>&gt;</span> lines <span style=color:#666>=</span> Files<span style=color:#666>.</span><span style=color:#7d9029>readAllLines</span><span style=color:#666>(</span>path<span style=color:#666>,</span> charset<span style=color:#666>);</span>
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>try</span> <span style=color:#666>(</span>Stream<span style=color:#666>&lt;</span>String<span style=color:#666>&gt;</span> lines <span style=color:#666>=</span> Files<span style=color:#666>.</span><span style=color:#7d9029>lines</span><span style=color:#666>(</span>path<span style=color:#666>,</span> charset<span style=color:#666>))</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>    <span style=color:#666>...</span>
</span></span><span style=display:flex><span><span style=color:#666>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Scanner in <span style=color:#666>=</span> <span style=color:green;font-weight:700>new</span> Scanner<span style=color:#666>(</span>path<span style=color:#666>,</span> <span style=color:#ba2121>&#34;UTF-8&#34;</span><span style=color:#666>);</span>  <span style=color:#408080;font-style:italic>// a charset string
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>in<span style=color:#666>.</span><span style=color:#7d9029>useDelimiter</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;\\PL+&#34;</span><span style=color:#666>);</span>  <span style=color:#408080;font-style:italic>// regex
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#408080;font-style:italic>// read with buffer (by block)
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span><span style=color:green;font-weight:700>try</span> <span style=color:#666>(</span>BufferedReader reader <span style=color:#666>=</span> <span style=color:green;font-weight:700>new</span> BufferedReader<span style=color:#666>(</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>new</span> InpitStreamReader<span style=color:#666>(</span>url<span style=color:#666>.</span><span style=color:#7d9029>openStream</span><span style=color:#666>())))</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>    Stream<span style=color:#666>&lt;</span>String<span style=color:#666>&gt;</span> lines <span style=color:#666>=</span> reader<span style=color:#666>.</span><span style=color:#7d9029>lines</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span><span style=color:#666>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#408080;font-style:italic>// from file
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>Files<span style=color:#666>.</span><span style=color:#7d9029>newBufferedReader</span><span style=color:#666>(</span>path<span style=color:#666>,</span> charset<span style=color:#666>);</span>
</span></span></code></pre></div><h3 id=writer>Writer
<a class=anchor href=#writer>#</a></h3><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>Writer writer <span style=color:#666>=</span> <span style=color:green;font-weight:700>new</span> OutputStreamWriter<span style=color:#666>(</span>outStream<span style=color:#666>,</span> charset<span style=color:#666>);</span>
</span></span><span style=display:flex><span>writer<span style=color:#666>.</span><span style=color:#7d9029>write</span><span style=color:#666>(</span>str<span style=color:#666>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#408080;font-style:italic>// to file
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>Writer writer <span style=color:#666>=</span> Files<span style=color:#666>.</span><span style=color:#7d9029>newBufferedWriter</span><span style=color:#666>(</span>path<span style=color:#666>,</span> charset<span style=color:#666>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#408080;font-style:italic>// PrintWriter with println() and such
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>PrintWriter out <span style=color:#666>=</span> <span style=color:green;font-weight:700>new</span> printWriter<span style=color:#666>(</span>writer<span style=color:#666>);</span>
</span></span><span style=display:flex><span>PrintWriter out <span style=color:#666>=</span> <span style=color:green;font-weight:700>new</span> PrintWriter<span style=color:#666>(</span>outStream<span style=color:#666>,</span> <span style=color:#ba2121>&#34;UTF-8&#34;</span><span style=color:#666>);</span>  <span style=color:#408080;font-style:italic>// a charset string
</span></span></span></code></pre></div><p><code>System.out</code> 实际上是一个 <code>PrintStream</code> 对象，它和 <code>PrintWriter</code> 类具有类似的方法。</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>String content <span style=color:#666>=</span> <span style=color:#666>...;</span>
</span></span><span style=display:flex><span>Files<span style=color:#666>.</span><span style=color:#7d9029>write</span><span style=color:#666>(</span>path<span style=color:#666>,</span> content<span style=color:#666>.</span><span style=color:#7d9029>getBytes</span><span style=color:#666>(</span>charset<span style=color:#666>));</span>
</span></span><span style=display:flex><span><span style=color:#408080;font-style:italic>// here, lines is an Iterable&lt;? entends CharSequence&gt;
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>Files<span style=color:#666>.</span><span style=color:#7d9029>write</span><span style=color:#666>(</span>path<span style=color:#666>,</span> lines<span style=color:#666>,</span> charset<span style=color:#666>);</span>
</span></span><span style=display:flex><span><span style=color:#408080;font-style:italic>// similarly, append to a file:
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>Files<span style=color:#666>.</span><span style=color:#7d9029>write</span><span style=color:#666>(</span>path<span style=color:#666>,</span> content<span style=color:#666>.</span><span style=color:#7d9029>getBytes</span><span style=color:#666>(</span>charset<span style=color:#666>),</span> StandardOpenOption<span style=color:#666>.</span><span style=color:#7d9029>APPEND</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span><span style=color:#408080;font-style:italic>// for unsupported character in the charset, will be transfered as ? or \ufffd
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>
</span></span><span style=display:flex><span>StringWriter writer <span style=color:#666>=</span> <span style=color:green;font-weight:700>new</span> Strignwriter<span style=color:#666>();</span>
</span></span><span style=display:flex><span>throwable<span style=color:#666>.</span><span style=color:#7d9029>printStackTrace</span><span style=color:#666>(</span><span style=color:green;font-weight:700>new</span> PrinWriter<span style=color:#666>(</span>writer<span style=color:#666>));</span>
</span></span><span style=display:flex><span>Strin stackTrace <span style=color:#666>=</span> writer<span style=color:#666>.</span><span style=color:#7d9029>toString</span><span style=color:#666>();</span>
</span></span></code></pre></div><h2 id=读写二进制数据>读写二进制数据
<a class=anchor href=#%e8%af%bb%e5%86%99%e4%ba%8c%e8%bf%9b%e5%88%b6%e6%95%b0%e6%8d%ae>#</a></h2><ul><li><code>DataInput</code> 接口提供了一系列读取基本类型的方法，全部都是大端序的。<code>DataOutput</code> 情况类似。</li><li><code>readUTF</code> 和 <code>writeUTF</code> 是 JVM 的修改过的格式，不能直接用来输出 UTF-8。</li></ul><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>DataInput in <span style=color:#666>=</span> <span style=color:green;font-weight:700>new</span> DataInputStream<span style=color:#666>(</span>Files<span style=color:#666>.</span><span style=color:#7d9029>newInputStream</span><span style=color:#666>(</span>path<span style=color:#666>));</span>
</span></span><span style=display:flex><span>DataOutput out <span style=color:#666>=</span> <span style=color:green;font-weight:700>new</span> DataOutputStream<span style=color:#666>(</span>Files<span style=color:#666>.</span><span style=color:#7d9029>newOutputStream</span><span style=color:#666>(</span>path<span style=color:#666>));</span>
</span></span></code></pre></div><p><code>RandomAccessFile</code> 类支持对一个文件进行随机读写。第二个参数代表读写模式。</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>RandomAccessFile file <span style=color:#666>=</span> <span style=color:green;font-weight:700>new</span> RandomAccessFile<span style=color:#666>(</span>path<span style=color:#666>.</span><span style=color:#7d9029>toString</span><span style=color:#666>(),</span> <span style=color:#ba2121>&#34;rw&#34;</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span><span style=color:#408080;font-style:italic>// &#34;r&#34; for read only
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#b00040>int</span> value <span style=color:#666>=</span> file<span style=color:#666>.</span><span style=color:#7d9029>readInt</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>file<span style=color:#666>.</span><span style=color:#7d9029>seek</span><span style=color:#666>(</span>file<span style=color:#666>.</span><span style=color:#7d9029>getFilePointer</span><span style=color:#666>()</span> <span style=color:#666>-</span> 4<span style=color:#666>);</span>  <span style=color:#408080;font-style:italic>// move the ponter
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>file<span style=color:#666>.</span><span style=color:#7d9029>seek</span><span style=color:#666>(</span>file<span style=color:#666>.</span><span style=color:#7d9029>length</span><span style=color:#666>());</span>
</span></span><span style=display:flex><span>file<span style=color:#666>.</span><span style=color:#7d9029>writeInt</span><span style=color:#666>(</span>value <span style=color:#666>+</span> 1<span style=color:#666>);</span>
</span></span></code></pre></div><h2 id=内存映射文件>内存映射文件
<a class=anchor href=#%e5%86%85%e5%ad%98%e6%98%a0%e5%b0%84%e6%96%87%e4%bb%b6>#</a></h2><p>内存映射方式适合用来随机存取大文件，只将文件的一部分取到内存中。</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>FileChannel channel <span style=color:#666>=</span> FileChannel<span style=color:#666>.</span><span style=color:#7d9029>open</span><span style=color:#666>(</span>path<span style=color:#666>,</span>
</span></span><span style=display:flex><span>                                       StandardOpenOption<span style=color:#666>.</span><span style=color:#7d9029>READ</span><span style=color:#666>,</span>
</span></span><span style=display:flex><span>                                       StandardOpenOption<span style=color:#666>.</span><span style=color:#7d9029>WRITE</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>ByteBuffer buffer <span style=color:#666>=</span> channel<span style=color:#666>.</span><span style=color:#7d9029>map</span><span style=color:#666>(</span>FileChannel<span style=color:#666>.</span><span style=color:#7d9029>MapMode</span><span style=color:#666>.</span><span style=color:#7d9029>READ_WRITE</span><span style=color:#666>,</span>
</span></span><span style=display:flex><span>                                0<span style=color:#666>,</span> channel<span style=color:#666>.</span><span style=color:#7d9029>size</span><span style=color:#666>());</span>
</span></span><span style=display:flex><span><span style=color:#b00040>int</span> offset <span style=color:#666>=</span> <span style=color:#666>...;</span>
</span></span><span style=display:flex><span><span style=color:#b00040>int</span> value <span style=color:#666>=</span> buffer<span style=color:#666>.</span><span style=color:#7d9029>getInt</span><span style=color:#666>(</span>offset<span style=color:#666>);</span>
</span></span><span style=display:flex><span>buffer<span style=color:#666>.</span><span style=color:#7d9029>put</span><span style=color:#666>(</span>offset<span style=color:#666>,</span> value <span style=color:#666>+</span> 1<span style=color:#666>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>buffer<span style=color:#666>.</span><span style=color:#7d9029>order</span><span style=color:#666>(</span>ByteOrder<span style=color:#666>.</span><span style=color:#7d9029>LITTLE_ENDIAN</span><span style=color:#666>);</span>
</span></span></code></pre></div><p>通道关闭时，更改会被写回文件。</p><h2 id=文件锁>文件锁
<a class=anchor href=#%e6%96%87%e4%bb%b6%e9%94%81>#</a></h2><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>FileChannel channel <span style=color:#666>=</span> FileChannel<span style=color:#666>.</span><span style=color:#7d9029>open</span><span style=color:#666>(</span>path<span style=color:#666>);</span>
</span></span><span style=display:flex><span>FileLock lock <span style=color:#666>=</span> channel<span style=color:#666>.</span><span style=color:#7d9029>lock</span><span style=color:#666>();</span>  <span style=color:#408080;font-style:italic>// 阻塞，直到被放开，然后被当前线程锁住
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>
</span></span><span style=display:flex><span>FileLock lock <span style=color:#666>=</span> channel<span style=color:#666>.</span><span style=color:#7d9029>tryLock</span><span style=color:#666>();</span>  <span style=color:#408080;font-style:italic>// 如果被锁，返回 null
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>try</span> <span style=color:#666>(</span>FileLock lock <span style=color:#666>=</span> channel<span style=color:#666>.</span><span style=color:#7d9029>lock</span><span style=color:#666>())</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>    <span style=color:#666>...</span>
</span></span><span style=display:flex><span><span style=color:#666>}</span>
</span></span></code></pre></div><p>在锁或通道关闭后，其他线程就可以访问同一文件。</p><h1 id=路径和文件>路径和文件
<a class=anchor href=#%e8%b7%af%e5%be%84%e5%92%8c%e6%96%87%e4%bb%b6>#</a></h1><h2 id=使用-path-类>使用 Path 类
<a class=anchor href=#%e4%bd%bf%e7%94%a8-path-%e7%b1%bb>#</a></h2><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>Path homeFolder <span style=color:#666>=</span> Paths<span style=color:#666>.</span><span style=color:#7d9029>get</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;/home/xxx&#34;</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Path picFolder <span style=color:#666>=</span> homefolder<span style=color:#666>.</span><span style=color:#7d9029>resolve</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;pic&#34;</span><span style=color:#666>);</span>  <span style=color:#408080;font-style:italic>// relative path
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>Path picFolder <span style=color:#666>=</span> homefolder<span style=color:#666>.</span><span style=color:#7d9029>resolve</span><span style=color:#666>(</span>Path<span style=color:#666>.</span><span style=color:#7d9029>get</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;pic&#34;</span><span style=color:#666>));</span>  <span style=color:#408080;font-style:italic>// relative path
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>Path musicFolder <span style=color:#666>=</span> picFolder<span style=color:#666>.</span><span style=color:#7d9029>resolveSibing</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;music&#34;</span><span style=color:#666>);</span>  <span style=color:#408080;font-style:italic>// to /home/xxx/music
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>
</span></span><span style=display:flex><span>Paths<span style=color:#666>.</span><span style=color:#7d9029>get</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;/home/cay&#34;</span><span style=color:#666>).</span><span style=color:#7d9029>relativize</span><span style=color:#666>(</span>Paths<span style=color:#666>.</span><span style=color:#7d9029>get</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;/home/fred/app&#34;</span><span style=color:#666>));</span>  <span style=color:#408080;font-style:italic>// get ../fred/app
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>
</span></span><span style=display:flex><span>path<span style=color:#666>.</span><span style=color:#7d9029>normalize</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>path<span style=color:#666>.</span><span style=color:#7d9029>toAbsolutePath</span><span style=color:#666>();</span>  <span style=color:#408080;font-style:italic>// with application working folder
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>path<span style=color:#666>.</span><span style=color:#7d9029>getParent</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>path<span style=color:#666>.</span><span style=color:#7d9029>getFileName</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>path<span style=color:#666>.</span><span style=color:#7d9029>getRoot</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>path<span style=color:#666>.</span><span style=color:#7d9029>getName</span><span style=color:#666>(</span>0<span style=color:#666>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>path<span style=color:#666>.</span><span style=color:#7d9029>subpath</span><span style=color:#666>(</span>1<span style=color:#666>,</span> p<span style=color:#666>.</span><span style=color:#7d9029>getNameCount</span><span style=color:#666>());</span>
</span></span><span style=display:flex><span><span style=color:#408080;font-style:italic>// @param: (start, length). here get all files but the first
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>for</span> <span style=color:#666>(</span>Path p <span style=color:#666>:</span> path<span style=color:#666>)</span> <span style=color:#666>{</span>  <span style=color:#408080;font-style:italic>// Iterable&lt;Path&gt;
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>    <span style=color:#666>...</span>
</span></span><span style=display:flex><span><span style=color:#666>}</span>
</span></span></code></pre></div><h2 id=文件和目录>文件和目录
<a class=anchor href=#%e6%96%87%e4%bb%b6%e5%92%8c%e7%9b%ae%e5%bd%95>#</a></h2><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>Files<span style=color:#666>.</span><span style=color:#7d9029>createDirectory</span><span style=color:#666>(</span>path<span style=color:#666>);</span>
</span></span><span style=display:flex><span>Files<span style=color:#666>.</span><span style=color:#7d9029>createDirectories</span><span style=color:#666>(</span>path<span style=color:#666>);</span>
</span></span><span style=display:flex><span>Files<span style=color:#666>.</span><span style=color:#7d9029>createFile</span><span style=color:#666>(</span>path<span style=color:#666>);</span>  <span style=color:#408080;font-style:italic>// throws exception if exist
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>Files<span style=color:#666>.</span><span style=color:#7d9029>exists</span><span style=color:#666>(</span>path<span style=color:#666>);</span>  <span style=color:#408080;font-style:italic>// create an check exist are atom oparation in java
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>Files<span style=color:#666>.</span><span style=color:#7d9029>isDirectory</span><span style=color:#666>(</span>path<span style=color:#666>);</span>
</span></span><span style=display:flex><span>Files<span style=color:#666>.</span><span style=color:#7d9029>isRegularFile</span><span style=color:#666>(</span>path<span style=color:#666>);</span>  <span style=color:#408080;font-style:italic>// rather than symlink and such
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#408080;font-style:italic>// system temp
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>Files<span style=color:#666>.</span><span style=color:#7d9029>createTempFile</span><span style=color:#666>(</span>dir<span style=color:#666>,</span> prefix<span style=color:#666>,</span> suffix<span style=color:#666>);</span>
</span></span><span style=display:flex><span>Files<span style=color:#666>.</span><span style=color:#7d9029>createTempFile</span><span style=color:#666>(</span>prefix<span style=color:#666>,</span> suffix<span style=color:#666>);</span>
</span></span><span style=display:flex><span>Files<span style=color:#666>.</span><span style=color:#7d9029>createTempDirectory</span><span style=color:#666>(</span>dir<span style=color:#666>,</span> prefix<span style=color:#666>);</span>
</span></span><span style=display:flex><span>Files<span style=color:#666>.</span><span style=color:#7d9029>createTempDirectory</span><span style=color:#666>(</span>prefix<span style=color:#666>);</span>
</span></span><span style=display:flex><span><span style=color:#408080;font-style:italic>//for example, createTempFile(null, &#34;.txt&#34;) may get /tmp/1231.txt
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>
</span></span><span style=display:flex><span>Files<span style=color:#666>.</span><span style=color:#7d9029>copy</span><span style=color:#666>(</span>fromPath<span style=color:#666>,</span> toPath<span style=color:#666>);</span>
</span></span><span style=display:flex><span>Files<span style=color:#666>.</span><span style=color:#7d9029>move</span><span style=color:#666>(</span>fromPath<span style=color:#666>,</span> toPath<span style=color:#666>);</span>
</span></span><span style=display:flex><span><span style=color:#408080;font-style:italic>//if want to replace
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>Files<span style=color:#666>.</span><span style=color:#7d9029>copy</span><span style=color:#666>(</span>fromPath<span style=color:#666>,</span> toPath<span style=color:#666>,</span> StandardCopyOption<span style=color:#666>.</span><span style=color:#7d9029>REPLACE_EXISTING</span><span style=color:#666>,</span>
</span></span><span style=display:flex><span>           StandardCopyOption<span style=color:#666>.</span><span style=color:#7d9029>COPY_ATTRIBUTES</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>Files<span style=color:#666>.</span><span style=color:#7d9029>mvoe</span><span style=color:#666>(</span>fromPath<span style=color:#666>,</span> toPath<span style=color:#666>,</span> StandardCopyOption<span style=color:#666>.</span><span style=color:#7d9029>ATOMIC_MOVE</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Files<span style=color:#666>.</span><span style=color:#7d9029>delete</span><span style=color:#666>(</span>path<span style=color:#666>);</span>  <span style=color:#408080;font-style:italic>// throws Exception if not exist
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span><span style=color:#b00040>boolean</span> deleted <span style=color:#666>=</span> Files<span style=color:#666>.</span><span style=color:#7d9029>deleteIfExists</span><span style=color:#666>(</span>path<span style=color:#666>);</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:green;font-weight:700>try</span> <span style=color:#666>(</span>Stream<span style=color:#666>&lt;</span>Path<span style=color:#666>&gt;</span> entries <span style=color:#666>=</span> Files<span style=color:#666>.</span><span style=color:#7d9029>list</span><span style=color:#666>(</span>path<span style=color:#666>))</span> <span style=color:#666>{</span>  <span style=color:#408080;font-style:italic>// deal with subs
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>    <span style=color:#666>...</span>
</span></span><span style=display:flex><span><span style=color:#666>}</span>
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>try</span> <span style=color:#666>(</span>Stream<span style=color:#666>&lt;</span>Path<span style=color:#666>&gt;</span> entries <span style=color:#666>=</span> Files<span style=color:#666>.</span><span style=color:#7d9029>walk</span><span style=color:#666>(</span>path<span style=color:#666>))</span> <span style=color:#666>{</span>  <span style=color:#408080;font-style:italic>// recurrsively, DFS
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>    <span style=color:#666>...</span>
</span></span><span style=display:flex><span><span style=color:#666>}</span>
</span></span><span style=display:flex><span>Files<span style=color:#666>.</span><span style=color:#7d9029>walk</span><span style=color:#666>(</span>path<span style=color:#666>,</span> depth<span style=color:#666>,</span> FileVisitOption<span style=color:#666>.</span><span style=color:#7d9029>FOLLOW_LINKS</span><span style=color:#666>);</span>  <span style=color:#408080;font-style:italic>// follow symlinks
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>Files<span style=color:#666>.</span><span style=color:#7d9029>walk</span><span style=color:#666>(</span>path<span style=color:#666>,</span> depth<span style=color:#666>,</span> <span style=color:#666>(</span>path<span style=color:#666>,</span> basicFileAttribute<span style=color:#666>)</span> <span style=color:#666>-&gt;</span> <span style=color:#666>...);</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>FileSystem zipfs <span style=color:#666>=</span> FileSystems<span style=color:#666>.</span><span style=color:#7d9029>newFileSystem</span><span style=color:#666>(</span>Paths<span style=color:#666>.</span><span style=color:#7d9029>get</span><span style=color:#666>(</span>zipname<span style=color:#666>),</span> <span style=color:green;font-weight:700>null</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>zipfs<span style=color:#666>.</span><span style=color:#7d9029>get</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;path_in_zip&#34;</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>URI uri <span style=color:#666>=</span> <span style=color:green;font-weight:700>new</span> URI<span style=color:#666>(</span><span style=color:#ba2121>&#34;jar&#34;</span><span style=color:#666>,</span> zipPath<span style=color:#666>.</span><span style=color:#7d9029>toUri</span><span style=color:#666>().</span><span style=color:#7d9029>toString</span><span style=color:#666>(),</span> <span style=color:green;font-weight:700>null</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span><span style=color:#408080;font-style:italic>// file://myfile.zip
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span><span style=color:green;font-weight:700>try</span> <span style=color:#666>(</span>FileSystem zipfs <span style=color:#666>=</span> FileSystems<span style=color:#666>.</span><span style=color:#7d9029>newFileSystem</span><span style=color:#666>(</span>
</span></span><span style=display:flex><span>    uri<span style=color:#666>,</span> Collections<span style=color:#666>.</span><span style=color:#7d9029>singletonMap</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;create&#34;</span><span style=color:#666>.</span> <span style=color:#ba2121>&#34;true&#34;</span><span style=color:#666>)))</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>    Files<span style=color:#666>.</span><span style=color:#7d9029>copy</span><span style=color:#666>(</span>sourcePath<span style=color:#666>,</span> zipfs<span style=color:#666>.</span><span style=color:#7d9029>getPath</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;/&#34;</span><span style=color:#666>).</span><span style=color:#7d9029>resolve</span><span style=color:#666>(</span>targetPath<span style=color:#666>))</span>
</span></span><span style=display:flex><span><span style=color:#666>}</span>  <span style=color:#408080;font-style:italic>// save to an zip
</span></span></span></code></pre></div><h1 id=url-连接>URL 连接
<a class=anchor href=#url-%e8%bf%9e%e6%8e%a5>#</a></h1><p>如果我们有一个资源的 URL，可以直接从 URL 打开：</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>InputStream in <span style=color:#666>=</span> <span style=color:green;font-weight:700>new</span> URL<span style=color:#666>(</span><span style=color:#ba2121>&#34;http://xxx&#34;</span><span style=color:#666>).</span><span style=color:#7d9029>openStream</span><span style=color:#666>();</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>URLConnection conn <span style=color:#666>=</span> url<span style=color:#666>.</span><span style=color:#7d9029>openConnnection</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>conn<span style=color:#666>.</span><span style=color:#7d9029>setRequestProperty</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;Accept-Charset&#34;</span><span style=color:#666>.</span> <span style=color:#ba2121>&#34;UTF-8, GBK&#34;</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>conn<span style=color:#666>.</span><span style=color:#7d9029>setDoOutput</span><span style=color:#666>(</span><span style=color:green;font-weight:700>true</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>try</span> <span style=color:#666>(</span>OutputStream out <span style=color:#666>=</span> conn<span style=color:#666>.</span><span style=color:#7d9029>getOutputStream</span><span style=color:#666>())</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>    <span style=color:#408080;font-style:italic>// write to out
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span><span style=color:#666>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>conn<span style=color:#666>.</span><span style=color:#7d9029>connect</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>Map<span style=color:#666>&lt;</span>String List<span style=color:#666>&lt;</span>String<span style=color:#666>&gt;&gt;</span> headers <span style=color:#666>=</span> conn<span style=color:#666>.</span><span style=color:#7d9029>getHeaderFields</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>try</span> <span style=color:#666>(</span>InputStream in <span style=color:#666>=</span> conn<span style=color:#666>.</span><span style=color:#7d9029>getInputStream</span><span style=color:#666>())</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>    <span style=color:#408080;font-style:italic>// read from in
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span><span style=color:#666>}</span>
</span></span></code></pre></div><h1 id=正则表达式>正则表达式
<a class=anchor href=#%e6%ad%a3%e5%88%99%e8%a1%a8%e8%be%be%e5%bc%8f>#</a></h1><h2 id=匹配和提取>匹配和提取
<a class=anchor href=#%e5%8c%b9%e9%85%8d%e5%92%8c%e6%8f%90%e5%8f%96>#</a></h2><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#408080;font-style:italic>// match one
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>String regex <span style=color:#666>=</span> <span style=color:#ba2121>&#34;&#34;</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span>CharSequence input <span style=color:#666>=</span> <span style=color:#666>...;</span>
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>Pattern<span style=color:#666>.</span><span style=color:#7d9029>matches</span><span style=color:#666>(</span>regex<span style=color:#666>,</span> input<span style=color:#666>))</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>    <span style=color:#666>...</span>
</span></span><span style=display:flex><span><span style=color:#666>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#408080;font-style:italic>// precompile and match much
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>Pattern pattern <span style=color:#666>=</span> Pattern<span style=color:#666>.</span><span style=color:#7d9029>compile</span><span style=color:#666>(</span>regex<span style=color:#666>);</span>
</span></span><span style=display:flex><span>Matcher matcher <span style=color:#666>=</span> pattern<span style=color:#666>.</span><span style=color:#7d9029>matcher</span><span style=color:#666>(</span>input<span style=color:#666>);</span>
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>matcher<span style=color:#666>.</span><span style=color:#7d9029>matches</span><span style=color:#666>())</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>    <span style=color:#666>...</span>
</span></span><span style=display:flex><span><span style=color:#666>}</span>
</span></span><span style=display:flex><span>strs<span style=color:#666>.</span><span style=color:#7d9029>filter</span><span style=color:#666>(</span>pattern<span style=color:#666>.</span><span style=color:#7d9029>asPredicate</span><span style=color:#666>());</span>  <span style=color:#408080;font-style:italic>// all that matches
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#408080;font-style:italic>// find all match patterns in a string, one at once
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span><span style=color:green;font-weight:700>while</span> <span style=color:#666>(</span>matcher<span style=color:#666>.</span><span style=color:#7d9029>find</span><span style=color:#666>())</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>    String match <span style=color:#666>=</span> matcher<span style=color:#666>.</span><span style=color:#7d9029>group</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span><span style=color:#666>}</span>
</span></span></code></pre></div><p>也可以按照下标提取匹配子串。例如，对于字符串 :</p><blockquote><p>Blackwell Toaster USD29.95</p></blockquote><p>使用正则表达式，其中 <code>Alnum</code> 表示 字母和数字：</p><pre tabindex=0><code class=language-regex data-lang=regex>(\p{Alnum}+(\s+\p{Alnum}+)*)\s+([A-Z]{3})([0-9.]*)
</code></pre><p>于是可以使用：</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>matcher<span style=color:#666>.</span><span style=color:#7d9029>matches</span><span style=color:#666>())</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>    item <span style=color:#666>=</span> matcher<span style=color:#666>.</span><span style=color:#7d9029>group</span><span style=color:#666>(</span>1<span style=color:#666>);</span>
</span></span><span style=display:flex><span>    currency <span style=color:#666>=</span> matcher<span style=color:#666>.</span><span style=color:#7d9029>group</span><span style=color:#666>(</span>3<span style=color:#666>);</span>
</span></span><span style=display:flex><span>    price <span style=color:#666>=</span> matcher<span style=color:#666>.</span><span style=color:#7d9029>group</span><span style=color:#666>(</span>4<span style=color:#666>);</span>
</span></span><span style=display:flex><span><span style=color:#666>}</span>
</span></span></code></pre></div><p>这里的下标从 1 开始。0 下标表示整个字符串。group 按照左小括号分组。因此，四个 group 分别为：</p><p><code>plain text 0: Blackwell Toaster USD29.95 1: Blackwell Toaster 2: Toaster 3: USD 4: 29.95</code></p><p>在这里我们不需要第二个匹配。因此，可以把这个匹配忽略：</p><pre tabindex=0><code class=language-regex data-lang=regex>(\p{Alnum}+(?:\s+\p{Alnum}+)*)\s+([A-Z]{3})([0-9.]*)
</code></pre><p>或者，为每个匹配命名：</p><pre tabindex=0><code class=language-regex data-lang=regex>(?&lt;item&gt;\p{Alnum}+(?:\s+\p{Alnum}+)*)\s+(?&lt;currency&gt;[A-Z]{3})(?&lt;price&gt;[0-9.]*)
</code></pre><p>然后，在 Java 代码中：</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>matcher<span style=color:#666>.</span><span style=color:#7d9029>matches</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>item <span style=color:#666>=</span> matcher<span style=color:#666>.</span><span style=color:#7d9029>group</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;item&#34;</span><span style=color:#666>);</span>
</span></span></code></pre></div><h2 id=处理>处理
<a class=anchor href=#%e5%a4%84%e7%90%86>#</a></h2><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>Pattern commas <span style=color:#666>=</span> Pattern<span style=color:#666>.</span><span style=color:#7d9029>compile</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;\\s*,\\s*&#34;</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>String input <span style=color:#666>=</span> <span style=color:#ba2121>&#34;1, 2, 3&#34;</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#408080;font-style:italic>// split
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>String<span style=color:#666>[]</span> tokens <span style=color:#666>=</span> commas<span style=color:#666>.</span><span style=color:#7d9029>split</span><span style=color:#666>(</span>input<span style=color:#666>);</span>  <span style=color:#408080;font-style:italic>// get [&#34;1&#34;, &#34;2&#34;, &#34;3&#34;]
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>Stream<span style=color:#666>&lt;</span>String<span style=color:#666>&gt;</span> tokens <span style=color:#666>=</span> commas<span style=color:#666>.</span><span style=color:#7d9029>splitAsStream</span><span style=color:#666>(</span>input<span style=color:#666>);</span>  <span style=color:#408080;font-style:italic>// stream
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>String<span style=color:#666>[]</span> tokens <span style=color:#666>=</span> input<span style=color:#666>.</span><span style=color:#7d9029>split</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;\\s*,\\s*&#34;</span><span style=color:#666>);</span>  <span style=color:#408080;font-style:italic>// no compile
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#408080;font-style:italic>// replace
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>matcher<span style=color:#666>.</span><span style=color:#7d9029>replaceAll</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;,&#34;</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>input<span style=color:#666>.</span><span style=color:#7d9029>replaceAll</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;\\s*,\\s*&#34;</span><span style=color:#666>,</span> <span style=color:#ba2121>&#34;,&#34;</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span><span style=color:#ba2121>&#34;3:45&#34;</span><span style=color:#666>.</span><span style=color:#7d9029>replaceAll</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;(\\d{1,2}):(?&lt;minutes&gt;)\\d{2}&#34;</span><span style=color:#666>,</span>
</span></span><span style=display:flex><span>                  <span style=color:#ba2121>&#34;$1 hours and ${minutes} minutes&#34;</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span><span style=color:#408080;font-style:italic>// $num or ${match name}
</span></span></span></code></pre></div><h2 id=正则表达式标记>正则表达式标记
<a class=anchor href=#%e6%ad%a3%e5%88%99%e8%a1%a8%e8%be%be%e5%bc%8f%e6%a0%87%e8%ae%b0>#</a></h2><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>Pattern pattern <span style=color:#666>=</span> Pattern<span style=color:#666>.</span><span style=color:#7d9029>compile</span><span style=color:#666>(</span>regex<span style=color:#666>,</span> Pattern<span style=color:#666>.</span><span style=color:#7d9029>CASE_INSENSITIVE</span> <span style=color:#666>|</span> Pattern<span style=color:#666>.</span><span style=color:#7d9029>UNICODE_CHARACTER_CLASS</span><span style=color:#666>);</span>  <span style=color:#408080;font-style:italic>// integers, bit operation
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#408080;font-style:italic>// or, in regex string:
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>String regex <span style=color:#666>=</span> <span style=color:#ba2121>&#34;(?iU:expression)&#34;</span><span style=color:#666>;</span>
</span></span></code></pre></div><h1 id=序列化>序列化
<a class=anchor href=#%e5%ba%8f%e5%88%97%e5%8c%96>#</a></h1><h2 id=serializable>Serializable
<a class=anchor href=#serializable>#</a></h2><p><code>Serializable</code> 是一个标记接口，没有方法。如果对象中所有的成员都是基本类型、枚举或其他 <code>Serializable</code> 对象，那么对这个对象进行序列化就是安全的。对于数组和集合，如果他们存储的对象是可序列化的，那么它们就也是可序列化的。</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>ObjectOutputStream out <span style=color:#666>=</span> <span style=color:green;font-weight:700>new</span> ObjectOutputStream<span style=color:#666>(</span>Files<span style=color:#666>.</span><span style=color:#7d9029>newOutputStream</span><span style=color:#666>(</span>path<span style=color:#666>));</span>
</span></span><span style=display:flex><span>out<span style=color:#666>.</span><span style=color:#7d9029>writeObject</span><span style=color:#666>(</span>obj<span style=color:#666>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ObjectInputStream in <span style=color:#666>=</span> <span style=color:green;font-weight:700>new</span> ObjectInputStream<span style=color:#666>(</span>Files<span style=color:#666>.</span><span style=color:#7d9029>newInputStream</span><span style=color:#666>(</span>path<span style=color:#666>));</span>
</span></span><span style=display:flex><span>Employee e <span style=color:#666>=</span> <span style=color:#666>(</span>Employee<span style=color:#666>)</span> in<span style=color:#666>.</span><span style=color:#7d9029>readObject</span><span style=color:#666>();</span>
</span></span></code></pre></div><p>在序列化的过程中，对于基本类型，直接以二进制方式写入。对于对象，则会递归地使用 <code>writeObject</code>。Java 会为每一个对象保持一个序列号。这样，如果两个对象引用同一个对象，那么重复的对象就可以只存储一次。</p><p>打上 <code>transient</code>（瞬态）标记的变量不会被序列化。通常是缓存等类型的数据。</p><p><strong>反序列化得到的对象并不会被构造，而是直接从对象流读取进来。</strong></p><h2 id=继承与序列化>继承与序列化
<a class=anchor href=#%e7%bb%a7%e6%89%bf%e4%b8%8e%e5%ba%8f%e5%88%97%e5%8c%96>#</a></h2><p>考虑这样一个情况：父类没实现 <code>Serializable</code> 接口，而子类实现了。那么，父类的实例变量就不会被序列化。</p><p>于是，当我们反序列化一个子类对象时，Java 选择的办法只能是使用默认的无参构造函数构造一个父类对象（因为子类的构造函数也没有被调用）。如果父类没有无参构造方法，就会抛出异常。对于这种情况，我们还有一些其他的解决办法。</p><h2 id=重写-writeobject-和-readobject>重写 writeObject 和 readObject
<a class=anchor href=#%e9%87%8d%e5%86%99-writeobject-%e5%92%8c-readobject>#</a></h2><p>这两个方法非常特殊：它们并不是存在于 <code>Serializable</code> 接口中。甚至，它们是 <code>private</code> 的。事实上，Java 通过反射方式来寻找这两个方法。</p><p>例如，JavaFX 中的 <code>Point2D</code> 类是不可序列化的。假设我们实现了一个 <code>LabeledPoint</code> 类，其中包含一个 <code>String</code> 和一个 <code>Point2D</code>，并要将其序列化：</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:green;font-weight:700>class</span> <span style=color:#00f;font-weight:700>LabeledPoint</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>private</span> String label<span style=color:#666>;</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>private</span> <span style=color:green;font-weight:700>transient</span> Point2D point<span style=color:#666>;</span>  <span style=color:#408080;font-style:italic>// transient, to prevent NotSerializableException
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>    <span style=color:green;font-weight:700>private</span> <span style=color:#b00040>void</span> <span style=color:#00f>writeObject</span><span style=color:#666>(</span>ObjectOutputStream out<span style=color:#666>)</span> <span style=color:green;font-weight:700>throws</span> IOException <span style=color:#666>{</span>
</span></span><span style=display:flex><span>        out<span style=color:#666>.</span><span style=color:#7d9029>defaultWriteObject</span><span style=color:#666>();</span>  <span style=color:#408080;font-style:italic>// normally serialize this obj and label
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>        out<span style=color:#666>.</span><span style=color:#7d9029>writeDouble</span><span style=color:#666>(</span>point<span style=color:#666>.</span><span style=color:#7d9029>getX</span><span style=color:#666>());</span>
</span></span><span style=display:flex><span>        out<span style=color:#666>.</span><span style=color:#7d9029>writeDouble</span><span style=color:#666>(</span>point<span style=color:#666>.</span><span style=color:#7d9029>getY</span><span style=color:#666>());</span>
</span></span><span style=display:flex><span>    <span style=color:#666>}</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>private</span> <span style=color:#b00040>void</span> <span style=color:#00f>readObject</span><span style=color:#666>(</span>ObjectInputStream in<span style=color:#666>)</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>throws</span> IOException<span style=color:#666>,</span> ClassNotFoundException <span style=color:#666>{</span>
</span></span><span style=display:flex><span>        in<span style=color:#666>.</span><span style=color:#7d9029>defaultReadObject</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>        <span style=color:#b00040>double</span> x <span style=color:#666>=</span> in<span style=color:#666>.</span><span style=color:#7d9029>readDouble</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>        <span style=color:#b00040>double</span> y <span style=color:#666>=</span> in<span style=color:#666>.</span><span style=color:#7d9029>readDouble</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>        point <span style=color:#666>=</span> <span style=color:green;font-weight:700>new</span> Point2D<span style=color:#666>(</span>x<span style=color:#666>,</span> y<span style=color:#666>);</span>
</span></span><span style=display:flex><span>    <span style=color:#666>}</span>
</span></span><span style=display:flex><span><span style=color:#666>}</span>
</span></span></code></pre></div><p>这里的两个方法只应该访问自己的变量，而不能访问父类的变量。显然，那些应该被放在父类的方法里。</p><p>另外，还有 <code>Externalizable</code> 接口提供两个方法可以用来自定义序列化格式。和 <code>Serializable</code> 不同，这个接口提供的流程是先使用无参构造函数构造，再调用接口方法来读取变量数据。</p><h2 id=readresolve-和-writereplace>readResolve 和 writeReplace
<a class=anchor href=#readresolve-%e5%92%8c-writereplace>#</a></h2><p>前面说到，反序列化的对象没有被构造。这会带来一些问题。例如，传统的单例模式，只允许构造方法调用一次。以前用来模拟枚举类型的方法以及一些数据库连接池也类似。不过现在，枚举类型的序列化已经自动化，你也可以使用枚举来构建单例模式：</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:green;font-weight:700>public</span> <span style=color:green;font-weight:700>enum</span> PersonDB <span style=color:#666>{</span>
</span></span><span style=display:flex><span>    INSTANCE<span style=color:#666>;</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>public</span> Person <span style=color:#00f>findByID</span><span style=color:#666>(</span><span style=color:#b00040>int</span> id<span style=color:#666>)</span> <span style=color:#666>{</span> <span style=color:#666>...</span> <span style=color:#666>}</span>
</span></span><span style=display:flex><span><span style=color:#666>}</span>
</span></span></code></pre></div><p>虽然已经不常见，我们仍然需要处理这一类的问题。</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:green;font-weight:700>public</span> <span style=color:green;font-weight:700>class</span> <span style=color:#00f;font-weight:700>Person</span> <span style=color:green;font-weight:700>implements</span> Serializable <span style=color:#666>{</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>private</span> <span style=color:#b00040>int</span> id<span style=color:#666>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    priavte Object <span style=color:#00f>writeReplace</span><span style=color:#666>()</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>return</span> <span style=color:green;font-weight:700>new</span> PersonProxy<span style=color:#666>(</span>id<span style=color:#666>);</span>
</span></span><span style=display:flex><span>    <span style=color:#666>}</span>
</span></span><span style=display:flex><span><span style=color:#666>}</span>
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>public</span> <span style=color:green;font-weight:700>class</span> <span style=color:#00f;font-weight:700>PersonProxy</span> <span style=color:green;font-weight:700>implements</span> Serializable <span style=color:#666>{</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>private</span> <span style=color:#b00040>int</span> id<span style=color:#666>;</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>public</span> <span style=color:#00f>PersonProxy</span><span style=color:#666>(</span><span style=color:#b00040>int</span> id<span style=color:#666>)</span> <span style=color:#666>{</span> <span style=color:green;font-weight:700>this</span><span style=color:#666>.</span><span style=color:#7d9029>id</span> <span style=color:#666>=</span> id<span style=color:#666>;</span> <span style=color:#666>}</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>public</span> Object <span style=color:#00f>readResolve</span><span style=color:#666>()</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>return</span> PersonDB<span style=color:#666>.</span><span style=color:#7d9029>INSTANCE</span><span style=color:#666>.</span><span style=color:#7d9029>findById</span><span style=color:#666>(</span>id<span style=color:#666>);</span>
</span></span><span style=display:flex><span>    <span style=color:#666>}</span>
</span></span><span style=display:flex><span><span style=color:#666>}</span>
</span></span></code></pre></div><p>这样，当 <code>Person</code> 被序列化时，实际上被序列化的将会是 <code>writeReplace</code> 的返回值，即一个 <code>PersonProxy</code> 对象。然后，当我们从对象流中读取一个 <code>PersonProxy</code> 对象时，其 <code>readResolve</code> 方法将会被调用，最终恢复出来的将是其返回值，即一个 <code>Person</code> 对象。这样做的最终结果是，我们只序列化了 <code>id</code>，在读取时，通过 <code>id</code> 从数据库中将其他属性读取出来，成为我们最终需要的 <code>Person</code> 对象。</p><h2 id=版本化>版本化
<a class=anchor href=#%e7%89%88%e6%9c%ac%e5%8c%96>#</a></h2><p>在对象中定义一个常量：</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:green;font-weight:700>private</span> <span style=color:green;font-weight:700>static</span> <span style=color:green;font-weight:700>final</span> <span style=color:#b00040>long</span> serialVersionUID <span style=color:#666>=</span> 1L<span style=color:#666>;</span>
</span></span></code></pre></div><p>每当类实现的新版本产生了不兼容时，就改变这个值。这样，在试图将旧版的序列转换为新版的对象时，就会抛出 <code>InvalidClassException</code> 异常。</p><p>如果 UID 没有改变，却增加了新的实例变量，那么对象引用会被声明为 null，基本类型声明为 0。</p><p>如果没有定义 UID 常量，系统会在序列化时根据实例变量、方法和父类的信息自动生成一个 hash 值作为版本 UID。可以用命令行的 <code>serialver</code> 工具来查看这个值。显然，如果之前忘记定义这个值，同时希望新版本兼容旧版序列化，那么直接把 <code>serialver com.test.Clazz</code> 得到的结果写入 <code>serialVersionUID</code> 常量即可。</p></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(n){const e=window.getSelection(),t=document.createRange();t.selectNodeContents(n),e.removeAllRanges(),e.addRange(t)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#io-流>IO 流</a><ul><li><a href=#创建和使用字节流>创建和使用字节流</a></li><li><a href=#处理字符流>处理字符流</a><ul><li><a href=#编码大小端序和-bom>编码，大小端序和 BOM</a></li><li><a href=#reader>Reader</a></li><li><a href=#writer>Writer</a></li></ul></li><li><a href=#读写二进制数据>读写二进制数据</a></li><li><a href=#内存映射文件>内存映射文件</a></li><li><a href=#文件锁>文件锁</a></li></ul></li><li><a href=#路径和文件>路径和文件</a><ul><li><a href=#使用-path-类>使用 Path 类</a></li><li><a href=#文件和目录>文件和目录</a></li></ul></li><li><a href=#url-连接>URL 连接</a></li><li><a href=#正则表达式>正则表达式</a><ul><li><a href=#匹配和提取>匹配和提取</a></li><li><a href=#处理>处理</a></li><li><a href=#正则表达式标记>正则表达式标记</a></li></ul></li><li><a href=#序列化>序列化</a><ul><li><a href=#serializable>Serializable</a></li><li><a href=#继承与序列化>继承与序列化</a></li><li><a href=#重写-writeobject-和-readobject>重写 writeObject 和 readObject</a></li><li><a href=#readresolve-和-writereplace>readResolve 和 writeReplace</a></li><li><a href=#版本化>版本化</a></li></ul></li></ul></nav></div></aside></main></body></html>