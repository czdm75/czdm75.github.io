<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="注解 #  注解元素 #  @Test(timeout=10000)  @BugReport(showStopper=true,  assignedTo=&#34;Harry&#34;,  testCase=CacheTest.class,  status=BugReport.Status.COMFIRMED  )  @SuppressWarnings(&#34;unchecked&#34;) // only one parameter, equals @SuppressWarnings(value=&#34;unchecked&#34;)  @BugReport(reportedBy={&#34;harry&#34;, &#34;fred&#34;}) // array of above  @BugReport(ref=@Reference(id=1123)) // another annotation 注解元素可以是：
 基本类型 String class 对象 enum 实例 注解 这些元素的一维数组  元素可以有默认值。例如 JUnit 的 @Test 注解的 timeout 元素默认为 0。
使用注解 #  一个位置可以有多个注解。如果注解被声明为可重复的，甚至可以重复同一个注解多次。
泛型类的类型参数也可以使用注解。在包的 package-info.java 中包含了带有注解的包语句，是包的 Javadoc。
public class Cache<@Immutable V> {} @GPL(version=&#34;3&#34;) package com."><meta name=theme-color content="#FFFFFF"><meta name=color-scheme content="light dark"><meta property="og:title" content="9. Notations"><meta property="og:description" content="注解 #  注解元素 #  @Test(timeout=10000)  @BugReport(showStopper=true,  assignedTo=&#34;Harry&#34;,  testCase=CacheTest.class,  status=BugReport.Status.COMFIRMED  )  @SuppressWarnings(&#34;unchecked&#34;) // only one parameter, equals @SuppressWarnings(value=&#34;unchecked&#34;)  @BugReport(reportedBy={&#34;harry&#34;, &#34;fred&#34;}) // array of above  @BugReport(ref=@Reference(id=1123)) // another annotation 注解元素可以是：
 基本类型 String class 对象 enum 实例 注解 这些元素的一维数组  元素可以有默认值。例如 JUnit 的 @Test 注解的 timeout 元素默认为 0。
使用注解 #  一个位置可以有多个注解。如果注解被声明为可重复的，甚至可以重复同一个注解多次。
泛型类的类型参数也可以使用注解。在包的 package-info.java 中包含了带有注解的包语句，是包的 Javadoc。
public class Cache<@Immutable V> {} @GPL(version=&#34;3&#34;) package com."><meta property="og:type" content="article"><meta property="og:url" content="/notes/core-java-impatient/9/"><meta property="article:section" content="notes"><title>9. Notations | czdm75 Blog</title><link rel=manifest href=/manifest.json><link rel=icon href=/favicon.png type=image/x-icon><link rel=stylesheet href=/book.min.97cfda4f5e3c9fa49a2bf8d401f4ddc0eec576c99cdcf6afbec19173200c37db.css><script defer src=/flexsearch.min.js></script>
<script defer src=/en.search.min.60f5c0362a1b15384bf6fbb748ad6fb49d79819ad4313fc4618ffb6d1f645f15.js></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>czdm75 Blog</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li><input type=checkbox id=section-25b8c894ab868b34ecd6cce0ce4c79c7 class=toggle>
<label for=section-25b8c894ab868b34ecd6cce0ce4c79c7 class="flex justify-between"><a href=/cs/>Computer Science</a></label><ul><li><a href=/cs/linux-io-multiplex/>Linux IO Multiplexing</a></li></ul></li><li><input type=checkbox id=section-d5643d9c227c9fc0bfaa81dc6e0249af class=toggle>
<label for=section-d5643d9c227c9fc0bfaa81dc6e0249af class="flex justify-between"><a href=/distributed/>Distributed Systems</a></label><ul><li><a href=/distributed/hadoop-basic/>Hadoop Basic Concepts</a></li><li><a href=/distributed/spark-rdd/>Spark RDD Programming</a></li><li><a href=/distributed/spark-sql/>Spark SQL Programming</a></li></ul></li><li><a href=/notes/>Notes on Books</a><ul><li><input type=checkbox id=section-f9c54ee28ad742882651b9afb106f923 class=toggle checked>
<label for=section-f9c54ee28ad742882651b9afb106f923 class="flex justify-between"><a href=/notes/core-java-impatient/>Core Java for Impatients</a></label><ul><li><a href=/notes/core-java-impatient/1/>1. Basic OOP</a></li><li><a href=/notes/core-java-impatient/2/>2. Interface, Lambda</a></li><li><a href=/notes/core-java-impatient/3/>3. Inheritance, Reflection</a></li><li><a href=/notes/core-java-impatient/4/>4. Exception, Logging</a></li><li><a href=/notes/core-java-impatient/5/>5. Generics</a></li><li><a href=/notes/core-java-impatient/6/>6. Collections, Streams</a></li><li><a href=/notes/core-java-impatient/7/>7. IO, Regexp, Serialization</a></li><li><a href=/notes/core-java-impatient/8/>8. Threading</a></li><li><a href=/notes/core-java-impatient/9/ class=active>9. Notations</a></li></ul></li><li><input type=checkbox id=section-9d0fb26a4934bb77406a56b94138590b class=toggle>
<label for=section-9d0fb26a4934bb77406a56b94138590b class="flex justify-between"><a href=/notes/in-depth-jvm/>In-depth Understanding JVM</a></label><ul><li><a href=/notes/in-depth-jvm/gc/>Garbage Collection</a></li><li><a href=/notes/in-depth-jvm/synchronization/>Java Synchronization</a></li><li><a href=/notes/in-depth-jvm/memory-model/>JVM Memory Model</a></li><li><a href=/notes/in-depth-jvm/memory-region/>JVM Memory Regions</a></li><li><a href=/notes/in-depth-jvm/threadlocal-reference/>ThreadLocal and Reference</a></li></ul></li><li><input type=checkbox id=section-4d028229be962782539eef651433109e class=toggle>
<label for=section-4d028229be962782539eef651433109e class="flex justify-between"><a href=/notes/intro-algo/>Introduction to Algorithms</a></label><ul><li><a href=/notes/intro-algo/1/>1. Compexity, Divide</a></li><li><a href=/notes/intro-algo/2/>2. Sorting, Order Statistic</a></li><li><a href=/notes/intro-algo/3/>3. LinkedList, HashTable</a></li><li><a href=/notes/intro-algo/4/>4. BST, Balanced BSTs</a></li><li><a href=/notes/intro-algo/5/>5. Trie-Tree, Extending Data Structures</a></li><li><a href=/notes/intro-algo/6/>6. Dynamic Programming, Greedy, Amortize</a></li><li><a href=/notes/intro-algo/7/>7. B-Tree, Fibonacci Heap, vEB Tree</a></li><li><a href=/notes/intro-algo/8/>8. Graphs</a></li></ul></li><li><input type=checkbox id=section-76be9453a58f37863458b83352d3ff3c class=toggle>
<label for=section-76be9453a58f37863458b83352d3ff3c class="flex justify-between"><a href=/notes/programming-scala/>Programming in Scala</a></label><ul><li><a href=/notes/programming-scala/1/>1. Basics</a></li><li><a href=/notes/programming-scala/2/>2. Functions</a></li><li><a href=/notes/programming-scala/3/>3 .Inheritance, Package, Assertion</a></li><li><a href=/notes/programming-scala/4/>4. Pattern Matching, Collections</a></li><li><a href=/notes/programming-scala/5/>5. Generics, Abstract, Implicits</a></li><li><a href=/notes/programming-scala/6/>6. Collections, Extractor, etc</a></li></ul></li></ul></li><li><input type=checkbox id=section-9784d97422a8bbe41d06f74a08150515 class=toggle>
<label for=section-9784d97422a8bbe41d06f74a08150515 class="flex justify-between"><a href=/pl/>Programming Languages</a></label><ul><li><a href=/pl/java-nio-2/>Java NIO Internal</a></li><li><a href=/pl/java-nio-1/>Java NIO Usage</a></li><li><a href=/pl/lambda/>Lambda Calculus and Y Combinator</a></li><li><a href=/pl/curry/>Scala: Currying, Partially Applied, Partial</a></li><li><a href=/pl/monad/>Scala: Monad, from Scala Perspective</a></li></ul></li></ul><ul><li><a href=https://github.com/czdm75 target=_blank rel=noopener>GitHub</a></li><li><a href=https://themes.gohugo.io/hugo-book/ target=_blank rel=noopener>Theme</a></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label>
<strong>9. Notations</strong>
<label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#注解>注解</a><ul><li><a href=#注解元素>注解元素</a></li><li><a href=#使用注解>使用注解</a></li><li><a href=#定义注解>定义注解</a><ul><li><a href=#target>@Target</a></li><li><a href=#retention>@Retention</a></li></ul></li></ul></li><li><a href=#标准注解>标准注解</a><ul><li><a href=#编译相关的注解>编译相关的注解</a></li><li><a href=#资源管理相关的注解>资源管理相关的注解</a></li><li><a href=#元注解>元注解</a></li></ul></li><li><a href=#运行时注解处理>运行时注解处理</a><ul><li><a href=#定义运行时注解>定义运行时注解</a></li><li><a href=#使用反射检查对象>使用反射检查对象</a></li><li><a href=#编写方法>编写方法</a></li></ul></li><li><a href=#源码级注解处理>源码级注解处理</a><ul><li><a href=#注解处理器>注解处理器</a></li><li><a href=#语言模型-api>语言模型 API</a></li><li><a href=#生成源码>生成源码</a></li></ul></li></ul></nav></aside></header><article class=markdown><h1 id=注解>注解
<a class=anchor href=#%e6%b3%a8%e8%a7%a3>#</a></h1><h2 id=注解元素>注解元素
<a class=anchor href=#%e6%b3%a8%e8%a7%a3%e5%85%83%e7%b4%a0>#</a></h2><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a2f>@Test</span><span style=color:#666>(</span>timeout<span style=color:#666>=</span>10000<span style=color:#666>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a2f>@BugReport</span><span style=color:#666>(</span>showStopper<span style=color:#666>=</span><span style=color:green;font-weight:700>true</span><span style=color:#666>,</span>
</span></span><span style=display:flex><span>          assignedTo<span style=color:#666>=</span><span style=color:#ba2121>&#34;Harry&#34;</span><span style=color:#666>,</span>
</span></span><span style=display:flex><span>          testCase<span style=color:#666>=</span>CacheTest<span style=color:#666>.</span><span style=color:#7d9029>class</span><span style=color:#666>,</span>
</span></span><span style=display:flex><span>          status<span style=color:#666>=</span>BugReport<span style=color:#666>.</span><span style=color:#7d9029>Status</span><span style=color:#666>.</span><span style=color:#7d9029>COMFIRMED</span>
</span></span><span style=display:flex><span>          <span style=color:#666>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a2f>@SuppressWarnings</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;unchecked&#34;</span><span style=color:#666>)</span>  <span style=color:#408080;font-style:italic>// only one parameter, equals
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span><span style=color:#a2f>@SuppressWarnings</span><span style=color:#666>(</span>value<span style=color:#666>=</span><span style=color:#ba2121>&#34;unchecked&#34;</span><span style=color:#666>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a2f>@BugReport</span><span style=color:#666>(</span>reportedBy<span style=color:#666>={</span><span style=color:#ba2121>&#34;harry&#34;</span><span style=color:#666>,</span> <span style=color:#ba2121>&#34;fred&#34;</span><span style=color:#666>})</span>  <span style=color:#408080;font-style:italic>// array of above
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#a2f>@BugReport</span><span style=color:#666>(</span>ref<span style=color:#666>=</span><span style=color:#a2f>@Reference</span><span style=color:#666>(</span>id<span style=color:#666>=</span>1123<span style=color:#666>))</span>  <span style=color:#408080;font-style:italic>// another annotation
</span></span></span></code></pre></div><p>注解元素可以是：</p><ul><li>基本类型</li><li>String</li><li>class 对象</li><li>enum 实例</li><li>注解</li><li>这些元素的一维数组</li></ul><p>元素可以有默认值。例如 JUnit 的 <code>@Test</code> 注解的 <code>timeout</code> 元素默认为 0。</p><h2 id=使用注解>使用注解
<a class=anchor href=#%e4%bd%bf%e7%94%a8%e6%b3%a8%e8%a7%a3>#</a></h2><p>一个位置可以有多个注解。如果注解被声明为可重复的，甚至可以重复同一个注解多次。</p><p>泛型类的类型参数也可以使用注解。在包的 <code>package-info.java</code> 中包含了带有注解的包语句，是包的 Javadoc。</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:green;font-weight:700>public</span> <span style=color:green;font-weight:700>class</span> <span style=color:#00f;font-weight:700>Cache</span><span style=color:#666>&lt;</span><span style=color:#a2f>@Immutable</span> V<span style=color:#666>&gt;</span> <span style=color:#666>{}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a2f>@GPL</span><span style=color:#666>(</span>version<span style=color:#666>=</span><span style=color:#ba2121>&#34;3&#34;</span><span style=color:#666>)</span>
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>package</span> <span style=color:#00f;font-weight:700>com.test</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>import</span> <span style=color:#00f;font-weight:700>org.gnu.GPL</span><span style=color:#666>;</span>
</span></span></code></pre></div><p>注解可以用来标记一些信息，这些信息通常会在编译时进行检查。典型的例子是 <code>@NotNull</code>。它们出现的位置包括：</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>List<span style=color:#666>&lt;</span><span style=color:#a2f>@NotNull</span> String<span style=color:#666>&gt;;</span>  <span style=color:#408080;font-style:italic>// anywhere generic parameter is
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>Comparator<span style=color:#666>.&lt;</span><span style=color:#a2f>@NotNull</span> String<span style=color:#666>&gt;</span>reverseOrder<span style=color:#666>;</span>
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>class</span> <span style=color:#00f;font-weight:700>Warning</span> <span style=color:green;font-weight:700>extends</span> <span style=color:#a2f>@Localized</span> Message<span style=color:#666>;</span>  <span style=color:#408080;font-style:italic>// superclass, implemented interface
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span><span style=color:green;font-weight:700>new</span> <span style=color:#a2f>@Localized</span> String<span style=color:#666>();</span>  <span style=color:#408080;font-style:italic>// constructor
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>Map<span style=color:#666>.</span><span style=color:#a2f>@Localized</span> Entry<span style=color:#666>;</span>  <span style=color:#408080;font-style:italic>// nested types(Map.Entry)
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span><span style=color:#666>(</span><span style=color:#a2f>@Localized</span> String<span style=color:#666>)</span> text<span style=color:#666>;</span>  <span style=color:#408080;font-style:italic>// casts and instanceof
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span><span style=color:#666>(</span>text <span style=color:green;font-weight:700>instanceof</span> <span style=color:#a2f>@Localized</span> String<span style=color:#666>);</span>  <span style=color:#408080;font-style:italic>// don&#39;t influence result
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span><span style=color:green;font-weight:700>public</span> String <span style=color:#00f>read</span><span style=color:#666>()</span> <span style=color:green;font-weight:700>throws</span> <span style=color:#a2f>@Localized</span> IOException<span style=color:#666>;</span>  <span style=color:#408080;font-style:italic>// exception specifications
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>List<span style=color:#666>&lt;</span><span style=color:#a2f>@Localized</span> <span style=color:#666>?</span> <span style=color:green;font-weight:700>extends</span> Message<span style=color:#666>&gt;;</span>  <span style=color:#408080;font-style:italic>// wildcards and type bounds
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>List<span style=color:#666>&lt;?</span> <span style=color:green;font-weight:700>extends</span> <span style=color:#a2f>@Localized</span> Message<span style=color:#666>&gt;;</span>
</span></span><span style=display:flex><span><span style=color:#a2f>@Localized</span> Message<span style=color:#666>::</span>getText<span style=color:#666>;</span>  <span style=color:#408080;font-style:italic>// method reference
</span></span></span></code></pre></div><p>相应的，在类名处和 <code>import</code> 语句处不能使用注解。例如：</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a2f>@NotNull</span> String<span style=color:#666>.</span><span style=color:#7d9029>class</span><span style=color:#666>;</span>  <span style=color:#408080;font-style:italic>// WRONG
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span><span style=color:green;font-weight:700>import</span> <span style=color:#00f;font-weight:700>java.lang.</span><span style=color:#a2f>@NotNull</span> String<span style=color:#666>;</span>  <span style=color:#408080;font-style:italic>// WRONG
</span></span></span></code></pre></div><p>在上面的使用中，我们都只能为参数添加注解，而不能为被调用者添加注解。如果要这样做的话，需要一个比较特殊的语法：</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:green;font-weight:700>public</span> <span style=color:green;font-weight:700>class</span> <span style=color:#00f;font-weight:700>Point</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>public</span> <span style=color:#b00040>boolean</span> <span style=color:#00f>equals</span><span style=color:#666>(</span><span style=color:#a2f>@ReadOnly</span> Point <span style=color:green;font-weight:700>this</span><span style=color:#666>,</span> <span style=color:#a2f>@ReadOnly</span> Object other<span style=color:#666>)</span> <span style=color:#666>{}</span>
</span></span><span style=display:flex><span><span style=color:#666>}</span>
</span></span></code></pre></div><p>我们新增了第一个参数，并命名为 <code>this</code>。通过这种方式，为方法所在的对象添加了注解。不过，构造方法不能使用这种方式。严格来说，构造方法的运行过程中 <code>this</code> 引用还没有指向某个对象。</p><p>在内部类的构造方法中，虽然对象本身的 <code>this</code> 还没有完成，但其外部类已经构造完成。因此，可以对外部类使用注解：</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:green;font-weight:700>static</span> <span style=color:green;font-weight:700>class</span> <span style=color:#00f;font-weight:700>Sequence</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>class</span> <span style=color:#00f;font-weight:700>Iterator</span> <span style=color:green;font-weight:700>implements</span> java<span style=color:#666>.</span><span style=color:#7d9029>util</span><span style=color:#666>.</span><span style=color:#7d9029>Iterator</span><span style=color:#666>&lt;</span>Integer<span style=color:#666>&gt;</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>public</span> <span style=color:#00f>Iterator</span><span style=color:#666>(</span><span style=color:#a2f>@ReadOnly</span> Sequence Sequence<span style=color:#666>.</span><span style=color:#7d9029>this</span><span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>            <span style=color:green;font-weight:700>this</span><span style=color:#666>.</span><span style=color:#7d9029>current</span> <span style=color:#666>=</span> Sequence<span style=color:#666>.</span><span style=color:#7d9029>this</span><span style=color:#666>.</span><span style=color:#7d9029>from</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span>            <span style=color:#666>...;</span>
</span></span><span style=display:flex><span>        <span style=color:#666>}</span>
</span></span><span style=display:flex><span>    <span style=color:#666>}</span>
</span></span><span style=display:flex><span><span style=color:#666>}</span>
</span></span></code></pre></div><h2 id=定义注解>定义注解
<a class=anchor href=#%e5%ae%9a%e4%b9%89%e6%b3%a8%e8%a7%a3>#</a></h2><p>每个注解是由一个注解接口 <code>@interface</code> 声明的，接口的方法对应注解元素，Java 将实际编译一个接口。接口的方法不能有参数，不能声明抛出异常，也不能是泛型的。以 JUnit 中的 <code>@Test</code> 为例：</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a2f>@Target</span><span style=color:#666>(</span>ElementType<span style=color:#666>.</span><span style=color:#7d9029>METHOD</span><span style=color:#666>)</span>
</span></span><span style=display:flex><span><span style=color:#a2f>@Retention</span><span style=color:#666>(</span>RetentionPolicy<span style=color:#666>.</span><span style=color:#7d9029>RUNTIME</span><span style=color:#666>)</span>
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>public</span> <span style=color:#a2f>@interface</span> Test <span style=color:#666>{</span>
</span></span><span style=display:flex><span>    <span style=color:#b00040>long</span> <span style=color:#00f>timeout</span><span style=color:#666>()</span> <span style=color:green;font-weight:700>default</span> 0L<span style=color:#666>;</span>
</span></span><span style=display:flex><span>    <span style=color:#666>...</span>
</span></span><span style=display:flex><span><span style=color:#666>}</span>
</span></span></code></pre></div><p>这里的 <code>@Target</code> 和 <code>@Retension</code> 是<strong>元注解</strong>（meta-annotation）。</p><p><code>default</code> 标记了注解元素的默认值，对于数组，使用 <code>{}</code> 提供一个空数组的默认值。需要注意的是，默认值是在虚拟机启动之后动态计算得到的。例如，在默认值为 1 的版本下编译的类，如果在加载了默认值为 2 的版本的注解的环境下运行，其默认值就会是 2。</p><h3 id=target>@Target
<a class=anchor href=#target>#</a></h3><p><code>@Target</code> 指示注解可以出现的位置，如果不使用 <code>@Target</code>，那么注解可以出现在除类型参数和类型用途之外的任何地方。</p><ul><li><code>ANNOTATION_TYPE</code> ：注解类型声明</li><li><code>PACKAGE</code></li><li><code>TYPE</code> ：包括 enum 和接口，接口也包括注解</li><li><code>METHOD</code></li><li><code>CONSTRUCTOR</code></li><li><code>FIELD</code> ：包括 enum 常量</li><li><code>PARAMETER</code></li><li><code>LOCAL_VARIABLE</code></li><li><code>TYPE_PARAMETER</code></li><li><code>TYPE_USE</code> 类型的用途</li></ul><h3 id=retention>@Retention
<a class=anchor href=#retention>#</a></h3><p><code>@Retention</code> 指示访问注解的方式，<code>RetentionPolicy</code> 枚举有三种选择。</p><ul><li><code>SOURCE</code> ：对源代码处理器可见，不包含在 <code>class</code> 文件里。</li><li><code>CLASS</code> ：注解包含在类文件里，但虚拟机 Class Loader 不会加载。这是默认行为。</li><li><code>RUNTIME</code> ：注解在运行时可见，并可以通过反射 API 访问。</li></ul><h1 id=标准注解>标准注解
<a class=anchor href=#%e6%a0%87%e5%87%86%e6%b3%a8%e8%a7%a3>#</a></h1><table><thead><tr><th>注解接口</th><th>应用于</th><th>目的</th></tr></thead><tbody><tr><td><code>@Override</code></td><td>方法</td><td>检查重载</td></tr><tr><td><code>@Deprecated</code></td><td>所有声明</td><td>标记弃用</td></tr><tr><td><code>@SuppressWarnings</code></td><td>除包之外</td><td>抑制警告</td></tr><tr><td><code>@SafeVarargs</code></td><td>方法和构造函数</td><td>断言不定长参数安全</td></tr><tr><td><code>@FunctionalInterface</code></td><td>接口</td><td>函数式接口</td></tr><tr><td><code>@PostConstruct</code></td><td>方法</td><td>在构造后立即调用</td></tr><tr><td><code>@PreDestroy</code></td><td>方法</td><td>在删除被注入对象前调用</td></tr><tr><td><code>@Resource</code></td><td>类，接口，方法，域</td><td>资源或依赖注入</td></tr><tr><td><code>@Resources</code></td><td>类，接口</td><td>资源数组</td></tr><tr><td><code>@Generated</code></td><td>所有声明</td><td>工具产生的源代码</td></tr><tr><td><code>@Target</code></td><td>注解</td><td>使用注解的位置</td></tr><tr><td><code>@Retention</code></td><td>注解</td><td>指定使用注解的位置</td></tr><tr><td><code>@Documented</code></td><td>注解</td><td>指定包含在被注解的文档中</td></tr><tr><td><code>@Inherited</code></td><td>注解</td><td>指定被子类继承</td></tr><tr><td><code>@Repeateble</code></td><td>注解</td><td>指定可以应用多次</td></tr></tbody></table><h2 id=编译相关的注解>编译相关的注解
<a class=anchor href=#%e7%bc%96%e8%af%91%e7%9b%b8%e5%85%b3%e7%9a%84%e6%b3%a8%e8%a7%a3>#</a></h2><ul><li>打上 <code>@Deprecated</code> 的方法在编译时会发出警告。</li><li><code>@SafeVarargs("unchecked")</code> 断言一个方法不损坏其可变参数。</li><li><code>@Generated(value="com.test", date="...")</code> 需要唯一标识符和可选的日期与注释，标记代码由代码生成工具自动生成。</li></ul><p><code>@SafeVarargs</code> 需要使用的一个例子：</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:green;font-weight:700>public</span> <span style=color:green;font-weight:700>static</span> <span style=color:#666>&lt;</span>T<span style=color:#666>&gt;</span> <span style=color:#00f>fun</span><span style=color:#666>(</span>T<span style=color:#666>...</span> args<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>    <span style=color:#666>...;</span>
</span></span><span style=display:flex><span><span style=color:#666>}</span>
</span></span></code></pre></div><p>这时编译器会报警告，表示这里有可能出现类型安全问题。如果方法是 <code>final</code> 或 <code>static</code> 的，且程序员能够保证这里不会出现安全问题，则可以使用这个注解去除警告，而不必使用 <code>@SuppressWarnings</code>。</p><h2 id=资源管理相关的注解>资源管理相关的注解
<a class=anchor href=#%e8%b5%84%e6%ba%90%e7%ae%a1%e7%90%86%e7%9b%b8%e5%85%b3%e7%9a%84%e6%b3%a8%e8%a7%a3>#</a></h2><p><code>@PostConstruct</code> 和 <code>@PreDestroy</code> 用于需要控制对象生命周期的情形。</p><p><code>@Resource</code> 用于资源注入。例如：</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a2f>@Resource</span><span style=color:#666>(</span>name<span style=color:#666>=</span><span style=color:#ba2121>&#34;jdbc/employeedb&#34;</span><span style=color:#666>)</span>
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>private</span> DataSource source<span style=color:#666>;</span>
</span></span></code></pre></div><p>然后，容器会将相应的数据库来源注入到 <code>source</code> 变量。</p><h2 id=元注解>元注解
<a class=anchor href=#%e5%85%83%e6%b3%a8%e8%a7%a3>#</a></h2><p><code>@Documented</code> 标记的注解会出现在被修饰者的 Javadoc 中。功能性的注解如 <code>@FunctionalInterface</code> 需要用到，而 <code>@SuppressWarnings</code> 这样的实现相关的注解就不适合使用。</p><p><code>@Inherited</code> 用于打在类上的注解。这样的注解会被子类自动继承。这样的注解的用途可以参照 <code>Serializable</code> 这样的标记接口。</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a2f>@Inherited</span> <span style=color:#a2f>@interface</span> Persistent <span style=color:#666>{}</span>
</span></span><span style=display:flex><span><span style=color:#a2f>@Persistent</span> <span style=color:green;font-weight:700>class</span> <span style=color:#00f;font-weight:700>Employee</span> <span style=color:#666>{}</span>
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>class</span> <span style=color:#00f;font-weight:700>Manager</span> <span style=color:green;font-weight:700>extends</span> Employee <span style=color:#666>{}</span>  <span style=color:#408080;font-style:italic>// is also @Peristent
</span></span></span></code></pre></div><p><code>@Repeatable</code> 标记一个注解可以使用多次。对于这一类注解，需要为它再提供一个<strong>容器注解</strong>，这是由实现决定的。这些重复的注解会被装进容器注解的元素中。当然，这也会让这类注解的处理变得复杂。</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a2f>@Repeatable</span><span style=color:#666>(</span>TestCases<span style=color:#666>.</span><span style=color:#7d9029>class</span><span style=color:#666>)</span>
</span></span><span style=display:flex><span><span style=color:#a2f>@interface</span> TestCase <span style=color:#666>{</span>
</span></span><span style=display:flex><span>    String <span style=color:#00f>params</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>    String <span style=color:#00f>expected</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span><span style=color:#666>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a2f>@interface</span> TestCases <span style=color:#666>{</span>
</span></span><span style=display:flex><span>    TestCase<span style=color:#666>[]</span> <span style=color:#00f>value</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span><span style=color:#666>}</span>
</span></span></code></pre></div><h1 id=运行时注解处理>运行时注解处理
<a class=anchor href=#%e8%bf%90%e8%a1%8c%e6%97%b6%e6%b3%a8%e8%a7%a3%e5%a4%84%e7%90%86>#</a></h1><h2 id=定义运行时注解>定义运行时注解
<a class=anchor href=#%e5%ae%9a%e4%b9%89%e8%bf%90%e8%a1%8c%e6%97%b6%e6%b3%a8%e8%a7%a3>#</a></h2><p>运行时注解（<code>@Retention(RetentionPolicy.RUNTIME)</code>）最常见的用法是使用反射检查这一类对象。我们以一个 <code>@ToString</code> 注解为例，我们希望实现的是修改 <code>toString</code> 方法。</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a2f>@Target</span><span style=color:#666>({</span>ElementType<span style=color:#666>.</span><span style=color:#7d9029>FIELD</span><span style=color:#666>,</span> ElementType<span style=color:#666>.</span><span style=color:#7d9029>TYPE</span><span style=color:#666>})</span>
</span></span><span style=display:flex><span><span style=color:#a2f>@Retention</span><span style=color:#666>(</span>RetentionPolicy<span style=color:#666>.</span><span style=color:#7d9029>RUNTIME</span><span style=color:#666>)</span>
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>public</span> <span style=color:#a2f>@interface</span> ToString <span style=color:#666>{</span>
</span></span><span style=display:flex><span>    <span style=color:#b00040>boolean</span> <span style=color:#00f>includeName</span><span style=color:#666>()</span> <span style=color:green;font-weight:700>default</span> <span style=color:green;font-weight:700>true</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span><span style=color:#666>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a2f>@ToString</span><span style=color:#666>(</span>includeName<span style=color:#666>=</span><span style=color:green;font-weight:700>false</span><span style=color:#666>)</span>
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>public</span> <span style=color:green;font-weight:700>class</span> <span style=color:#00f;font-weight:700>Point</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f>@ToString</span><span style=color:#666>(</span>includeName<span style=color:#666>=</span><span style=color:green;font-weight:700>false</span><span style=color:#666>)</span> <span style=color:green;font-weight:700>private</span> <span style=color:#b00040>int</span> x<span style=color:#666>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f>@ToString</span><span style=color:#666>(</span>includeName<span style=color:#666>=</span><span style=color:green;font-weight:700>false</span><span style=color:#666>)</span> <span style=color:green;font-weight:700>private</span> <span style=color:#b00040>int</span> y<span style=color:#666>;</span>
</span></span><span style=display:flex><span><span style=color:#666>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a2f>@ToString</span>
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>public</span> <span style=color:green;font-weight:700>class</span> <span style=color:#00f;font-weight:700>Rectangle</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f>@ToString</span><span style=color:#666>(</span>includeName<span style=color:#666>=</span><span style=color:green;font-weight:700>false</span><span style=color:#666>)</span> <span style=color:green;font-weight:700>private</span> Point topLeft<span style=color:#666>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f>@ToString</span> <span style=color:green;font-weight:700>private</span> <span style=color:#b00040>int</span> width<span style=color:#666>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f>@ToString</span> <span style=color:green;font-weight:700>private</span> <span style=color:#b00040>int</span> height<span style=color:#666>;</span>
</span></span><span style=display:flex><span><span style=color:#666>}</span>
</span></span></code></pre></div><p>这样编写，我们希望一个矩形的 <code>toString</code> 得到 <code>Rectangle[[5,10],width=20,height=30]</code>。然后我们来处理 <code>toString</code> 方法。</p><h2 id=使用反射检查对象>使用反射检查对象
<a class=anchor href=#%e4%bd%bf%e7%94%a8%e5%8f%8d%e5%b0%84%e6%a3%80%e6%9f%a5%e5%af%b9%e8%b1%a1>#</a></h2><p>反射类 <code>Class</code> <code>Field</code> <code>Parameter</code> <code>Method</code> <code>Constructor</code> <code>Package</code> 都实现了 <code>AnnotatedElement</code> 接口。从这个接口可以得到关于注解的信息。接口的内容包括：</p><ul><li><code>T getAnnotation(Class&lt;T>)</code></li><li><code>T[] getAnnotationByType(Class&lt;T>)</code></li><li><code>Annotaion[] getAnnotations()</code></li><li>这些方法的 <code>getDeclared</code> 变种。</li></ul><p>然后，我们通过反射来查找注解。从这里我们可以看到将注解声明为接口，并把元素声明为方法的原因。</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>ToString ts <span style=color:#666>=</span> obj<span style=color:#666>.</span><span style=color:#7d9029>getClass</span><span style=color:#666>.</span><span style=color:#7d9029>getAnnotation</span><span style=color:#666>(</span>ToString<span style=color:#666>.</span><span style=color:#7d9029>class</span><span style=color:#666>);</span>  <span style=color:#408080;font-style:italic>// annotation is an interface
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span><span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>ts <span style=color:#666>!=</span> <span style=color:green;font-weight:700>null</span> <span style=color:#666>&amp;&amp;</span> ts<span style=color:#666>.</span><span style=color:#7d9029>includeName</span><span style=color:#666>)</span> <span style=color:#666>...;</span>  <span style=color:#408080;font-style:italic>// element is a method
</span></span></span></code></pre></div><p>特别的是，我们之前看到，可重复的注解被包装进了另一个注解。因此，对于这一类就要先寻找<strong>容器注解</strong>，然后从其 <code>value</code> 的返回值里寻找其他注解。更好的方法是使用 <code>getAnnotaionByType</code>，这个方法会进入到容器注解的内部，并返回一个数组。</p><h2 id=编写方法>编写方法
<a class=anchor href=#%e7%bc%96%e5%86%99%e6%96%b9%e6%b3%95>#</a></h2><p>然后，我们在 <code>ToStrings</code> 类中实现一个 <code>toString</code> 方法。这个方法接收一个任意的 <code>Object</code> 对象，并使用反射来遍历其所有的域。因此我们需要这样编写这个类：</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:green;font-weight:700>public</span> <span style=color:green;font-weight:700>class</span> <span style=color:#00f;font-weight:700>ToStrings</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>public</span> <span style=color:green;font-weight:700>static</span> String <span style=color:#00f>toString</span><span style=color:#666>(</span>Object obj<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>obj <span style=color:#666>==</span> <span style=color:green;font-weight:700>null</span><span style=color:#666>)</span> <span style=color:green;font-weight:700>return</span> <span style=color:#ba2121>&#34;null&#34;</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        ToString ts <span style=color:#666>=</span> obj<span style=color:#666>.</span><span style=color:#7d9029>getClass</span><span style=color:#666>.</span><span style=color:#7d9029>getAnnotation</span><span style=color:#666>(</span>ToString<span style=color:#666>.</span><span style=color:#7d9029>class</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>ts <span style=color:#666>==</span> <span style=color:green;font-weight:700>null</span><span style=color:#666>)</span> <span style=color:green;font-weight:700>return</span> obj<span style=color:#666>.</span><span style=color:#7d9029>toString</span><span style=color:#666>();</span>  <span style=color:#408080;font-style:italic>// no annotation
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>
</span></span><span style=display:flex><span>        StringBuilder result <span style=color:#666>=</span> <span style=color:green;font-weight:700>new</span> StringBuilder<span style=color:#666>();</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>ts<span style=color:#666>.</span><span style=color:#7d9029>includeName</span><span style=color:#666>())</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>            <span style=color:#666>...;</span>
</span></span><span style=display:flex><span>        <span style=color:#666>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>for</span> <span style=color:#666>(</span>Field f <span style=color:#666>:</span> c1<span style=color:#666>.</span><span style=color:#7d9029>getDeclaredFields</span><span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>            ts <span style=color:#666>=</span> f<span style=color:#666>.</span><span style=color:#7d9029>getAnnotation</span><span style=color:#666>(</span>ToString<span style=color:#666>.</span><span style=color:#7d9029>class</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>            <span style=color:#666>...;</span>  <span style=color:#408080;font-style:italic>// check and recursive
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>        <span style=color:#666>}</span>
</span></span><span style=display:flex><span>        <span style=color:#666>...;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>return</span> result<span style=color:#666>.</span><span style=color:#7d9029>toString</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>    <span style=color:#666>}</span>
</span></span><span style=display:flex><span><span style=color:#666>}</span>
</span></span></code></pre></div><h1 id=源码级注解处理>源码级注解处理
<a class=anchor href=#%e6%ba%90%e7%a0%81%e7%ba%a7%e6%b3%a8%e8%a7%a3%e5%a4%84%e7%90%86>#</a></h1><p>注解的另一种用法是自动处理源文件，以产生源码、配置文件、脚本等。我们依然修改 <code>toString</code> 方法，但不再使用反射，而是在源码上解决这个问题。最终的效果是，我们将不再使用反射来遍历域，而是为每一个打上了 <code>@ToString</code> 注解的类生成一个特定的 <code>toString</code> 方法，在这个方法里遍历对象的域。为了避免使用反射，我们将所有需要访问的域用一个 getter 包装起来。最终我们将得到与上面的运行时方式类似的一个 <code>ToStrings</code> 类，可以看做 <code>@ToString</code> 的伴随类：</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:green;font-weight:700>public</span> <span style=color:green;font-weight:700>class</span> <span style=color:#00f;font-weight:700>ToStrings</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>public</span> <span style=color:green;font-weight:700>static</span> String <span style=color:#00f>toString</span><span style=color:#666>(</span>Point obj<span style=color:#666>)</span> <span style=color:#666>{...}</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>public</span> <span style=color:green;font-weight:700>static</span> String <span style=color:#00f>toString</span><span style=color:#666>(</span>Rectangle obj<span style=color:#666>)</span> <span style=color:#666>{...}</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>public</span> <span style=color:green;font-weight:700>static</span> String <span style=color:#00f>toString</span><span style=color:#666>(</span>Object obj<span style=color:#666>)</span> <span style=color:#666>{</span> <span style=color:green;font-weight:700>return</span> Objects<span style=color:#666>.</span><span style=color:#7d9029>toString</span><span style=color:#666>(</span>obj<span style=color:#666>);</span> <span style=color:#666>}</span>
</span></span><span style=display:flex><span><span style=color:#666>}</span>
</span></span></code></pre></div><h2 id=注解处理器>注解处理器
<a class=anchor href=#%e6%b3%a8%e8%a7%a3%e5%a4%84%e7%90%86%e5%99%a8>#</a></h2><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>javac -processor ProcessorClassName,Processor sourceFiles
</span></span></code></pre></div><p>编译器会定位源文件中的注解，并交给处理器来处理，产生新的源文件，再交给下一个处理器。最终，会产生一个新的源文件，而原来的不会被改动。最后，javac 进行编译。</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a2f>@SupportedAnnotationTypes</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;com.test.annotations.ToString&#34;</span><span style=color:#666>)</span>
</span></span><span style=display:flex><span><span style=color:#a2f>@SupportedSourceVersion</span><span style=color:#666>(</span>SourceVersion<span style=color:#666>.</span><span style=color:#7d9029>RELEASE_8</span><span style=color:#666>)</span>
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>public</span> <span style=color:green;font-weight:700>class</span> <span style=color:#00f;font-weight:700>ToStringAnnotationProcessor</span> <span style=color:green;font-weight:700>extends</span> AbstractProcessor <span style=color:#666>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>public</span> <span style=color:#b00040>boolean</span> <span style=color:#00f>process</span><span style=color:#666>(</span>Set<span style=color:#666>&lt;?</span> <span style=color:green;font-weight:700>extends</span> TypeElement<span style=color:#666>&gt;</span> annotations<span style=color:#666>,</span>
</span></span><span style=display:flex><span>                           RoundEnvirionment currentRound<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>        <span style=color:#666>...;</span>
</span></span><span style=display:flex><span>    <span style=color:#666>}</span>
</span></span><span style=display:flex><span><span style=color:#666>}</span>
</span></span></code></pre></div><p>在指明处理的注解类型时，可以使用通配符 <code>com.test.annotations.*</code>，甚至直接使用 <code>*</code> 处理所有注解。在每一轮中，都会调用 <code>process</code> 方法来处理本轮发现的所有文件的注解集合和相应的 <code>RoundEnvironment</code> 引用。</p><h2 id=语言模型-api>语言模型 API
<a class=anchor href=#%e8%af%ad%e8%a8%80%e6%a8%a1%e5%9e%8b-api>#</a></h2><p>接下来我们要处理源码。编译器会产生一个树节点是类实例的树，这些类实现了 <code>javax.lang.model.element.Element</code> 接口和它的各种子接口：<code>TypeElement</code> <code>VariableElement</code> 和 <code>ExecutableElement</code> 等。这里我们只进行简要的介绍。</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>Set<span style=color:#666>&lt;?</span> <span style=color:green;font-weight:700>extends</span> Element<span style=color:#666>&gt;</span> <span style=color:#00f>getElementsAnnotatedWith</span><span style=color:#666>(</span>Class<span style=color:#666>&lt;?</span> <span style=color:green;font-weight:700>extends</span> Annoattion<span style=color:#666>&gt;</span> a<span style=color:#666>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>A <span style=color:#00f>getAnnotation</span><span style=color:#666>(</span>Class<span style=color:#666>&lt;</span>A<span style=color:#666>&gt;</span> annotationType<span style=color:#666>);</span>
</span></span><span style=display:flex><span>A<span style=color:#666>[]</span> <span style=color:#00f>getAnnotationsByType</span><span style=color:#666>(</span>Class<span style=color:#666>&lt;</span>A<span style=color:#666>&gt;</span> annotationType<span style=color:#666>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>typeElement<span style=color:#666>.</span><span style=color:#7d9029>getEnclosedElements</span><span style=color:#666>();</span>  <span style=color:#408080;font-style:italic>// return fields and methods
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>
</span></span><span style=display:flex><span>element<span style=color:#666>.</span><span style=color:#7d9029>getSimpleName</span><span style=color:#666>().</span><span style=color:#7d9029>toString</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>typeElement<span style=color:#666>.</span><span style=color:#7d9029>getQualifiedName</span><span style=color:#666>.</span><span style=color:#7d9029>toString</span><span style=color:#666>();</span>
</span></span></code></pre></div><h2 id=生成源码>生成源码
<a class=anchor href=#%e7%94%9f%e6%88%90%e6%ba%90%e7%a0%81>#</a></h2><p>注解处理器只能产生新类，而不能修改已有的类。因此，我们最终将把生成的代码放在 <code>ToStrings</code> 类中。对于类似的目标：</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a2f>@ToString</span>
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>public</span> <span style=color:green;font-weight:700>class</span> <span style=color:#00f;font-weight:700>Rectangle</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f>@ToString</span><span style=color:#666>(</span>includeName<span style=color:#666>=</span><span style=color:green;font-weight:700>false</span><span style=color:#666>)</span> <span style=color:green;font-weight:700>public</span> Point <span style=color:#00f>getTopLeft</span><span style=color:#666>()</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>return</span> topLeft<span style=color:#666>;</span>
</span></span><span style=display:flex><span>    <span style=color:#666>}</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f>@ToString</span> <span style=color:green;font-weight:700>public</span> <span style=color:green;font-weight:700>static</span> <span style=color:#00f>getWidth</span><span style=color:#666>()</span> <span style=color:#666>{</span> <span style=color:green;font-weight:700>return</span> width<span style=color:#666>;</span> <span style=color:#666>}</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f>@ToString</span> <span style=color:green;font-weight:700>public</span> <span style=color:green;font-weight:700>static</span> <span style=color:#00f>getWidth</span><span style=color:#666>()</span> <span style=color:#666>{</span> <span style=color:green;font-weight:700>return</span> width<span style=color:#666>;</span> <span style=color:#666>}</span>
</span></span><span style=display:flex><span><span style=color:#666>}</span>
</span></span></code></pre></div><p>我们先编写一个产生 <code>toString</code> 方法的工具，这个工具接收一个类作为参数，如这里的 <code>Point</code> 和 <code>Rectangle</code>：</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:green;font-weight:700>private</span> <span style=color:#b00040>void</span> <span style=color:#00f>writeToStringMethod</span><span style=color:#666>(</span>PrintWriter out<span style=color:#666>,</span> TypeElement te<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>    String className <span style=color:#666>=</span> te<span style=color:#666>.</span><span style=color:#7d9029>getQualifiedName</span><span style=color:#666>().</span><span style=color:#7d9029>toString</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    out<span style=color:#666>.</span><span style=color:#7d9029>printf</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;public static String toString(%s obj) {\n&#34;</span><span style=color:#666>,</span>
</span></span><span style=display:flex><span>               className<span style=color:#666>);</span>
</span></span><span style=display:flex><span>    out<span style=color:#666>.</span><span style=color:#7d9029>printf</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;StringBuilder result = new Stringbuilder();\n&#34;</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>    <span style=color:#408080;font-style:italic>/* prints method head code:
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic>     * public static String toString(Rectangle obj) {
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic>     * StringBuilder result = new Stringbuilder();
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic>     */</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    ToString ann <span style=color:#666>=</span> te<span style=color:#666>.</span><span style=color:#7d9029>getAnnotation</span><span style=color:#666>(</span>ToString<span style=color:#666>.</span><span style=color:#7d9029>class</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>ann<span style=color:#666>.</span><span style=color:#7d9029>includeName</span><span style=color:#666>())</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>        out<span style=color:#666>.</span><span style=color:#7d9029>printf</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;result.append(\&#34;%s[\&#34;);\n&#34;</span><span style=color:#666>,</span> className<span style=color:#666>);</span>
</span></span><span style=display:flex><span>    <span style=color:#666>}</span>
</span></span><span style=display:flex><span>    <span style=color:#408080;font-style:italic>/* prints field class name code:
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic>     * result.append(&#34;Rectangle[&#34;);
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic>     */</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>for</span> <span style=color:#666>(</span>Element c <span style=color:#666>:</span> te<span style=color:#666>.</span><span style=color:#7d9029>getEnclosedElements</span><span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>        <span style=color:#408080;font-style:italic>// traverse all fields and methods
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>        ann <span style=color:#666>=</span> c<span style=color:#666>.</span><span style=color:#7d9029>getAnotation</span><span style=color:#666>(</span>ToString<span style=color:#666>.</span><span style=color:#7d9029>class</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>an <span style=color:#666>!=</span> <span style=color:green;font-weight:700>null</span><span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>            <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>an<span style=color:#666>.</span><span style=color:#7d9029>includeName</span><span style=color:#666>())</span> <span style=color:#666>{</span>  <span style=color:#408080;font-style:italic>// check if print field name
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>                out<span style=color:#666>.</span><span style=color:#7d9029>printf</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;result.append(\&#34;%s=\&#34;);\n&#34;</span><span style=color:#666>,</span>
</span></span><span style=display:flex><span>                           c<span style=color:#666>.</span><span style=color:#7d9029>getName</span><span style=color:#666>().</span><span style=color:#7d9029>toString</span><span style=color:#666>().</span><span style=color:#7d9029>subString</span><span style=color:#666>(</span>3<span style=color:#666>).</span><span style=color:#7d9029>toLowerCase</span><span style=color:#666>());</span>
</span></span><span style=display:flex><span>            <span style=color:#666>}</span>
</span></span><span style=display:flex><span>            <span style=color:#408080;font-style:italic>/* prints field name code:
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic>             * result.append(&#34;width=&#34;);
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic>             */</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            out<span style=color:#666>.</span><span style=color:#7d9029>printf</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;result.append(toString(obj.%s()));\n&#34;</span><span style=color:#666>,</span>
</span></span><span style=display:flex><span>                       c<span style=color:#666>.</span><span style=color:#7d9029>getName</span><span style=color:#666>().</span><span style=color:#7d9029>toString</span><span style=color:#666>());</span>
</span></span><span style=display:flex><span>            out<span style=color:#666>.</span><span style=color:#7d9029>print</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;result.append(\&#34;,\&#34;);\n&#34;</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>            <span style=color:#408080;font-style:italic>/* prints field value code:
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic>             * result.append(toString(obj.getWidth()));
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic>             * result.append(\&#34;,\&#34;);
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic>             */</span>
</span></span><span style=display:flex><span>        <span style=color:#666>}</span>
</span></span><span style=display:flex><span>    <span style=color:#666>}</span>
</span></span><span style=display:flex><span>    out<span style=color:#666>.</span><span style=color:#7d9029>println</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;result.append(\&#34;]\&#34;);&#34;</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>    out<span style=color:#666>.</span><span style=color:#7d9029>println</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;return result.toString();&#34;</span><span style=color:#666>)</span>
</span></span><span style=display:flex><span><span style=color:#666>}</span>
</span></span></code></pre></div><p>在这个方法中，我们接收一个 <code>PrintWriter</code> 和一个类，并遍历其所有的域，寻找我们之前编写的打上了注解的方法，为这些方法输出对应的代码语句。这些语句将是最终对源代码修改的一部分。</p><p>最后，我们来编写处理器的 <code>process</code> 方法。</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:green;font-weight:700>public</span> <span style=color:#b00040>boolean</span> <span style=color:#00f>process</span><span style=color:#666>(</span>Set<span style=color:#666>&lt;?</span> <span style=color:green;font-weight:700>extends</span> TypeElement<span style=color:#666>&gt;</span> annotations<span style=color:#666>,</span>
</span></span><span style=display:flex><span>                       RoundEnvironment currentRound<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>annotations<span style=color:#666>.</span><span style=color:#7d9029>size</span><span style=color:#666>()</span> <span style=color:#666>==</span> 0<span style=color:#666>)</span> <span style=color:green;font-weight:700>return</span> <span style=color:green;font-weight:700>true</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>try</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>        JavaFileObject sourceFile <span style=color:#666>=</span> processingEnv<span style=color:#666>.</span><span style=color:#7d9029>getFiler</span><span style=color:#666>()</span>
</span></span><span style=display:flex><span>            <span style=color:#666>.</span><span style=color:#7d9029>createSourceFile</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;com.test.ToStrings&#34;</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>try</span> <span style=color:#666>(</span>PrintWriter out <span style=color:#666>=</span> <span style=color:green;font-weight:700>new</span> PrintWriter<span style=color:#666>(</span>sourceFile<span style=color:#666>.</span><span style=color:#7d9029>openWriter</span><span style=color:#666>()))</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            out<span style=color:#666>.</span><span style=color:#7d9029>println</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;package com.test.xxx;&#34;</span><span style=color:#666>)</span>
</span></span><span style=display:flex><span>            out<span style=color:#666>.</span><span style=color:#7d9029>println</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;public class ToStrings {&#34;</span><span style=color:#666>)</span>
</span></span><span style=display:flex><span>            out<span style=color:#666>.</span><span style=color:#7d9029>print</span>
</span></span><span style=display:flex><span>            <span style=color:#00f>for</span> <span style=color:#666>(</span>Element e <span style=color:#666>:</span>
</span></span><span style=display:flex><span>                 currentRound<span style=color:#666>.</span><span style=color:#7d9029>getElementsAnnotatedWith</span><span style=color:#666>(</span>ToString<span style=color:#666>.</span><span style=color:#7d9029>class</span><span style=color:#666>))</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>                <span style=color:#408080;font-style:italic>// traverse all annotated classes
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>                writeToStringMethod<span style=color:#666>(</span>out<span style=color:#666>,</span> <span style=color:#666>(</span>TypeElement<span style=color:#666>)</span> e<span style=color:#666>);</span>
</span></span><span style=display:flex><span>                <span style=color:#408080;font-style:italic>// call method above to process every class
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>            <span style=color:#666>}</span>
</span></span><span style=display:flex><span>            out<span style=color:#666>.</span><span style=color:#7d9029>print</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;public static String toString(Object obj) {\n&#34;</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>            out<span style=color:#666>.</span><span style=color:#7d9029>print</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;return Objects.toString(obj);\n}\n}&#34;</span><span style=color:#666>)</span>
</span></span><span style=display:flex><span>        <span style=color:#666>}</span> <span style=color:green;font-weight:700>catch</span> <span style=color:#666>(</span>IOException ex<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>            processingEnv<span style=color:#666>.</span><span style=color:#7d9029>getMessager</span><span style=color:#666>().</span><span style=color:#7d9029>printMessage</span><span style=color:#666>(</span>
</span></span><span style=display:flex><span>            Kind<span style=color:#666>.</span><span style=color:#7d9029>ERROR</span><span style=color:#666>,</span> ex<span style=color:#666>.</span><span style=color:#7d9029>getMessage</span><span style=color:#666>());</span>
</span></span><span style=display:flex><span>        <span style=color:#666>}</span>
</span></span><span style=display:flex><span>    <span style=color:#666>}</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>return</span> <span style=color:green;font-weight:700>true</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span><span style=color:#666>}</span>
</span></span></code></pre></div><p>这是一项非常需要细心的工作。无论如何，我们现在成功生成了 <code>ToStrings</code> 整个类的代码。当然，生成的其他文件不仅仅可以是 Java代码，也可以是脚本或 XML 配置等等。如果想要查看每一轮处理的详细情况，可以在编译时加上 <code>-XprintRounds</code> 参数，将会打印出每一轮处理的输入，处理的注解等情况。</p></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(n){const e=window.getSelection(),t=document.createRange();t.selectNodeContents(n),e.removeAllRanges(),e.addRange(t)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#注解>注解</a><ul><li><a href=#注解元素>注解元素</a></li><li><a href=#使用注解>使用注解</a></li><li><a href=#定义注解>定义注解</a><ul><li><a href=#target>@Target</a></li><li><a href=#retention>@Retention</a></li></ul></li></ul></li><li><a href=#标准注解>标准注解</a><ul><li><a href=#编译相关的注解>编译相关的注解</a></li><li><a href=#资源管理相关的注解>资源管理相关的注解</a></li><li><a href=#元注解>元注解</a></li></ul></li><li><a href=#运行时注解处理>运行时注解处理</a><ul><li><a href=#定义运行时注解>定义运行时注解</a></li><li><a href=#使用反射检查对象>使用反射检查对象</a></li><li><a href=#编写方法>编写方法</a></li></ul></li><li><a href=#源码级注解处理>源码级注解处理</a><ul><li><a href=#注解处理器>注解处理器</a></li><li><a href=#语言模型-api>语言模型 API</a></li><li><a href=#生成源码>生成源码</a></li></ul></li></ul></nav></div></aside></main></body></html>