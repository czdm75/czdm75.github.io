<!doctype html><html lang=en dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="使用泛型 # 泛型方法 # public class Arrays { public static <T> void swap(T[] array int i, int j) { ... } } // call Arrays.swap(arr, 1 ,2); Arrays.<String> swap(arr, 1, 2); // for better error message 类型限定 # // for an arraylist public static <T extends AutoClosable> void closeAll(ArrayList<T> elems) throws Exception { for (T elem : elems) elem.close(); // an method in interface AutoClosable } //for an array, no need for generic public static void closeAll(AutoClosable[] elems) throws Exception { ."><meta name=theme-color content="#FFFFFF"><meta name=color-scheme content="light dark"><meta property="og:url" content="/notes/core-java-impatient/5/"><meta property="og:site_name" content="czdm75 Blog"><meta property="og:title" content="5. Generics"><meta property="og:description" content="使用泛型 # 泛型方法 # public class Arrays { public static <T> void swap(T[] array int i, int j) { ... } } // call Arrays.swap(arr, 1 ,2); Arrays.<String> swap(arr, 1, 2); // for better error message 类型限定 # // for an arraylist public static <T extends AutoClosable> void closeAll(ArrayList<T> elems) throws Exception { for (T elem : elems) elem.close(); // an method in interface AutoClosable } //for an array, no need for generic public static void closeAll(AutoClosable[] elems) throws Exception { ."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="notes"><title>5. Generics | czdm75 Blog</title>
<link rel=manifest href=/manifest.json><link rel=icon href=/favicon.png type=image/x-icon><link rel=stylesheet href=/book.min.97cfda4f5e3c9fa49a2bf8d401f4ddc0eec576c99cdcf6afbec19173200c37db.css><script defer src=/flexsearch.min.js></script><script defer src=/en.search.min.f7e98004e6b8d1bafd93b9d4b053644c96b18c50c1205ec6db396c209e97a5a3.js></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>czdm75 Blog</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li><input type=checkbox id=section-7258d8e1fea5a0c302a6de537a7b6f57 class=toggle>
<label for=section-7258d8e1fea5a0c302a6de537a7b6f57 class="flex justify-between"><a href=/cs/>Computer Science</a></label><ul><li><a href=/cs/linux-io-multiplex/>Linux IO Multiplexing</a></li></ul></li><li><input type=checkbox id=section-6c3d93bc59df31a703231f35ad75d678 class=toggle>
<label for=section-6c3d93bc59df31a703231f35ad75d678 class="flex justify-between"><a href=/distributed/>Distributed Systems</a></label><ul><li><a href=/distributed/hadoop-basic/>Hadoop Basic Concepts</a></li><li><a href=/distributed/spark-rdd/>Spark RDD Programming</a></li><li><a href=/distributed/spark-sql/>Spark SQL Programming</a></li></ul></li><li><a href=/notes/>Notes on Books</a><ul><li><input type=checkbox id=section-75aaf2c83c6ed8e1f079c5418c19dad4 class=toggle checked>
<label for=section-75aaf2c83c6ed8e1f079c5418c19dad4 class="flex justify-between"><a href=/notes/core-java-impatient/>Core Java for Impatients</a></label><ul><li><a href=/notes/core-java-impatient/1/>1. Basic OOP</a></li><li><a href=/notes/core-java-impatient/2/>2. Interface, Lambda</a></li><li><a href=/notes/core-java-impatient/3/>3. Inheritance, Reflection</a></li><li><a href=/notes/core-java-impatient/4/>4. Exception, Logging</a></li><li><a href=/notes/core-java-impatient/5/ class=active>5. Generics</a></li><li><a href=/notes/core-java-impatient/6/>6. Collections, Streams</a></li><li><a href=/notes/core-java-impatient/7/>7. IO, Regexp, Serialization</a></li><li><a href=/notes/core-java-impatient/8/>8. Threading</a></li><li><a href=/notes/core-java-impatient/9/>9. Notations</a></li></ul></li><li><input type=checkbox id=section-b2f01d2b22c35e214487b845322f7a58 class=toggle>
<label for=section-b2f01d2b22c35e214487b845322f7a58 class="flex justify-between"><a href=/notes/ddia/>Designing Data-Intensive Applications</a></label><ul><li><a href=/notes/ddia/1/>1. Data System and Data Model</a></li><li><a href=/notes/ddia/2/>2. Storage, Query, Encoding</a></li><li><a href=/notes/ddia/3/>3. Replication and Partition</a></li></ul></li><li><input type=checkbox id=section-8c64db930c5b756022bf5d3ba1af6015 class=toggle>
<label for=section-8c64db930c5b756022bf5d3ba1af6015 class="flex justify-between"><a href=/notes/in-depth-jvm/>In-depth Understanding JVM</a></label><ul><li><a href=/notes/in-depth-jvm/gc/>Garbage Collection</a></li><li><a href=/notes/in-depth-jvm/synchronization/>Java Synchronization</a></li><li><a href=/notes/in-depth-jvm/memory-model/>JVM Memory Model</a></li><li><a href=/notes/in-depth-jvm/memory-region/>JVM Memory Regions</a></li><li><a href=/notes/in-depth-jvm/threadlocal-reference/>ThreadLocal and Reference</a></li></ul></li><li><input type=checkbox id=section-15259ec15aa2cb7859c77500905f6b03 class=toggle>
<label for=section-15259ec15aa2cb7859c77500905f6b03 class="flex justify-between"><a href=/notes/intro-algo/>Introduction to Algorithms</a></label><ul><li><a href=/notes/intro-algo/1/>1. Compexity, Divide</a></li><li><a href=/notes/intro-algo/2/>2. Sorting, Order Statistic</a></li><li><a href=/notes/intro-algo/3/>3. LinkedList, HashTable</a></li><li><a href=/notes/intro-algo/4/>4. BST, Balanced BSTs</a></li><li><a href=/notes/intro-algo/5/>5. Trie-Tree, Extending Data Structures</a></li><li><a href=/notes/intro-algo/6/>6. Dynamic Programming, Greedy, Amortize</a></li><li><a href=/notes/intro-algo/7/>7. B-Tree, Fibonacci Heap, vEB Tree</a></li><li><a href=/notes/intro-algo/8/>8. Graphs</a></li></ul></li><li><input type=checkbox id=section-3efdc8e38ef7f47959bf45f30a9dec98 class=toggle>
<label for=section-3efdc8e38ef7f47959bf45f30a9dec98 class="flex justify-between"><a href=/notes/programming-scala/>Programming in Scala</a></label><ul><li><a href=/notes/programming-scala/1/>1. Basics</a></li><li><a href=/notes/programming-scala/2/>2. Functions</a></li><li><a href=/notes/programming-scala/3/>3 .Inheritance, Package, Assertion</a></li><li><a href=/notes/programming-scala/4/>4. Pattern Matching, Collections</a></li><li><a href=/notes/programming-scala/5/>5. Generics, Abstract, Implicits</a></li><li><a href=/notes/programming-scala/6/>6. Collections, Extractor, etc</a></li></ul></li></ul></li><li><input type=checkbox id=section-ebdb83a62411872593631ee1e4ab41d9 class=toggle>
<label for=section-ebdb83a62411872593631ee1e4ab41d9 class="flex justify-between"><a href=/pl/>Programming Languages</a></label><ul><li><a href=/pl/java-nio-2/>Java NIO Internal</a></li><li><a href=/pl/java-nio-1/>Java NIO Usage</a></li><li><a href=/pl/lambda/>Lambda Calculus and Y Combinator</a></li><li><a href=/pl/curry/>Scala: Currying, Partially Applied, Partial</a></li><li><a href=/pl/monad/>Scala: Monad, from Scala Perspective</a></li></ul></li></ul><ul><li><a href=https://github.com/czdm75 target=_blank rel=noopener>GitHub</a></li><li><a href=https://themes.gohugo.io/hugo-book/ target=_blank rel=noopener>Theme</a></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu>
</label><strong>5. Generics</strong>
<label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#使用泛型>使用泛型</a><ul><li><a href=#泛型方法>泛型方法</a></li><li><a href=#类型限定>类型限定</a></li><li><a href=#类型变异和通配符>类型变异和通配符</a><ul><li><a href=#父子类型>父子类型</a></li><li><a href=#带类型变量的通配符>带类型变量的通配符</a></li><li><a href=#通配符捕获>通配符捕获</a></li></ul></li></ul></li><li><a href=#jvm-中的泛型>JVM 中的泛型</a><ul><li><a href=#类型擦除>类型擦除</a></li><li><a href=#桥方法>桥方法</a></li><li><a href=#泛型约束>泛型约束</a><ul><li><a href=#cast-中的问题>cast 中的问题</a></li><li><a href=#实例化泛型变量>实例化泛型变量</a></li><li><a href=#参数化类型的数组>参数化类型的数组</a></li><li><a href=#静态上下文>静态上下文</a></li><li><a href=#方法冲突>方法冲突</a></li></ul></li><li><a href=#异常与泛型>异常与泛型</a></li><li><a href=#反射与泛型>反射与泛型</a></li></ul></li></ul></nav></aside></header><article class=markdown><h1 id=使用泛型>使用泛型
<a class=anchor href=#%e4%bd%bf%e7%94%a8%e6%b3%9b%e5%9e%8b>#</a></h1><h2 id=泛型方法>泛型方法
<a class=anchor href=#%e6%b3%9b%e5%9e%8b%e6%96%b9%e6%b3%95>#</a></h2><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:green;font-weight:700>public</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>class</span> <span style=color:#00f;font-weight:700>Arrays</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>public</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>static</span><span style=color:#bbb> </span><span style=color:#666>&lt;</span>T<span style=color:#666>&gt;</span><span style=color:#bbb> </span><span style=color:#b00040>void</span><span style=color:#bbb> </span><span style=color:#00f>swap</span>(T<span style=color:#666>[]</span><span style=color:#bbb> </span>array<span style=color:#bbb> </span><span style=color:#b00040>int</span><span style=color:#bbb> </span>i,<span style=color:#bbb> </span><span style=color:#b00040>int</span><span style=color:#bbb> </span>j)<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>...<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#408080;font-style:italic>// call</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>Arrays.<span style=color:#7d9029>swap</span>(arr,<span style=color:#bbb> </span>1<span style=color:#bbb> </span>,2);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>Arrays.<span style=color:#666>&lt;</span>String<span style=color:#666>&gt;</span><span style=color:#bbb> </span><span style=color:#00f>swap</span>(arr,<span style=color:#bbb> </span>1,<span style=color:#bbb> </span>2);<span style=color:#bbb>  </span><span style=color:#408080;font-style:italic>// for better error message</span><span style=color:#bbb>
</span></span></span></code></pre></div><h2 id=类型限定>类型限定
<a class=anchor href=#%e7%b1%bb%e5%9e%8b%e9%99%90%e5%ae%9a>#</a></h2><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#408080;font-style:italic>// for an arraylist</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>public</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>static</span><span style=color:#bbb> </span><span style=color:#666>&lt;</span>T<span style=color:#bbb> </span><span style=color:green;font-weight:700>extends</span><span style=color:#bbb> </span>AutoClosable<span style=color:#666>&gt;</span><span style=color:#bbb> </span><span style=color:#b00040>void</span><span style=color:#bbb> </span><span style=color:#00f>closeAll</span>(ArrayList<span style=color:#666>&lt;</span>T<span style=color:#666>&gt;</span><span style=color:#bbb> </span>elems)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>throws</span><span style=color:#bbb> </span>Exception<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>for</span><span style=color:#bbb> </span>(T<span style=color:#bbb> </span>elem<span style=color:#bbb> </span>:<span style=color:#bbb> </span>elems)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>elem.<span style=color:#7d9029>close</span>();<span style=color:#bbb>  </span><span style=color:#408080;font-style:italic>// an method in interface AutoClosable</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#408080;font-style:italic>//for an array, no need for generic</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>public</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>static</span><span style=color:#bbb> </span><span style=color:#b00040>void</span><span style=color:#bbb> </span><span style=color:#00f>closeAll</span>(AutoClosable<span style=color:#666>[]</span><span style=color:#bbb> </span>elems)<span style=color:#bbb> </span><span style=color:green;font-weight:700>throws</span><span style=color:#bbb> </span>Exception<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>...<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span></code></pre></div><p>这是因为，<code>PrintStream[]</code> 是 <code>AutoClosable[]</code> 的子类，而 <code>ArrayList&lt;PrintStream></code> 并不是 <code>ArrayList&lt;AutoClosable></code> 的子类。也可以同时限定多个类型：</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>T<span style=color:#bbb> </span><span style=color:green;font-weight:700>extends</span><span style=color:#bbb> </span>Runnable<span style=color:#bbb> </span><span style=color:#666>&amp;</span><span style=color:#bbb> </span>AutoClosable<span style=color:#bbb>
</span></span></span></code></pre></div><h2 id=类型变异和通配符>类型变异和通配符
<a class=anchor href=#%e7%b1%bb%e5%9e%8b%e5%8f%98%e5%bc%82%e5%92%8c%e9%80%9a%e9%85%8d%e7%ac%a6>#</a></h2><p>上面我们看到，子类数组是父类数组的子类。数组随其元素而变化，这种行为称为<strong>协变性</strong>（covariance）。但 <code>ArrayList</code> 并不是协变的。这是为了防止之前提到过的异常。因此，需要使用通配符来限制类型，这种类型有时称为<strong>使用时变化</strong>（use-site variance）。</p><h3 id=父子类型>父子类型
<a class=anchor href=#%e7%88%b6%e5%ad%90%e7%b1%bb%e5%9e%8b>#</a></h3><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:green;font-weight:700>public</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>static</span><span style=color:#bbb> </span><span style=color:#b00040>void</span><span style=color:#bbb> </span><span style=color:#00f>printNames</span>(ArrayList<span style=color:#666>&lt;?</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>extends</span><span style=color:#bbb> </span>Employee<span style=color:#666>&gt;</span><span style=color:#bbb> </span>staff)<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#408080;font-style:italic>//use Employee methods only</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>Employee<span style=color:#bbb> </span>e<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>staff.<span style=color:#7d9029>get</span>(i);<span style=color:#bbb>  </span><span style=color:#408080;font-style:italic>// legal</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>staff.<span style=color:#7d9029>add</span>(<span style=color:green;font-weight:700>new</span><span style=color:#bbb> </span>Employee());<span style=color:#bbb>  </span><span style=color:#408080;font-style:italic>// illegal. same with subtypes of employee</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span></code></pre></div><p>这样，实际上这种写法是只读的。类似地：</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:green;font-weight:700>public</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>static</span><span style=color:#bbb> </span><span style=color:#b00040>void</span><span style=color:#bbb> </span><span style=color:#00f>insert</span>(ArrayList<span style=color:#666>&lt;?</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>super</span><span style=color:#bbb> </span>employee<span style=color:#666>&gt;</span><span style=color:#bbb> </span>staff)<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#408080;font-style:italic>//a weird method, only for test</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#408080;font-style:italic>//accept supertypes of Employee</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>staff.<span style=color:#7d9029>add</span>(<span style=color:green;font-weight:700>new</span><span style=color:#bbb> </span>Employee());<span style=color:#bbb>  </span><span style=color:#408080;font-style:italic>// legal. for ? is supertype of employee</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>Employee<span style=color:#bbb> </span>e<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>staff.<span style=color:#7d9029>get</span>(0);<span style=color:#bbb>  </span><span style=color:#408080;font-style:italic>//illegal.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span></code></pre></div><p>在这里，相当于集合变成了只能写入的。这叫做<strong>逆变</strong>。由于这个原因，一个口诀叫做 &ldquo;PECS&rdquo;，即 &ldquo;Producer excents Comsumer super&rdquo;。也是由于这个原因，C# 在这里使用了 <code>in</code> 和 <code>out</code> 关键字。</p><h3 id=带类型变量的通配符>带类型变量的通配符
<a class=anchor href=#%e5%b8%a6%e7%b1%bb%e5%9e%8b%e5%8f%98%e9%87%8f%e7%9a%84%e9%80%9a%e9%85%8d%e7%ac%a6>#</a></h3><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:green;font-weight:700>public</span><span style=color:#bbb> </span>Collections<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>public</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>static</span><span style=color:#bbb> </span><span style=color:#666>&lt;</span>T<span style=color:#bbb> </span><span style=color:green;font-weight:700>extends</span><span style=color:#bbb> </span>Comparable<span style=color:#666>&lt;?</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>super</span><span style=color:#bbb> </span>T<span style=color:#666>&gt;&gt;</span><span style=color:#bbb> </span><span style=color:#b00040>void</span><span style=color:#bbb> </span><span style=color:#00f>sort</span>(List<span style=color:#666>&lt;</span>T<span style=color:#666>&gt;</span><span style=color:#bbb> </span>list);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span></code></pre></div><p>仍然使用员工和经理的例子。设想 <code>T</code> 是 <code>Manager</code> 的情况。</p><p><code>Employee</code> 实现了 <code>Comparable&lt;Employee></code>，<code>Manager</code> 继承了 <code>Employee</code>。这时，<code>Manager</code> 实现的是 <code>Comparable&lt;Employee></code> 接口，而非 <code>Comparable&lt;Manager></code> 接口。很容易理解，因为 <code>Comparable&lt;Manager></code> 并不是 <code>Comaprable&lt;Employee></code> 的子类。</p><p>因此，这里使用的必须是 <code>Comparable&lt;? super T></code>，这样才能匹配到 <code>Comparable&lt;Employee></code>。然后，这个方法显然应该能够接受 <code>Manager</code> 的子类，因此最终的泛型为 <code>T extends Comparable&lt;? super T></code>。</p><p>C# 和 Scala 等语言在这里使用了声明时协变和逆变的方法，比 Java 的方法更加方便直观，但不那么强大。</p><h3 id=通配符捕获>通配符捕获
<a class=anchor href=#%e9%80%9a%e9%85%8d%e7%ac%a6%e6%8d%95%e8%8e%b7>#</a></h3><p>尝试写一个 swap 方法：</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:green;font-weight:700>public</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>static</span><span style=color:#bbb> </span><span style=color:#b00040>void</span><span style=color:#bbb> </span><span style=color:#00f>swap</span>(ArrayList<span style=color:#666>&lt;?&gt;</span><span style=color:#bbb> </span>elements,<span style=color:#bbb> </span><span style=color:#b00040>int</span><span style=color:#bbb> </span>i,<span style=color:#bbb> </span><span style=color:#b00040>int</span><span style=color:#bbb> </span>j)<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#666>?</span><span style=color:#bbb> </span>temp<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>...<span style=color:#bbb>  </span><span style=color:#408080;font-style:italic>// ????</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span></code></pre></div><p>除了使用 Object 之外，还有另一种方法来绕过这个问题：</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:green;font-weight:700>public</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>static</span><span style=color:#bbb> </span><span style=color:#b00040>void</span><span style=color:#bbb> </span><span style=color:#00f>swap</span>(ArrayList<span style=color:#666>&lt;?&gt;</span><span style=color:#bbb> </span>elems,<span style=color:#bbb> </span><span style=color:#b00040>int</span><span style=color:#bbb> </span>i,<span style=color:#bbb> </span><span style=color:#b00040>int</span><span style=color:#bbb> </span>j)<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>swapHelper(elems,<span style=color:#bbb> </span>i,<span style=color:#bbb> </span>j);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>public</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>static</span><span style=color:#bbb> </span><span style=color:#666>&lt;</span>T<span style=color:#666>&gt;</span><span style=color:#bbb> </span><span style=color:#b00040>void</span><span style=color:#bbb> </span><span style=color:#00f>swapHelper</span>(ArrayList<span style=color:#666>&lt;</span>T<span style=color:#666>&gt;</span><span style=color:#bbb> </span>elems,<span style=color:#bbb> </span><span style=color:#b00040>int</span><span style=color:#bbb> </span>i,<span style=color:#bbb> </span><span style=color:#b00040>int</span><span style=color:#bbb> </span>j)<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>T<span style=color:#bbb> </span>temp<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>...<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span></code></pre></div><p>虽然我们不知道 <code>T</code> 是什么，但我们知道它一定是一个类型。相当于我们"捕获"了这个通配符。这样做的目的是，暴露出一个容易理解的 <code>&lt;?></code> 的 API 接口，而不是令人困惑的泛型方法。</p><h1 id=jvm-中的泛型>JVM 中的泛型
<a class=anchor href=#jvm-%e4%b8%ad%e7%9a%84%e6%b3%9b%e5%9e%8b>#</a></h1><h2 id=类型擦除>类型擦除
<a class=anchor href=#%e7%b1%bb%e5%9e%8b%e6%93%a6%e9%99%a4>#</a></h2><p>对于 <code>Entry&lt;K, V></code>，会转变成：</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:green;font-weight:700>public</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>class</span> <span style=color:#00f;font-weight:700>Entry</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>private</span><span style=color:#bbb> </span>Object<span style=color:#bbb> </span>key;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>private</span><span style=color:#bbb> </span>Object<span style=color:#bbb> </span>value;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>...<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span></code></pre></div><p>类似地，对于 <code>Entry&lt;K entends Comparable&lt;? super K> & Serializable, V extends Serializable></code> ：</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:green;font-weight:700>public</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>class</span> <span style=color:#00f;font-weight:700>Entry</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>private</span><span style=color:#bbb> </span>Comparable<span style=color:#bbb> </span>key;<span style=color:#bbb>  </span><span style=color:#408080;font-style:italic>// 这里失去了一个接口信息，虽然对象本身仍然是同时实现二者的</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>private</span><span style=color:#bbb> </span>Serializable<span style=color:#bbb> </span>value;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>...<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span></code></pre></div><p>对于大部分的方法，由编译器解决了 cast 的问题。因此，仍然可以使用：</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>String<span style=color:#bbb> </span>str<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>getValue();<span style=color:#bbb>
</span></span></span></code></pre></div><h2 id=桥方法>桥方法
<a class=anchor href=#%e6%a1%a5%e6%96%b9%e6%b3%95>#</a></h2><p>桥方法是编译器在泛型类型和协变返回类型中做的一个 trick。例如，考虑：</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:green;font-weight:700>public</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>class</span> <span style=color:#00f;font-weight:700>WordList</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>extends</span><span style=color:#bbb> </span>ArrayList<span style=color:#666>&lt;</span>String<span style=color:#666>&gt;</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>public</span><span style=color:#bbb> </span><span style=color:#b00040>void</span><span style=color:#bbb> </span><span style=color:#00f>add</span>(String<span style=color:#bbb> </span>e)<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>...<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>ArrayList<span style=color:#666>&lt;</span>String<span style=color:#666>&gt;</span><span style=color:#bbb> </span>strings<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>new</span><span style=color:#bbb> </span>WordList(...);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>strings.<span style=color:#7d9029>add</span>(<span style=color:#ba2121>&#34;abc&#34;</span>);<span style=color:#bbb>
</span></span></span></code></pre></div><p>这时，理论情况下，就会调用 <code>ArrayList&lt;String></code> 的 <code>add(Object)</code> 方法，而这显然不是我们想要的。因此，Java 编译器偷偷生成了一个方法：</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:green;font-weight:700>public</span><span style=color:#bbb> </span><span style=color:#b00040>void</span><span style=color:#bbb> </span><span style=color:#00f>add</span>(Object<span style=color:#bbb> </span>e)<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>add((String)e);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span></code></pre></div><p>对于返回泛型对象的情况，也是一样的处理。</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>String<span style=color:#bbb> </span><span style=color:#00f>get</span>(<span style=color:#b00040>int</span>);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>Object<span style=color:#bbb> </span><span style=color:#00f>get</span>(<span style=color:#b00040>int</span>);<span style=color:#bbb>
</span></span></span></code></pre></div><p>在 Java 语言中不能定义这样的两个方法，但在字节码中可以。总之，javac 通过这种方法让泛型类型的使用看起来更加自然。</p><h2 id=泛型约束>泛型约束
<a class=anchor href=#%e6%b3%9b%e5%9e%8b%e7%ba%a6%e6%9d%9f>#</a></h2><p>绝大部分是由于类型擦除机制，Java 的泛型使用存在一些限制。首先，泛型参数必须是对象，而非基本类型。</p><h3 id=cast-中的问题>cast 中的问题
<a class=anchor href=#cast-%e4%b8%ad%e7%9a%84%e9%97%ae%e9%a2%98>#</a></h3><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:green;font-weight:700>if</span><span style=color:#bbb> </span>(a<span style=color:#bbb> </span><span style=color:green;font-weight:700>instanceof</span><span style=color:#bbb> </span>ArrayList<span style=color:#666>&lt;</span>String<span style=color:#666>&gt;</span>);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#408080;font-style:italic>// Runtime Error, for no generic type</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>ArrayList<span style=color:#666>&lt;</span>String<span style=color:#666>&gt;</span><span style=color:#bbb> </span>list<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>(ArrayList<span style=color:#666>&lt;</span>String<span style=color:#666>&gt;</span>)<span style=color:#bbb> </span>result;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#408080;font-style:italic>// warning, only confirm is arryalist, but maybe not string</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#408080;font-style:italic>// @SuppressWarnings(&#34;unchecked&#34;)</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#408080;font-style:italic>// if wrong type, will throw ClassCastException</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>ArrayList<span style=color:#666>&lt;</span>String<span style=color:#666>&gt;</span>.<span style=color:#7d9029>class</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#408080;font-style:italic>// ArrayList, no generic</span><span style=color:#bbb>
</span></span></span></code></pre></div><h3 id=实例化泛型变量>实例化泛型变量
<a class=anchor href=#%e5%ae%9e%e4%be%8b%e5%8c%96%e6%b3%9b%e5%9e%8b%e5%8f%98%e9%87%8f>#</a></h3><p>同样是由于类型擦除，我们无法使用 <code>new T()</code> 或 <code>new T[]</code> 这些表达式。这时，可以使用反射机制，使用方法引用，或者手动传入一个数组。</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#408080;font-style:italic>// use method reference</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>public</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>static</span><span style=color:#bbb> </span><span style=color:#666>&lt;</span>T<span style=color:#666>&gt;</span><span style=color:#bbb> </span>T<span style=color:#666>[]</span><span style=color:#bbb> </span><span style=color:#00f>repeat</span>(<span style=color:#b00040>int</span><span style=color:#bbb> </span>n,<span style=color:#bbb> </span>T<span style=color:#bbb> </span>obj,<span style=color:#bbb> </span>IntFunction<span style=color:#666>&lt;</span>T<span style=color:#666>[]</span>)<span style=color:#bbb> </span>constr)<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>T<span style=color:#666>[]</span><span style=color:#bbb> </span>result<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>constr.<span style=color:#7d9029>apply</span>(n);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>...<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#408080;font-style:italic>// call</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>String<span style=color:#bbb> </span>strs<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>repeat(10,<span style=color:#bbb> </span><span style=color:#ba2121>&#34;abc&#34;</span>,<span style=color:#bbb> </span>String::<span style=color:green;font-weight:700>new</span>);<span style=color:#bbb>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#408080;font-style:italic>// use reflection</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>public</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>static</span><span style=color:#bbb> </span><span style=color:#666>&lt;</span>T<span style=color:#666>&gt;</span><span style=color:#bbb> </span>T<span style=color:#666>[]</span><span style=color:#bbb> </span><span style=color:#00f>repeat</span>(<span style=color:#b00040>int</span><span style=color:#bbb> </span>n,<span style=color:#bbb> </span>T<span style=color:#bbb> </span>obj,<span style=color:#bbb> </span>Class<span style=color:#666>&lt;</span>T<span style=color:#666>&gt;</span><span style=color:#bbb> </span>cl)<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#a2f>@SuppressWarnings</span>(<span style=color:#ba2121>&#34;unchecked&#34;</span>)<span style=color:#bbb> </span>T<span style=color:#666>[]</span><span style=color:#bbb> </span>result<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>(T<span style=color:#666>[]</span>)<span style=color:#bbb> </span>java.<span style=color:#7d9029>lang</span>.<span style=color:#7d9029>reflect</span>.<span style=color:#7d9029>Array</span>.<span style=color:#7d9029>newInstance</span>(cl,<span style=color:#bbb> </span>n);<span style=color:#bbb>  </span><span style=color:#408080;font-style:italic>// similar for objects</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>...<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#408080;font-style:italic>// call</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>String<span style=color:#666>[]</span><span style=color:#bbb> </span>strs<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>repeat(10,<span style=color:#bbb> </span><span style=color:#ba2121>&#34;abc&#34;</span>,<span style=color:#bbb> </span>String.<span style=color:#7d9029>class</span>);<span style=color:#bbb>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#408080;font-style:italic>// use array param</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>public</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>static</span><span style=color:#bbb> </span><span style=color:#666>&lt;</span>T<span style=color:#666>&gt;</span><span style=color:#bbb> </span>T<span style=color:#666>[]</span><span style=color:#bbb> </span><span style=color:#00f>repeat</span>(<span style=color:#b00040>int</span><span style=color:#bbb> </span>n,<span style=color:#bbb> </span>T<span style=color:#bbb> </span>obj,<span style=color:#bbb> </span>T<span style=color:#666>[]</span><span style=color:#bbb> </span>array)<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>T<span style=color:#666>[]</span><span style=color:#bbb> </span>result;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>if</span><span style=color:#bbb> </span>(array.<span style=color:#7d9029>length</span><span style=color:#bbb> </span><span style=color:#666>&gt;=</span><span style=color:#bbb> </span>n)<span style=color:#bbb>  </span><span style=color:#408080;font-style:italic>// enough space</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>result<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>array;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>else</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#408080;font-style:italic>// use reflection like above</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#408080;font-style:italic>// java.lang.reflect.Array.newInstance(array.getClass().getComponentType(), n)</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>...<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span></code></pre></div><p>当然，最简单的办法还是依旧返回一个泛型对象，推荐使用这种方法：</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:green;font-weight:700>public</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>static</span><span style=color:#bbb> </span><span style=color:#666>&lt;</span>T<span style=color:#666>&gt;</span><span style=color:#bbb> </span>ArrayList<span style=color:#666>&lt;</span>T<span style=color:#666>&gt;</span><span style=color:#bbb> </span><span style=color:#00f>repeat</span>(<span style=color:#b00040>int</span><span style=color:#bbb> </span>n,<span style=color:#bbb> </span>T<span style=color:#bbb> </span>obj);<span style=color:#bbb>
</span></span></span></code></pre></div><p>如果需要在泛型类内使用戒；数组，那么直接使用 <code>Object[]</code> 就可以了。这也是 <code>ArrayList</code> 内部的实现方法。</p><h3 id=参数化类型的数组>参数化类型的数组
<a class=anchor href=#%e5%8f%82%e6%95%b0%e5%8c%96%e7%b1%bb%e5%9e%8b%e7%9a%84%e6%95%b0%e7%bb%84>#</a></h3><p>由于泛型类型和数组的实现有所不同，二者相遇时就会需要一些技巧。例如，直接赋给一个包含泛型类型的数组是不可以的，回忆之前我们提到过的 <code>ArrayStoreException</code>。</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>Entry<span style=color:#666>&lt;</span>String.<span style=color:#bbb> </span>Integer<span style=color:#666>&gt;[]</span><span style=color:#bbb> </span>entries<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>new</span><span style=color:#bbb> </span>Entry<span style=color:#666>&lt;</span>String,<span style=color:#bbb> </span>Integer<span style=color:#666>&gt;[</span>100<span style=color:#666>]</span>;<span style=color:#bbb>  </span><span style=color:#408080;font-style:italic>// Wrong Grammar</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>实际上，这个对象类型是正确的，只是初始化过程不合法。因此：</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a2f>@SuppressWarnings</span>(<span style=color:#ba2121>&#34;unchecked&#34;</span>)<span style=color:#bbb> </span>Entry<span style=color:#666>&lt;</span>String,<span style=color:#bbb> </span>Integer<span style=color:#666>&gt;[]</span><span style=color:#bbb> </span>entries<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>(Entry<span style=color:#666>&lt;</span>String,<span style=color:#bbb> </span>Integer<span style=color:#666>&gt;[]</span>)<span style=color:#bbb> </span><span style=color:green;font-weight:700>new</span><span style=color:#bbb> </span>Entry<span style=color:#666>&lt;?</span>,<span style=color:#bbb> </span><span style=color:#666>?&gt;[</span>100<span style=color:#666>]</span>;<span style=color:#bbb>
</span></span></span></code></pre></div><p>这里没有规定 <code>Entry</code> 的泛型参数，因为所有类型事实上都是一样的。然后，使用一个带泛型的引用来管理它。当然，直接使用支持泛型的 <code>ArrayList</code> 仍然简单得多。</p><p>还有一种可以实例化泛型数组的位置是可变参数。</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a2f>@SafeVarargs</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>public</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>static</span><span style=color:#bbb> </span><span style=color:#666>&lt;</span>T<span style=color:#666>&gt;</span><span style=color:#bbb> </span>ArrayList<span style=color:#666>&lt;</span>T<span style=color:#666>&gt;</span><span style=color:#bbb> </span><span style=color:#00f>asList</span>(T...<span style=color:#bbb> </span>elems);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#408080;font-style:italic>// call</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>ArrayList<span style=color:#666>&lt;</span>Entry<span style=color:#666>&lt;</span>String,<span style=color:#bbb> </span>Integer<span style=color:#666>&gt;&gt;</span><span style=color:#bbb> </span>entries<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>Lists.<span style=color:#7d9029>asList</span>(entry1);<span style=color:#bbb>  </span><span style=color:#408080;font-style:italic>// OK</span><span style=color:#bbb>
</span></span></span></code></pre></div><h3 id=静态上下文>静态上下文
<a class=anchor href=#%e9%9d%99%e6%80%81%e4%b8%8a%e4%b8%8b%e6%96%87>#</a></h3><p>再次考虑：泛型可以认为是由引用来处理的，各种不同泛型的同类对象都是相同的。因此，静态方法和变量不能接受泛型类型。或者说，静态方法是对于 <code>ArrayList</code> 只有一份，而不是对于各种 <code>T</code> 各有一份。</p><h3 id=方法冲突>方法冲突
<a class=anchor href=#%e6%96%b9%e6%b3%95%e5%86%b2%e7%aa%81>#</a></h3><p>例如，这样一个方法在类型擦除之后会和 <code>Object.equals</code> 冲突，难以发现这个方法事实上完全无效。</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:green;font-weight:700>public</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>interface</span> <span style=color:#00f;font-weight:700>Ordered</span><span style=color:#666>&lt;</span>T<span style=color:#666>&gt;</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>extends</span><span style=color:#bbb> </span>Comparable<span style=color:#666>&lt;</span>T<span style=color:#666>&gt;</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>public</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>default</span><span style=color:#bbb> </span><span style=color:#b00040>boolean</span><span style=color:#bbb> </span><span style=color:#00f>equals</span>(T<span style=color:#bbb> </span>value)<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>...<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span></code></pre></div><p>还有一种更加隐蔽的可能：</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:green;font-weight:700>public</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>class</span> <span style=color:#00f;font-weight:700>Employee</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>implements</span><span style=color:#bbb> </span>Comparable<span style=color:#666>&lt;</span>Employee<span style=color:#666>&gt;</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>public</span><span style=color:#bbb> </span><span style=color:#b00040>int</span><span style=color:#bbb> </span><span style=color:#00f>compareTo</span>(Employee<span style=color:#bbb> </span>other)<span style=color:#bbb> </span>{...}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>public</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>class</span> <span style=color:#00f;font-weight:700>Manager</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>extends</span><span style=color:#bbb> </span>Employee<span style=color:#bbb> </span><span style=color:green;font-weight:700>implements</span><span style=color:#bbb> </span>Comparable<span style=color:#666>&lt;</span>Manager<span style=color:#666>&gt;</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>public</span><span style=color:#bbb> </span><span style=color:#b00040>int</span><span style=color:#bbb> </span><span style=color:#00f>compareTo</span>(Manager<span style=color:#bbb> </span>other)<span style=color:#bbb> </span>{...}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span></code></pre></div><p>这时，虽然这两个方法没有关系，但我们之前提到的桥方法发生了互相冲突。</p><h2 id=异常与泛型>异常与泛型
<a class=anchor href=#%e5%bc%82%e5%b8%b8%e4%b8%8e%e6%b3%9b%e5%9e%8b>#</a></h2><p><code>Throwable</code> 的子类不能是泛型的。也就是说，不存在泛型异常。类似地，也不能 <code>catch(T ex)</code>。不过，可以在方法声明中声明一个类型参数：</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:green;font-weight:700>public</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>static</span><span style=color:#bbb> </span><span style=color:#666>&lt;</span>V,<span style=color:#bbb> </span>T<span style=color:#666>&gt;</span><span style=color:#bbb> </span>V<span style=color:#bbb> </span><span style=color:#00f>fun</span>(Callable<span style=color:#666>&lt;</span>V<span style=color:#666>&gt;</span><span style=color:#bbb> </span>c,<span style=color:#bbb> </span>T<span style=color:#bbb> </span>ex)<span style=color:#bbb> </span><span style=color:green;font-weight:700>throws</span><span style=color:#bbb> </span>T<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>...<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span></code></pre></div><p>有可能通过泛型来绕开 Checked Exception 机制，因为泛型过程并不知道类型是 Checked Exception 还是 Unchecked Exception。</p><h2 id=反射与泛型>反射与泛型
<a class=anchor href=#%e5%8f%8d%e5%b0%84%e4%b8%8e%e6%b3%9b%e5%9e%8b>#</a></h2><p>前面我们已经知道，<code>Class</code> 类是泛型的。这样做的目的是为 <code>newInstance</code> <code>cast</code> 等方法提供方便：</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:green;font-weight:700>public</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>class</span><span>&lt;</span><span style=color:#00f;font-weight:700>T</span><span style=color:#666>&gt;</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>public</span><span style=color:#bbb> </span>T<span style=color:#bbb> </span><span style=color:#00f>newInstance</span>()<span style=color:#bbb> </span><span style=color:green;font-weight:700>throws</span><span style=color:#bbb> </span>...<span style=color:#bbb> </span>{...}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>public</span><span style=color:#bbb> </span>Class<span style=color:#666>&lt;?</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>super</span><span style=color:#bbb> </span>T<span style=color:#666>&gt;</span><span style=color:#bbb> </span><span style=color:#00f>getSuperClass</span>()<span style=color:#bbb> </span>{...}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>public</span><span style=color:#bbb> </span><span style=color:#666>&lt;</span>U<span style=color:#666>&gt;</span><span style=color:#bbb> </span>Class<span style=color:#666>&lt;?</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>extends</span><span style=color:#bbb> </span>U<span style=color:#666>&gt;</span><span style=color:#bbb> </span><span style=color:#00f>asSubClass</span>(Class<span style=color:#666>&lt;</span>U<span style=color:#666>&gt;</span><span style=color:#bbb> </span>clazz)<span style=color:#bbb> </span>{...}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>public</span><span style=color:#bbb> </span>T<span style=color:#bbb> </span><span style=color:#00f>cast</span>(Object<span style=color:#bbb> </span>obj)<span style=color:#bbb> </span>{...}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>public</span><span style=color:#bbb> </span>Constructor<span style=color:#666>&lt;</span>T<span style=color:#666>&gt;</span><span style=color:#bbb> </span><span style=color:#00f>getConstructor</span>(Class<span style=color:#666>&lt;?&gt;</span>...<span style=color:#bbb> </span>parameterTypes)<span style=color:#bbb> </span>{...}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>public</span><span style=color:#bbb> </span>Constructor<span style=color:#666>&lt;</span>T<span style=color:#666>&gt;</span><span style=color:#bbb> </span><span style=color:#00f>getDeclaredConstructor</span>(Class<span style=color:#666>&lt;?&gt;</span>...<span style=color:#bbb> </span>parameterTypes)<span style=color:#bbb> </span>{...}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>T<span style=color:#666>[]</span><span style=color:#bbb> </span><span style=color:#00f>getEnumConstants</span>()<span style=color:#bbb> </span>{...}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span></code></pre></div><p>大多数情况下，我们直接使用 <code>Class&lt;?></code>，因为我们并不知道对象的实际类。</p><p><code>java.lang.reflect</code> 包中与泛型相关的接口包括：描述类型变量的 <code>Typevariable</code>，描述通配符的 <code>WildcardType</code>，描述泛型类和泛型接口的 <code>ParameterizedType</code>，描述泛型数组（<code>T[]</code>）的 <code>GenericArrayType</code>。</p></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#使用泛型>使用泛型</a><ul><li><a href=#泛型方法>泛型方法</a></li><li><a href=#类型限定>类型限定</a></li><li><a href=#类型变异和通配符>类型变异和通配符</a><ul><li><a href=#父子类型>父子类型</a></li><li><a href=#带类型变量的通配符>带类型变量的通配符</a></li><li><a href=#通配符捕获>通配符捕获</a></li></ul></li></ul></li><li><a href=#jvm-中的泛型>JVM 中的泛型</a><ul><li><a href=#类型擦除>类型擦除</a></li><li><a href=#桥方法>桥方法</a></li><li><a href=#泛型约束>泛型约束</a><ul><li><a href=#cast-中的问题>cast 中的问题</a></li><li><a href=#实例化泛型变量>实例化泛型变量</a></li><li><a href=#参数化类型的数组>参数化类型的数组</a></li><li><a href=#静态上下文>静态上下文</a></li><li><a href=#方法冲突>方法冲突</a></li></ul></li><li><a href=#异常与泛型>异常与泛型</a></li><li><a href=#反射与泛型>反射与泛型</a></li></ul></li></ul></nav></div></aside></main></body></html>