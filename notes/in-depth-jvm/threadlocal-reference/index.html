<!doctype html><html lang=en dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="ThreadLocal 与 Java 中的引用 # ThreadLocal 类 # ThreadLocal<T> 类可以被赋值，并会将自身作为 key，值作为 value 存入 Thread 对象中的 ThreadLocalMap 中。这样，就能够保证使用这个类包装的变量仅存在于当前线程。而且，即使两个线程分别访问同一个 ThreadLocal 对象，从 get() 方法获取到的值也都是各自线程中的值。
void func() { tl.set(Thread.currentThread().getName()); System.out.println(tl.get()); } ThreadLocal<String> tl = new ThreadLocal<>(); new Thread(() -> {this::func}).start(); // Thread-0 new Thread(() -> {this::func}).start(); // Thread-1 构造 # ThreadLocal<T> 类的构造方法没有任何内容和参数。
每个对象有一个 final int threadLocalHashCode。这个变量的值由静态构造，来自一个 AtomicInteger 累加上一个魔法值。这个魔法值以尽量避免碰撞为依据。这个变量最终会被用在 ThreadLocalMap 的 hash 过程中。
set 方法 # set(T value) 方法接收要传入的值，使用 getMap(Thread t) 方法得到当前所在线程的 ThreadLocalMap。如果结果为 null，就调用 createMap(Thread t, Object value)。否则，直接将参数值存入到 map 中：map."><meta name=theme-color content="#FFFFFF"><meta name=color-scheme content="light dark"><meta property="og:url" content="/notes/in-depth-jvm/threadlocal-reference/"><meta property="og:site_name" content="czdm75 Blog"><meta property="og:title" content="ThreadLocal and Reference"><meta property="og:description" content="ThreadLocal 与 Java 中的引用 # ThreadLocal 类 # ThreadLocal<T> 类可以被赋值，并会将自身作为 key，值作为 value 存入 Thread 对象中的 ThreadLocalMap 中。这样，就能够保证使用这个类包装的变量仅存在于当前线程。而且，即使两个线程分别访问同一个 ThreadLocal 对象，从 get() 方法获取到的值也都是各自线程中的值。
void func() { tl.set(Thread.currentThread().getName()); System.out.println(tl.get()); } ThreadLocal<String> tl = new ThreadLocal<>(); new Thread(() -> {this::func}).start(); // Thread-0 new Thread(() -> {this::func}).start(); // Thread-1 构造 # ThreadLocal<T> 类的构造方法没有任何内容和参数。
每个对象有一个 final int threadLocalHashCode。这个变量的值由静态构造，来自一个 AtomicInteger 累加上一个魔法值。这个魔法值以尽量避免碰撞为依据。这个变量最终会被用在 ThreadLocalMap 的 hash 过程中。
set 方法 # set(T value) 方法接收要传入的值，使用 getMap(Thread t) 方法得到当前所在线程的 ThreadLocalMap。如果结果为 null，就调用 createMap(Thread t, Object value)。否则，直接将参数值存入到 map 中：map."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="notes"><title>ThreadLocal and Reference | czdm75 Blog</title>
<link rel=manifest href=/manifest.json><link rel=icon href=/favicon.png type=image/x-icon><link rel=stylesheet href=/book.min.97cfda4f5e3c9fa49a2bf8d401f4ddc0eec576c99cdcf6afbec19173200c37db.css><script defer src=/flexsearch.min.js></script><script defer src=/en.search.min.f7e98004e6b8d1bafd93b9d4b053644c96b18c50c1205ec6db396c209e97a5a3.js></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>czdm75 Blog</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li><input type=checkbox id=section-7258d8e1fea5a0c302a6de537a7b6f57 class=toggle>
<label for=section-7258d8e1fea5a0c302a6de537a7b6f57 class="flex justify-between"><a href=/cs/>Computer Science</a></label><ul><li><a href=/cs/linux-io-multiplex/>Linux IO Multiplexing</a></li></ul></li><li><input type=checkbox id=section-6c3d93bc59df31a703231f35ad75d678 class=toggle>
<label for=section-6c3d93bc59df31a703231f35ad75d678 class="flex justify-between"><a href=/distributed/>Distributed Systems</a></label><ul><li><a href=/distributed/hadoop-basic/>Hadoop Basic Concepts</a></li><li><a href=/distributed/spark-rdd/>Spark RDD Programming</a></li><li><a href=/distributed/spark-sql/>Spark SQL Programming</a></li></ul></li><li><a href=/notes/>Notes on Books</a><ul><li><input type=checkbox id=section-75aaf2c83c6ed8e1f079c5418c19dad4 class=toggle>
<label for=section-75aaf2c83c6ed8e1f079c5418c19dad4 class="flex justify-between"><a href=/notes/core-java-impatient/>Core Java for Impatients</a></label><ul><li><a href=/notes/core-java-impatient/1/>1. Basic OOP</a></li><li><a href=/notes/core-java-impatient/2/>2. Interface, Lambda</a></li><li><a href=/notes/core-java-impatient/3/>3. Inheritance, Reflection</a></li><li><a href=/notes/core-java-impatient/4/>4. Exception, Logging</a></li><li><a href=/notes/core-java-impatient/5/>5. Generics</a></li><li><a href=/notes/core-java-impatient/6/>6. Collections, Streams</a></li><li><a href=/notes/core-java-impatient/7/>7. IO, Regexp, Serialization</a></li><li><a href=/notes/core-java-impatient/8/>8. Threading</a></li><li><a href=/notes/core-java-impatient/9/>9. Notations</a></li></ul></li><li><input type=checkbox id=section-b2f01d2b22c35e214487b845322f7a58 class=toggle>
<label for=section-b2f01d2b22c35e214487b845322f7a58 class="flex justify-between"><a href=/notes/ddia/>Designing Data-Intensive Applications</a></label><ul><li><a href=/notes/ddia/1/>1. Data System and Data Model</a></li><li><a href=/notes/ddia/2/>2. Storage, Query, Encoding</a></li><li><a href=/notes/ddia/3/>3. Replication and Partition</a></li></ul></li><li><input type=checkbox id=section-8c64db930c5b756022bf5d3ba1af6015 class=toggle checked>
<label for=section-8c64db930c5b756022bf5d3ba1af6015 class="flex justify-between"><a href=/notes/in-depth-jvm/>In-depth Understanding JVM</a></label><ul><li><a href=/notes/in-depth-jvm/gc/>Garbage Collection</a></li><li><a href=/notes/in-depth-jvm/synchronization/>Java Synchronization</a></li><li><a href=/notes/in-depth-jvm/memory-model/>JVM Memory Model</a></li><li><a href=/notes/in-depth-jvm/memory-region/>JVM Memory Regions</a></li><li><a href=/notes/in-depth-jvm/threadlocal-reference/ class=active>ThreadLocal and Reference</a></li></ul></li><li><input type=checkbox id=section-15259ec15aa2cb7859c77500905f6b03 class=toggle>
<label for=section-15259ec15aa2cb7859c77500905f6b03 class="flex justify-between"><a href=/notes/intro-algo/>Introduction to Algorithms</a></label><ul><li><a href=/notes/intro-algo/1/>1. Compexity, Divide</a></li><li><a href=/notes/intro-algo/2/>2. Sorting, Order Statistic</a></li><li><a href=/notes/intro-algo/3/>3. LinkedList, HashTable</a></li><li><a href=/notes/intro-algo/4/>4. BST, Balanced BSTs</a></li><li><a href=/notes/intro-algo/5/>5. Trie-Tree, Extending Data Structures</a></li><li><a href=/notes/intro-algo/6/>6. Dynamic Programming, Greedy, Amortize</a></li><li><a href=/notes/intro-algo/7/>7. B-Tree, Fibonacci Heap, vEB Tree</a></li><li><a href=/notes/intro-algo/8/>8. Graphs</a></li></ul></li><li><input type=checkbox id=section-3efdc8e38ef7f47959bf45f30a9dec98 class=toggle>
<label for=section-3efdc8e38ef7f47959bf45f30a9dec98 class="flex justify-between"><a href=/notes/programming-scala/>Programming in Scala</a></label><ul><li><a href=/notes/programming-scala/1/>1. Basics</a></li><li><a href=/notes/programming-scala/2/>2. Functions</a></li><li><a href=/notes/programming-scala/3/>3 .Inheritance, Package, Assertion</a></li><li><a href=/notes/programming-scala/4/>4. Pattern Matching, Collections</a></li><li><a href=/notes/programming-scala/5/>5. Generics, Abstract, Implicits</a></li><li><a href=/notes/programming-scala/6/>6. Collections, Extractor, etc</a></li></ul></li></ul></li><li><input type=checkbox id=section-ebdb83a62411872593631ee1e4ab41d9 class=toggle>
<label for=section-ebdb83a62411872593631ee1e4ab41d9 class="flex justify-between"><a href=/pl/>Programming Languages</a></label><ul><li><a href=/pl/java-nio-2/>Java NIO Internal</a></li><li><a href=/pl/java-nio-1/>Java NIO Usage</a></li><li><a href=/pl/lambda/>Lambda Calculus and Y Combinator</a></li><li><a href=/pl/curry/>Scala: Currying, Partially Applied, Partial</a></li><li><a href=/pl/monad/>Scala: Monad, from Scala Perspective</a></li></ul></li></ul><ul><li><a href=https://github.com/czdm75 target=_blank rel=noopener>GitHub</a></li><li><a href=https://themes.gohugo.io/hugo-book/ target=_blank rel=noopener>Theme</a></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu>
</label><strong>ThreadLocal and Reference</strong>
<label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#threadlocal-与-java-中的引用>ThreadLocal 与 Java 中的引用</a><ul><li><a href=#threadlocal-类>ThreadLocal 类</a><ul><li><a href=#构造>构造</a></li><li><a href=#set-方法>set 方法</a></li><li><a href=#get-方法>get 方法</a></li><li><a href=#嵌套类-entry>嵌套类 Entry</a></li></ul></li><li><a href=#java-的四种引用>Java 的四种引用</a><ul><li><a href=#软引用和弱引用>软引用和弱引用</a></li><li><a href=#虚引用和引用队列>虚引用和引用队列</a></li></ul></li></ul></li></ul></nav></aside></header><article class=markdown><h1 id=threadlocal-与-java-中的引用>ThreadLocal 与 Java 中的引用
<a class=anchor href=#threadlocal-%e4%b8%8e-java-%e4%b8%ad%e7%9a%84%e5%bc%95%e7%94%a8>#</a></h1><h2 id=threadlocal-类>ThreadLocal 类
<a class=anchor href=#threadlocal-%e7%b1%bb>#</a></h2><p><code>ThreadLocal&lt;T></code> 类可以被赋值，并会将自身作为 key，值作为 value 存入 <code>Thread</code> 对象中的 <code>ThreadLocalMap</code> 中。这样，就能够保证使用这个类包装的变量仅存在于当前线程。而且，即使两个线程分别访问同一个 <code>ThreadLocal</code> 对象，从 <code>get()</code> 方法获取到的值也都是各自线程中的值。</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#b00040>void</span><span style=color:#bbb> </span><span style=color:#00f>func</span>()<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>tl.<span style=color:#7d9029>set</span>(Thread.<span style=color:#7d9029>currentThread</span>().<span style=color:#7d9029>getName</span>());<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>System.<span style=color:#7d9029>out</span>.<span style=color:#7d9029>println</span>(tl.<span style=color:#7d9029>get</span>());<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>ThreadLocal<span style=color:#666>&lt;</span>String<span style=color:#666>&gt;</span><span style=color:#bbb> </span>tl<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>new</span><span style=color:#bbb> </span>ThreadLocal<span style=color:#666>&lt;&gt;</span>();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>new</span><span style=color:#bbb> </span>Thread(()<span style=color:#bbb> </span><span style=color:#666>-&gt;</span><span style=color:#bbb> </span>{<span style=color:green;font-weight:700>this</span>::func}).<span style=color:#7d9029>start</span>();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#408080;font-style:italic>// Thread-0</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>new</span><span style=color:#bbb> </span>Thread(()<span style=color:#bbb> </span><span style=color:#666>-&gt;</span><span style=color:#bbb> </span>{<span style=color:green;font-weight:700>this</span>::func}).<span style=color:#7d9029>start</span>();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#408080;font-style:italic>// Thread-1</span><span style=color:#bbb>
</span></span></span></code></pre></div><h3 id=构造>构造
<a class=anchor href=#%e6%9e%84%e9%80%a0>#</a></h3><p><code>ThreadLocal&lt;T></code> 类的构造方法没有任何内容和参数。</p><p>每个对象有一个 <code>final int threadLocalHashCode</code>。这个变量的值由静态构造，来自一个 <code>AtomicInteger</code> 累加上一个魔法值。这个魔法值以尽量避免碰撞为依据。这个变量最终会被用在 <code>ThreadLocalMap</code> 的 hash 过程中。</p><h3 id=set-方法>set 方法
<a class=anchor href=#set-%e6%96%b9%e6%b3%95>#</a></h3><p><code>set(T value)</code> 方法接收要传入的值，使用 <code>getMap(Thread t)</code> 方法得到当前所在线程的 <code>ThreadLocalMap</code>。如果结果为 null，就调用 <code>createMap(Thread t, Object value)</code>。否则，直接将参数值存入到 map 中：<code>map.set(this, value)</code>。</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>ThreadLocalMap<span style=color:#bbb> </span><span style=color:#00f>getMap</span>(Thread<span style=color:#bbb> </span>t)<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>return</span><span style=color:#bbb> </span>t.<span style=color:#7d9029>threadLocals</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#b00040>void</span><span style=color:#bbb> </span><span style=color:#00f>createMap</span>(Thread<span style=color:#bbb> </span>t,<span style=color:#bbb> </span>T<span style=color:#bbb> </span>firstValue)<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>t.<span style=color:#7d9029>threadLocals</span><span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>new</span><span style=color:#bbb> </span>ThreadLocalMap(<span style=color:green;font-weight:700>this</span>,<span style=color:#bbb> </span>firstValue);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span></code></pre></div><h3 id=get-方法>get 方法
<a class=anchor href=#get-%e6%96%b9%e6%b3%95>#</a></h3><p><code>get()</code> 方法同样首先取得当前线程的 <code>ThreadLocalMap</code>。如果 map 为 null 或当前对象并没有事先 <code>set()</code> 过，则会将 null 作为初始值存入 map 并返回。</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:green;font-weight:700>public</span><span style=color:#bbb> </span>T<span style=color:#bbb> </span><span style=color:#00f>get</span>()<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>Thread<span style=color:#bbb> </span>t<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>Thread.<span style=color:#7d9029>currentThread</span>();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>ThreadLocalMap<span style=color:#bbb> </span>map<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>getMap(t);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>if</span><span style=color:#bbb> </span>(map<span style=color:#bbb> </span><span style=color:#666>!=</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>null</span>)<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>ThreadLocalMap.<span style=color:#7d9029>Entry</span><span style=color:#bbb> </span>e<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>map.<span style=color:#7d9029>getEntry</span>(<span style=color:green;font-weight:700>this</span>);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>if</span><span style=color:#bbb> </span>(e<span style=color:#bbb> </span><span style=color:#666>!=</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>null</span>)<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:#a2f>@SuppressWarnings</span>(<span style=color:#ba2121>&#34;unchecked&#34;</span>)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>T<span style=color:#bbb> </span>result<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>(T)e.<span style=color:#7d9029>value</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>return</span><span style=color:#bbb> </span>result;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>return</span><span style=color:#bbb> </span>setInitialValue();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>private</span><span style=color:#bbb> </span>T<span style=color:#bbb> </span><span style=color:#00f>setInitialValue</span>()<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>T<span style=color:#bbb> </span>value<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>initialValue();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>Thread<span style=color:#bbb> </span>t<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>Thread.<span style=color:#7d9029>currentThread</span>();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>ThreadLocalMap<span style=color:#bbb> </span>map<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>getMap(t);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>if</span><span style=color:#bbb> </span>(map<span style=color:#bbb> </span><span style=color:#666>!=</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>null</span>)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>map.<span style=color:#7d9029>set</span>(<span style=color:green;font-weight:700>this</span>,<span style=color:#bbb> </span>value);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>else</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>createMap(t,<span style=color:#bbb> </span>value);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>return</span><span style=color:#bbb> </span>value;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>protected</span><span style=color:#bbb> </span>T<span style=color:#bbb> </span><span style=color:#00f>initialValue</span>()<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>return</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>null</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span></code></pre></div><h3 id=嵌套类-entry>嵌套类 Entry
<a class=anchor href=#%e5%b5%8c%e5%a5%97%e7%b1%bb-entry>#</a></h3><p><code>new Thread(() -> {this::func}).start();</code> 这个类用于存储实际的 Thread Local 变量，继承了 <code>WeakReference&lt;ThreadLocal&lt;?>></code>。<code>Entry</code> 在 <code>WeakReference</code> 的基础上增加了一个 <code>value</code> 域。</p><p>这个类以父类 <code>WeakReference</code> 中存储的 <code>ThreadLocal</code> 对象为 key，以自己定义的 <code>value</code> 对象为 value，作为 Map 的 Entry 使用。</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:green;font-weight:700>static</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>class</span> <span style=color:#00f;font-weight:700>Entry</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>extends</span><span style=color:#bbb> </span>WeakReference<span style=color:#666>&lt;</span>ThreadLocal<span style=color:#666>&lt;?&gt;&gt;</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#408080;font-style:italic>/** The value associated with this ThreadLocal. */</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>Object<span style=color:#bbb> </span>value;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>Entry(ThreadLocal<span style=color:#666>&lt;?&gt;</span><span style=color:#bbb> </span>k,<span style=color:#bbb> </span>Object<span style=color:#bbb> </span>v)<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>super</span>(k);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>value<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>v;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span></code></pre></div><h2 id=java-的四种引用>Java 的四种引用
<a class=anchor href=#java-%e7%9a%84%e5%9b%9b%e7%a7%8d%e5%bc%95%e7%94%a8>#</a></h2><ul><li>强引用</li><li>软引用</li><li>弱引用</li><li>虚引用</li></ul><p>后三种在 <code>java.lang.ref</code> 包中都有对应的类。它们的父类 <code>Reference</code> 是一个抽象类。由于与这些类有关的很多操作由 JVM 完成，如果需要继承，必须从这三个类继承，而不能直接继承 <code>Reference</code>。</p><h3 id=软引用和弱引用>软引用和弱引用
<a class=anchor href=#%e8%bd%af%e5%bc%95%e7%94%a8%e5%92%8c%e5%bc%b1%e5%bc%95%e7%94%a8>#</a></h3><p><code>java.lang.ref.WeakReference</code> 和 <code>java.lang.ref.SoftReference</code>，二者的功能类似。区别是，软引用的对象只有在内存不足时才会被 GC，而弱引用的对象在失去强引用之后就会直接进入可被 GC 的状态。因此，软引用比弱引用更"强"一些。</p><p>二者的典型应用场景类似于如上的 <code>ThreadLocal</code>：我们在一个集合内维护着所有元素的列表。当代码中已经不再使用这些元素时，这些元素就能够自动离开集合。</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>T<span style=color:#bbb> </span>objs;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>T<span style=color:#bbb> </span>objw;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>SoftReference<span style=color:#bbb> </span>sref<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>new</span><span style=color:#bbb> </span>SoftReference(objs);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>WeakReference<span style=color:#bbb> </span>wref<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>new</span><span style=color:#bbb> </span>WeakReference(objw);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>objs<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>null</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>objw<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>null</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#408080;font-style:italic>// full gc</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>sref.<span style=color:#7d9029>get</span>();<span style=color:#bbb> </span><span style=color:#408080;font-style:italic>// objs</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>wref.<span style=color:#7d9029>get</span>();<span style=color:#bbb> </span><span style=color:#408080;font-style:italic>// null</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#408080;font-style:italic>// null</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>软引用的对象内部有一个时间戳 <code>private long timestamp</code>，其值在每次 <code>get</code> 时被更新为当前时间。具体来说，软引用类内有一个静态变量 <code>static private long clock</code>，其值由垃圾收集器维护。在每次调用 <code>get</code> 方法时，如果引用指向的对象不是 null，就对时间戳进行更新。这个值有利于 GC 的优化。</p><h3 id=虚引用和引用队列>虚引用和引用队列
<a class=anchor href=#%e8%99%9a%e5%bc%95%e7%94%a8%e5%92%8c%e5%bc%95%e7%94%a8%e9%98%9f%e5%88%97>#</a></h3><p>虚引用甚至不能用来访问引用的对象，对其调用 <code>get</code> 只能返回 <code>null</code>。这个类的存在是为了使用其另外一个功能，这个功能在另外两种引用中同样存在：</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:green;font-weight:700>public</span><span style=color:#bbb> </span><span style=color:#00f>PhantomReference</span>(T<span style=color:#bbb> </span>referent,<span style=color:#bbb> </span>ReferenceQueue<span style=color:#666>&lt;?</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>super</span><span style=color:#bbb> </span>T<span style=color:#666>&gt;</span><span style=color:#bbb> </span>q)<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>super</span>(referent,<span style=color:#bbb> </span>q);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>public</span><span style=color:#bbb> </span><span style=color:#00f>WeakReference</span>(T<span style=color:#bbb> </span>referent,<span style=color:#bbb> </span>ReferenceQueue<span style=color:#666>&lt;?</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>super</span><span style=color:#bbb> </span>T<span style=color:#666>&gt;</span><span style=color:#bbb> </span>q)<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>super</span>(referent,<span style=color:#bbb> </span>q);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span></code></pre></div><p>引用队列是一个链表包装类，其结点就是 <code>Reference</code> 对象。当引用被 GC 释放时，我们可能希望执行一些其他的操作。</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>ReferenceQueue<span style=color:#666>&lt;</span>T<span style=color:#666>&gt;</span><span style=color:#bbb> </span>rq<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>new</span><span style=color:#bbb> </span>ReferenceQueue<span style=color:#666>&lt;</span>T<span style=color:#666>&gt;</span>();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>T<span style=color:#bbb> </span>obj<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>...;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>WeakReference<span style=color:#666>&lt;</span>T<span style=color:#666>&gt;</span><span style=color:#bbb> </span>weakReference<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>new</span><span style=color:#bbb> </span>WeakReference<span style=color:#666>&lt;</span>T<span style=color:#666>&gt;</span>(bytes,<span style=color:#bbb> </span>rq);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>map.<span style=color:#7d9029>put</span>(weakReference,<span style=color:#bbb> </span>value);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>obj<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>null</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#408080;font-style:italic>// full gc</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>while</span>((k<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>(WeakReference)<span style=color:#bbb> </span>rq.<span style=color:#7d9029>remove</span>())<span style=color:#bbb> </span><span style=color:#666>!=</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>null</span>)<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#408080;font-style:italic>// do sth.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span></code></pre></div><p><code>ReferenceQueue</code> 有三个开放的方法。<code>poll()</code> 返回元素或 null，<code>remove()</code> 在队列为空时阻塞，<code>remove(long)</code> 提供超时时间。</p><p>不过，需要注意的是，虚引用并不是非常弱的。</p></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#threadlocal-与-java-中的引用>ThreadLocal 与 Java 中的引用</a><ul><li><a href=#threadlocal-类>ThreadLocal 类</a><ul><li><a href=#构造>构造</a></li><li><a href=#set-方法>set 方法</a></li><li><a href=#get-方法>get 方法</a></li><li><a href=#嵌套类-entry>嵌套类 Entry</a></li></ul></li><li><a href=#java-的四种引用>Java 的四种引用</a><ul><li><a href=#软引用和弱引用>软引用和弱引用</a></li><li><a href=#虚引用和引用队列>虚引用和引用队列</a></li></ul></li></ul></li></ul></nav></div></aside></main></body></html>